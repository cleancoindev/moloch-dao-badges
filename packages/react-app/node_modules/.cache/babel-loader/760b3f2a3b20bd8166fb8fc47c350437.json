{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    if (enumerableOnly) symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    });\n    keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n\n    if (i % 2) {\n      ownKeys(source, true).forEach(function (key) {\n        (0, _defineProperty2[\"default\"])(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(source).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n\n  return target;\n}\n\nvar path = require('path');\n\nvar EventEmitter = require('events');\n\nvar OrbitDB = require('orbit-db');\n\nvar Pubsub = require('orbit-db-pubsub');\n\nvar AccessControllers = require('orbit-db-access-controllers');\n\nvar OdbStorage = require('orbit-db-storage-adapter');\n\nvar OdbCache = require('orbit-db-cache');\n\nvar OdbKeystore = require('orbit-db-keystore');\n\nvar resolveDID = require('did-resolver')[\"default\"];\n\nvar _require = require('3box-orbitdb-plugins'),\n    OdbIdentityProvider = _require.OdbIdentityProvider,\n    LegacyIPFS3BoxAccessController = _require.LegacyIPFS3BoxAccessController,\n    ThreadAccessController = _require.ThreadAccessController,\n    ModeratorAccessController = _require.ModeratorAccessController;\n\nAccessControllers.addAccessController({\n  AccessController: LegacyIPFS3BoxAccessController\n});\nAccessControllers.addAccessController({\n  AccessController: ThreadAccessController\n});\nAccessControllers.addAccessController({\n  AccessController: ModeratorAccessController\n});\n\nvar config = require('./config');\n\nvar Identities = require('orbit-db-identity-provider');\n\nIdentities.addIdentityProvider(OdbIdentityProvider);\nvar PINNING_NODE = config.pinning_node;\nvar PINNING_ROOM = config.pinning_room;\nvar ORBITDB_OPTS = config.orbitdb_options;\n\nvar ODB_STORE_OPTS = _objectSpread({}, ORBITDB_OPTS, {\n  accessController: {\n    type: 'legacy-ipfs-3box',\n    skipManifest: true\n  }\n});\n\nvar entryTypes = {\n  SPACE: 'space',\n  ADDRESS_LINK: 'address-link',\n  AUTH_DATA: 'auth-data'\n};\n\nvar pinDID = function pinDID(did) {\n  if (!did) return; // We resolve the DID in order to pin the ipfs object\n\n  try {\n    resolveDID(did); // if this throws it's not a DID\n  } catch (e) {}\n};\n\nvar Replicator = /*#__PURE__*/function () {\n  function Replicator(ipfs, opts) {\n    var _this = this;\n\n    (0, _classCallCheck2[\"default\"])(this, Replicator);\n    this.events = new EventEmitter();\n    this.ipfs = ipfs;\n    this._pinningNode = opts.pinningNode || PINNING_NODE;\n    this.ipfs.swarm.connect(this._pinningNode, function () {});\n    this._stores = {};\n    this._storePromises = {}; // TODO - this should only be done in 3box-js. For use in\n    // 3box-pinning-node the below code should be disabled\n\n    this._hasPubsubMsgs = {};\n    this.events.on('pinning-room-message', function (topic, data) {\n      if (data.type === 'HAS_ENTRIES' && data.odbAddress) {\n        var odbAddress = data.odbAddress;\n\n        if (_this._pinningRoomFilter) {\n          var hasMsgFor = Object.keys(_this._hasPubsubMsgs);\n\n          if (_this._pinningRoomFilter.length <= hasMsgFor.length) {\n            var haveAllMsgs = _this._pinningRoomFilter.reduce(function (acc, addr) {\n              return acc && hasMsgFor.includes(addr);\n            }, true);\n\n            if (haveAllMsgs) {\n              _this._pubsub.unsubscribe(PINNING_ROOM);\n            }\n          } // Before the pinning room filter is created we will keep all has messages\n          // in memory. After we only care about the ones that are relevant.\n\n\n          if (!_this._pinningRoomFilter.includes(odbAddress)) {\n            return;\n          }\n        }\n\n        _this._hasPubsubMsgs[odbAddress] = data;\n\n        _this.events.emit(\"has-\".concat(odbAddress), data);\n      }\n    });\n  }\n\n  (0, _createClass2[\"default\"])(Replicator, [{\n    key: \"_initPinningRoomFilter\",\n    value: function _initPinningRoomFilter() {\n      this._pinningRoomFilter = this.listStoreAddresses(); // clear out any messages that are not relevant\n\n      for (var odbAddress in this._hasPubsubMsgs) {\n        if (!this._pinningRoomFilter.includes(odbAddress)) {\n          delete this._hasPubsubMsgs[odbAddress];\n        }\n      }\n    }\n  }, {\n    key: \"_init\",\n    value: function () {\n      var _init2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(opts) {\n        var cachePath, levelDown, cacheStorage, cache, keystorePath, keyStorage, keystore, identity;\n        return _regenerator[\"default\"].wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.t0 = Pubsub;\n                _context.t1 = this.ipfs;\n                _context.next = 4;\n                return this.ipfs.id();\n\n              case 4:\n                _context.t2 = _context.sent.id;\n                this._pubsub = new _context.t0(_context.t1, _context.t2); // Passes default cache but with fixed path instead of path based on\n                // orbitdb/ipfs id which can change on page load\n\n                cachePath = path.join(opts.orbitPath || './orbitdb', '/cache');\n                levelDown = OdbStorage(null, {});\n                _context.next = 10;\n                return levelDown.createStore(cachePath);\n\n              case 10:\n                cacheStorage = _context.sent;\n                cache = new OdbCache(cacheStorage);\n                keystorePath = path.join(opts.orbitPath || './orbitdb', '/keystore');\n                _context.next = 15;\n                return levelDown.createStore(keystorePath);\n\n              case 15:\n                keyStorage = _context.sent;\n                keystore = new OdbKeystore(keyStorage); // Identity not used, passes ref to 3ID orbit identity provider\n\n                _context.next = 19;\n                return Identities.createIdentity({\n                  id: 'nullid',\n                  keystore: keystore\n                });\n\n              case 19:\n                identity = _context.sent;\n                _context.next = 22;\n                return OrbitDB.createInstance(this.ipfs, {\n                  directory: opts.orbitPath,\n                  identity: identity,\n                  cache: cache,\n                  keystore: keystore\n                });\n\n              case 22:\n                this._orbitdb = _context.sent;\n\n              case 23:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function _init(_x) {\n        return _init2.apply(this, arguments);\n      }\n\n      return _init;\n    }()\n  }, {\n    key: \"_joinPinningRoom\",\n    value: function () {\n      var _joinPinningRoom2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee2(firstJoin) {\n        var _this2 = this;\n\n        return _regenerator[\"default\"].wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.t0 = !firstJoin;\n\n                if (!_context2.t0) {\n                  _context2.next = 6;\n                  break;\n                }\n\n                _context2.next = 4;\n                return this.ipfs.pubsub.ls();\n\n              case 4:\n                _context2.t1 = PINNING_ROOM;\n                _context2.t0 = _context2.sent.includes(_context2.t1);\n\n              case 6:\n                if (!_context2.t0) {\n                  _context2.next = 8;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\");\n\n              case 8:\n                this._pubsub.subscribe(PINNING_ROOM, function (topic, data) {\n                  // console.log('message', topic, data)\n                  _this2.events.emit('pinning-room-message', topic, data);\n                }, function (topic, peer) {\n                  // console.log('peer', topic, peer)\n                  _this2.events.emit('pinning-room-peer', topic, peer);\n                });\n\n              case 9:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function _joinPinningRoom(_x2) {\n        return _joinPinningRoom2.apply(this, arguments);\n      }\n\n      return _joinPinningRoom;\n    }()\n  }, {\n    key: \"start\",\n    value: function () {\n      var _start = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee4(rootstoreAddress, did) {\n        var _this3 = this;\n\n        var opts,\n            waitForSync,\n            _args4 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                opts = _args4.length > 2 && _args4[2] !== undefined ? _args4[2] : {};\n                this._did = did;\n                _context4.next = 4;\n                return this._joinPinningRoom(true);\n\n              case 4:\n                this._publishDB({\n                  odbAddress: rootstoreAddress\n                });\n\n                _context4.next = 7;\n                return this._orbitdb.feed(rootstoreAddress, ODB_STORE_OPTS);\n\n              case 7:\n                this.rootstore = _context4.sent;\n                _context4.next = 10;\n                return this.rootstore.load();\n\n              case 10:\n                this.rootstoreSyncDone = this.syncDB(this.rootstore);\n\n                waitForSync = /*#__PURE__*/function () {\n                  var _ref = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee3() {\n                    var addressLinkPinPromise, authDataPinPromise;\n                    return _regenerator[\"default\"].wrap(function _callee3$(_context3) {\n                      while (1) {\n                        switch (_context3.prev = _context3.next) {\n                          case 0:\n                            _context3.next = 2;\n                            return _this3.rootstoreSyncDone;\n\n                          case 2:\n                            addressLinkPinPromise = _this3.getAddressLinks();\n                            authDataPinPromise = _this3.getAuthData();\n\n                            _this3._initPinningRoomFilter();\n\n                            _context3.next = 7;\n                            return _this3._loadStores(opts);\n\n                          case 7:\n                            _context3.next = 9;\n                            return Promise.all(Object.keys(_this3._stores).map(function (addr) {\n                              return _this3.syncDB(_this3._stores[addr]);\n                            }));\n\n                          case 9:\n                            _context3.next = 11;\n                            return addressLinkPinPromise;\n\n                          case 11:\n                            _context3.next = 13;\n                            return authDataPinPromise;\n\n                          case 13:\n                          case \"end\":\n                            return _context3.stop();\n                        }\n                      }\n                    }, _callee3);\n                  }));\n\n                  return function waitForSync() {\n                    return _ref.apply(this, arguments);\n                  };\n                }();\n\n                this.syncDone = waitForSync();\n\n              case 13:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function start(_x3, _x4) {\n        return _start.apply(this, arguments);\n      }\n\n      return start;\n    }()\n  }, {\n    key: \"new\",\n    value: function () {\n      var _new2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee5(rootstoreName, pubkey, did) {\n        var opts;\n        return _regenerator[\"default\"].wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                if (!this.rootstore) {\n                  _context5.next = 2;\n                  break;\n                }\n\n                throw new Error('This method can only be called once before the replicator has started');\n\n              case 2:\n                this._did = did;\n                _context5.next = 5;\n                return this._joinPinningRoom(true);\n\n              case 5:\n                opts = _objectSpread({}, ODB_STORE_OPTS, {\n                  format: 'dag-pb'\n                });\n                opts.accessController.write = [pubkey];\n                _context5.next = 9;\n                return this._orbitdb.feed(rootstoreName, opts);\n\n              case 9:\n                this.rootstore = _context5.sent;\n                this._pinningRoomFilter = [];\n\n                this._publishDB({\n                  odbAddress: this.rootstore.address.toString()\n                });\n\n                _context5.next = 14;\n                return this.rootstore.load();\n\n              case 14:\n                this.rootstoreSyncDone = Promise.resolve();\n                this.syncDone = Promise.resolve();\n\n              case 16:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function _new(_x5, _x6, _x7) {\n        return _new2.apply(this, arguments);\n      }\n\n      return _new;\n    }()\n  }, {\n    key: \"stop\",\n    value: function () {\n      var _stop = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee6() {\n        return _regenerator[\"default\"].wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                _context6.next = 2;\n                return this._orbitdb.stop();\n\n              case 2:\n                _context6.next = 4;\n                return this._pubsub.disconnect();\n\n              case 4:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this);\n      }));\n\n      function stop() {\n        return _stop.apply(this, arguments);\n      }\n\n      return stop;\n    }()\n  }, {\n    key: \"addKVStore\",\n    value: function () {\n      var _addKVStore = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee7(name, pubkey, isSpace, did) {\n        var opts, store, storeAddress, entries, entry;\n        return _regenerator[\"default\"].wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                if (this.rootstore) {\n                  _context7.next = 2;\n                  break;\n                }\n\n                throw new Error('This method can only be called once before the replicator has started');\n\n              case 2:\n                opts = _objectSpread({}, ODB_STORE_OPTS, {\n                  format: 'dag-pb'\n                });\n                opts.accessController.write = [pubkey];\n                _context7.next = 6;\n                return this._orbitdb.keyvalue(name, opts);\n\n              case 6:\n                store = _context7.sent;\n                storeAddress = store.address.toString();\n                this._stores[storeAddress] = store; // add entry to rootstore\n\n                _context7.next = 11;\n                return this.rootstoreSyncDone;\n\n              case 11:\n                _context7.next = 13;\n                return this.rootstore.iterator({\n                  limit: -1\n                }).collect();\n\n              case 13:\n                entries = _context7.sent;\n                entry = entries.find(function (entry) {\n                  return entry.payload.value.odbAddress === storeAddress;\n                });\n\n                if (!isSpace) {\n                  _context7.next = 28;\n                  break;\n                }\n\n                if (entry) {\n                  _context7.next = 21;\n                  break;\n                }\n\n                _context7.next = 19;\n                return this.rootstore.add({\n                  type: entryTypes.SPACE,\n                  DID: did,\n                  odbAddress: storeAddress\n                });\n\n              case 19:\n                _context7.next = 26;\n                break;\n\n              case 21:\n                if (entry.payload.value.type) {\n                  _context7.next = 26;\n                  break;\n                }\n\n                _context7.next = 24;\n                return this.rootstore.del(entry.hash);\n\n              case 24:\n                _context7.next = 26;\n                return this.rootstore.add({\n                  type: entryTypes.SPACE,\n                  DID: did,\n                  odbAddress: storeAddress\n                });\n\n              case 26:\n                _context7.next = 31;\n                break;\n\n              case 28:\n                if (entry) {\n                  _context7.next = 31;\n                  break;\n                }\n\n                _context7.next = 31;\n                return this.rootstore.add({\n                  odbAddress: storeAddress\n                });\n\n              case 31:\n                if (!this._hasPubsubMsgs[storeAddress]) {\n                  this._hasPubsubMsgs[storeAddress] = {\n                    numEntries: 0\n                  };\n                }\n\n                return _context7.abrupt(\"return\", store);\n\n              case 33:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this);\n      }));\n\n      function addKVStore(_x8, _x9, _x10, _x11) {\n        return _addKVStore.apply(this, arguments);\n      }\n\n      return addKVStore;\n    }()\n  }, {\n    key: \"_loadStores\",\n    value: function () {\n      var _loadStores2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee8(_ref2) {\n        var _this4 = this;\n\n        var profile, allSpaces, spacesList, storeEntries, loadPromises;\n        return _regenerator[\"default\"].wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                profile = _ref2.profile, allSpaces = _ref2.allSpaces, spacesList = _ref2.spacesList;\n                storeEntries = this._listStoreEntries();\n                loadPromises = storeEntries.map(function (entry) {\n                  var data = entry.payload.value;\n\n                  if (data.type === entryTypes.SPACE && data.DID) {\n                    pinDID(data.DID);\n                  }\n\n                  if (profile && (data.odbAddress.includes('public') || data.odbAddress.includes('private'))) {\n                    return _this4._loadKeyValueStore(data.odbAddress);\n                  } else if (data.odbAddress.includes(entryTypes.SPACE) && (allSpaces || spacesList && spacesList.includes(data.odbAddress.split('.')[2]))) {\n                    return _this4._loadKeyValueStore(data.odbAddress);\n                  }\n                });\n                return _context8.abrupt(\"return\", Promise.all(loadPromises));\n\n              case 4:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8, this);\n      }));\n\n      function _loadStores(_x12) {\n        return _loadStores2.apply(this, arguments);\n      }\n\n      return _loadStores;\n    }()\n  }, {\n    key: \"_loadKeyValueStore\",\n    value: function () {\n      var _loadKeyValueStore2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee9(odbAddress) {\n        var _this5 = this;\n\n        return _regenerator[\"default\"].wrap(function _callee9$(_context9) {\n          while (1) {\n            switch (_context9.prev = _context9.next) {\n              case 0:\n                if (!this._storePromises[odbAddress]) {\n                  this._storePromises[odbAddress] = new Promise(function (resolve, reject) {\n                    _this5._orbitdb.keyvalue(odbAddress, ODB_STORE_OPTS).then(function (store) {\n                      store.load().then(function () {\n                        resolve(store);\n                      });\n                    });\n                  });\n                }\n\n                _context9.next = 3;\n                return this._storePromises[odbAddress];\n\n              case 3:\n                this._stores[odbAddress] = _context9.sent;\n                return _context9.abrupt(\"return\", this._stores[odbAddress]);\n\n              case 5:\n              case \"end\":\n                return _context9.stop();\n            }\n          }\n        }, _callee9, this);\n      }));\n\n      function _loadKeyValueStore(_x13) {\n        return _loadKeyValueStore2.apply(this, arguments);\n      }\n\n      return _loadKeyValueStore;\n    }()\n  }, {\n    key: \"getStore\",\n    value: function () {\n      var _getStore = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee10(odbAddress) {\n        return _regenerator[\"default\"].wrap(function _callee10$(_context10) {\n          while (1) {\n            switch (_context10.prev = _context10.next) {\n              case 0:\n                return _context10.abrupt(\"return\", this._stores[odbAddress] || this._loadKeyValueStore(odbAddress));\n\n              case 1:\n              case \"end\":\n                return _context10.stop();\n            }\n          }\n        }, _callee10, this);\n      }));\n\n      function getStore(_x14) {\n        return _getStore.apply(this, arguments);\n      }\n\n      return getStore;\n    }()\n  }, {\n    key: \"listStoreAddresses\",\n    value: function listStoreAddresses() {\n      return this._listStoreEntries().map(function (entry) {\n        return entry.payload.value.odbAddress;\n      });\n    }\n  }, {\n    key: \"_listStoreEntries\",\n    value: function _listStoreEntries() {\n      var entries = this.rootstore.iterator({\n        limit: -1\n      }).collect().filter(function (e) {\n        return OrbitDB.isValidAddress(e.payload.value.odbAddress || '');\n      });\n      var uniqueEntries = entries.filter(function (e1, i, a) {\n        return a.findIndex(function (e2) {\n          return e2.payload.value.odbAddress === e1.payload.value.odbAddress;\n        }) === i;\n      });\n      return uniqueEntries;\n    }\n  }, {\n    key: \"getAddressLinks\",\n    value: function () {\n      var _getAddressLinks = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee12() {\n        var _this6 = this;\n\n        var entries, linkEntries, resolveLinks;\n        return _regenerator[\"default\"].wrap(function _callee12$(_context12) {\n          while (1) {\n            switch (_context12.prev = _context12.next) {\n              case 0:\n                _context12.next = 2;\n                return this.rootstore.iterator({\n                  limit: -1\n                }).collect();\n\n              case 2:\n                entries = _context12.sent;\n                linkEntries = entries.filter(function (e) {\n                  return e.payload.value.type === entryTypes.ADDRESS_LINK;\n                });\n                resolveLinks = linkEntries.map( /*#__PURE__*/function () {\n                  var _ref3 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee11(entry) {\n                    var cid, obj;\n                    return _regenerator[\"default\"].wrap(function _callee11$(_context11) {\n                      while (1) {\n                        switch (_context11.prev = _context11.next) {\n                          case 0:\n                            cid = entry.payload.value.data; // TODO handle missing ipfs obj??, timeouts?\n\n                            _context11.next = 3;\n                            return _this6.ipfs.dag.get(cid);\n\n                          case 3:\n                            obj = _context11.sent.value;\n\n                            _this6.ipfs.pin.add(cid);\n\n                            obj.entry = entry;\n                            return _context11.abrupt(\"return\", obj);\n\n                          case 7:\n                          case \"end\":\n                            return _context11.stop();\n                        }\n                      }\n                    }, _callee11);\n                  }));\n\n                  return function (_x15) {\n                    return _ref3.apply(this, arguments);\n                  };\n                }());\n                return _context12.abrupt(\"return\", Promise.all(resolveLinks));\n\n              case 6:\n              case \"end\":\n                return _context12.stop();\n            }\n          }\n        }, _callee12, this);\n      }));\n\n      function getAddressLinks() {\n        return _getAddressLinks.apply(this, arguments);\n      }\n\n      return getAddressLinks;\n    }()\n  }, {\n    key: \"getAuthData\",\n    value: function () {\n      var _getAuthData = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee14() {\n        var _this7 = this;\n\n        var entries, authEntries, resolveLinks;\n        return _regenerator[\"default\"].wrap(function _callee14$(_context14) {\n          while (1) {\n            switch (_context14.prev = _context14.next) {\n              case 0:\n                _context14.next = 2;\n                return this.rootstore.iterator({\n                  limit: -1\n                }).collect();\n\n              case 2:\n                entries = _context14.sent;\n                authEntries = entries.filter(function (e) {\n                  return e.payload.value.type === entryTypes.AUTH_DATA;\n                });\n                resolveLinks = authEntries.map( /*#__PURE__*/function () {\n                  var _ref4 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee13(entry) {\n                    var cid, obj;\n                    return _regenerator[\"default\"].wrap(function _callee13$(_context13) {\n                      while (1) {\n                        switch (_context13.prev = _context13.next) {\n                          case 0:\n                            cid = entry.payload.value.data; // TODO handle missing ipfs obj??, timeouts?\n\n                            _context13.next = 3;\n                            return _this7.ipfs.dag.get(cid);\n\n                          case 3:\n                            obj = _context13.sent.value;\n\n                            _this7.ipfs.pin.add(cid);\n\n                            obj.entry = entry;\n                            return _context13.abrupt(\"return\", obj);\n\n                          case 7:\n                          case \"end\":\n                            return _context13.stop();\n                        }\n                      }\n                    }, _callee13);\n                  }));\n\n                  return function (_x16) {\n                    return _ref4.apply(this, arguments);\n                  };\n                }());\n                return _context14.abrupt(\"return\", Promise.all(resolveLinks));\n\n              case 6:\n              case \"end\":\n                return _context14.stop();\n            }\n          }\n        }, _callee14, this);\n      }));\n\n      function getAuthData() {\n        return _getAuthData.apply(this, arguments);\n      }\n\n      return getAuthData;\n    }()\n  }, {\n    key: \"ensureConnected\",\n    value: function () {\n      var _ensureConnected = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee15(odbAddress) {\n        var _this8 = this;\n\n        var isThread, roomPeers;\n        return _regenerator[\"default\"].wrap(function _callee15$(_context15) {\n          while (1) {\n            switch (_context15.prev = _context15.next) {\n              case 0:\n                isThread = odbAddress.includes('thread');\n                _context15.next = 3;\n                return this.ipfs.pubsub.peers(odbAddress);\n\n              case 3:\n                roomPeers = _context15.sent;\n\n                if (!roomPeers.find(function (p) {\n                  return p === _this8._pinningNodePeerId;\n                })) {\n                  this.ipfs.swarm.connect(this._pinningNode, function () {});\n                  odbAddress = isThread ? odbAddress : this.rootstore.address.toString();\n\n                  this._publishDB({\n                    odbAddress: odbAddress,\n                    isThread: isThread\n                  }, true);\n                }\n\n              case 5:\n              case \"end\":\n                return _context15.stop();\n            }\n          }\n        }, _callee15, this);\n      }));\n\n      function ensureConnected(_x17) {\n        return _ensureConnected.apply(this, arguments);\n      }\n\n      return ensureConnected;\n    }()\n  }, {\n    key: \"_publishDB\",\n    value: function () {\n      var _publishDB2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee16(_ref5, unsubscribe) {\n        var _this9 = this;\n\n        var odbAddress, isThread, pinningNodeJoined;\n        return _regenerator[\"default\"].wrap(function _callee16$(_context16) {\n          while (1) {\n            switch (_context16.prev = _context16.next) {\n              case 0:\n                odbAddress = _ref5.odbAddress, isThread = _ref5.isThread;\n\n                this._joinPinningRoom();\n\n                odbAddress = odbAddress || this.rootstore.address.toString(); // make sure that the pinning node is in the pubsub room before publishing\n\n                pinningNodeJoined = new Promise(function (resolve, reject) {\n                  _this9.events.on('pinning-room-peer', function (topic, peer) {\n                    if (peer === _this9._pinningNodePeerId) {\n                      resolve();\n                    }\n                  });\n                });\n                _context16.next = 6;\n                return this.ipfs.pubsub.peers(PINNING_ROOM);\n\n              case 6:\n                _context16.t0 = this._pinningNodePeerId;\n\n                if (_context16.sent.includes(_context16.t0)) {\n                  _context16.next = 10;\n                  break;\n                }\n\n                _context16.next = 10;\n                return pinningNodeJoined;\n\n              case 10:\n                this._pubsub.publish(PINNING_ROOM, {\n                  type: isThread ? 'SYNC_DB' : 'PIN_DB',\n                  odbAddress: odbAddress,\n                  did: this._did,\n                  thread: isThread\n                });\n\n                this.events.removeAllListeners('pinning-room-peer');\n\n                if (unsubscribe) {\n                  this._pubsub.unsubscribe(PINNING_ROOM);\n                }\n\n              case 13:\n              case \"end\":\n                return _context16.stop();\n            }\n          }\n        }, _callee16, this);\n      }));\n\n      function _publishDB(_x18, _x19) {\n        return _publishDB2.apply(this, arguments);\n      }\n\n      return _publishDB;\n    }()\n  }, {\n    key: \"_getNumEntries\",\n    value: function () {\n      var _getNumEntries2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee17(odbAddress) {\n        var _this10 = this;\n\n        return _regenerator[\"default\"].wrap(function _callee17$(_context17) {\n          while (1) {\n            switch (_context17.prev = _context17.next) {\n              case 0:\n                return _context17.abrupt(\"return\", new Promise(function (resolve, reject) {\n                  var eventName = \"has-\".concat(odbAddress);\n\n                  _this10.events.on(eventName, function (data) {\n                    _this10.events.removeAllListeners(eventName);\n\n                    resolve(data.numEntries);\n                  });\n\n                  if (_this10._hasPubsubMsgs[odbAddress]) {\n                    _this10.events.removeAllListeners(eventName);\n\n                    resolve(_this10._hasPubsubMsgs[odbAddress].numEntries);\n                  }\n                }));\n\n              case 1:\n              case \"end\":\n                return _context17.stop();\n            }\n          }\n        }, _callee17);\n      }));\n\n      function _getNumEntries(_x20) {\n        return _getNumEntries2.apply(this, arguments);\n      }\n\n      return _getNumEntries;\n    }()\n  }, {\n    key: \"syncDB\",\n    value: function () {\n      var _syncDB = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee18(dbInstance) {\n        var numRemoteEntries, isNumber;\n        return _regenerator[\"default\"].wrap(function _callee18$(_context18) {\n          while (1) {\n            switch (_context18.prev = _context18.next) {\n              case 0:\n                _context18.next = 2;\n                return this._getNumEntries(dbInstance.address.toString());\n\n              case 2:\n                numRemoteEntries = _context18.sent;\n                isNumber = typeof numRemoteEntries === 'number';\n\n                if (!(isNumber && numRemoteEntries <= dbInstance._oplog.values.length)) {\n                  _context18.next = 6;\n                  break;\n                }\n\n                return _context18.abrupt(\"return\", Promise.resolve());\n\n              case 6:\n                _context18.next = 8;\n                return new Promise(function (resolve, reject) {\n                  dbInstance.events.on('replicated', function () {\n                    if (numRemoteEntries <= dbInstance._oplog.values.length) {\n                      resolve();\n                      dbInstance.events.removeAllListeners('replicated');\n                    }\n                  });\n                });\n\n              case 8:\n              case \"end\":\n                return _context18.stop();\n            }\n          }\n        }, _callee18, this);\n      }));\n\n      function syncDB(_x21) {\n        return _syncDB.apply(this, arguments);\n      }\n\n      return syncDB;\n    }()\n  }, {\n    key: \"_pinningNodePeerId\",\n    get: function get() {\n      return this._pinningNode.split('/').pop();\n    }\n  }], [{\n    key: \"create\",\n    value: function () {\n      var _create = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee19(ipfs) {\n        var opts,\n            replicator,\n            _args19 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee19$(_context19) {\n          while (1) {\n            switch (_context19.prev = _context19.next) {\n              case 0:\n                opts = _args19.length > 1 && _args19[1] !== undefined ? _args19[1] : {};\n                replicator = new Replicator(ipfs, opts);\n                _context19.next = 4;\n                return replicator._init(opts);\n\n              case 4:\n                return _context19.abrupt(\"return\", replicator);\n\n              case 5:\n              case \"end\":\n                return _context19.stop();\n            }\n          }\n        }, _callee19);\n      }));\n\n      function create(_x22) {\n        return _create.apply(this, arguments);\n      }\n\n      return create;\n    }()\n  }, {\n    key: \"entryTypes\",\n    get: function get() {\n      return entryTypes;\n    }\n  }]);\n  return Replicator;\n}();\n\nmodule.exports = Replicator;","map":{"version":3,"sources":["/home/samkuhlmann/Documents/ody/moloch/moloch-dao-badges/node_modules/3box/lib/replicator.js"],"names":["_interopRequireDefault","require","_regenerator","_asyncToGenerator2","_classCallCheck2","_createClass2","_defineProperty2","ownKeys","object","enumerableOnly","keys","Object","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","getOwnPropertyDescriptors","defineProperties","defineProperty","path","EventEmitter","OrbitDB","Pubsub","AccessControllers","OdbStorage","OdbCache","OdbKeystore","resolveDID","_require","OdbIdentityProvider","LegacyIPFS3BoxAccessController","ThreadAccessController","ModeratorAccessController","addAccessController","AccessController","config","Identities","addIdentityProvider","PINNING_NODE","pinning_node","PINNING_ROOM","pinning_room","ORBITDB_OPTS","orbitdb_options","ODB_STORE_OPTS","accessController","type","skipManifest","entryTypes","SPACE","ADDRESS_LINK","AUTH_DATA","pinDID","did","e","Replicator","ipfs","opts","_this","events","_pinningNode","pinningNode","swarm","connect","_stores","_storePromises","_hasPubsubMsgs","on","topic","data","odbAddress","_pinningRoomFilter","hasMsgFor","haveAllMsgs","reduce","acc","addr","includes","_pubsub","unsubscribe","emit","concat","value","_initPinningRoomFilter","listStoreAddresses","_init2","mark","_callee","cachePath","levelDown","cacheStorage","cache","keystorePath","keyStorage","keystore","identity","wrap","_callee$","_context","prev","next","t0","t1","id","t2","sent","join","orbitPath","createStore","createIdentity","createInstance","directory","_orbitdb","stop","_init","_x","_joinPinningRoom2","_callee2","firstJoin","_this2","_callee2$","_context2","pubsub","ls","abrupt","subscribe","peer","_joinPinningRoom","_x2","_start","_callee4","rootstoreAddress","_this3","waitForSync","_args4","_callee4$","_context4","undefined","_did","_publishDB","feed","rootstore","load","rootstoreSyncDone","syncDB","_ref","_callee3","addressLinkPinPromise","authDataPinPromise","_callee3$","_context3","getAddressLinks","getAuthData","_loadStores","Promise","all","map","syncDone","start","_x3","_x4","_new2","_callee5","rootstoreName","pubkey","_callee5$","_context5","Error","format","write","address","toString","resolve","_new","_x5","_x6","_x7","_stop","_callee6","_callee6$","_context6","disconnect","_addKVStore","_callee7","name","isSpace","store","storeAddress","entries","entry","_callee7$","_context7","keyvalue","iterator","limit","collect","find","payload","add","DID","del","hash","numEntries","addKVStore","_x8","_x9","_x10","_x11","_loadStores2","_callee8","_ref2","_this4","profile","allSpaces","spacesList","storeEntries","loadPromises","_callee8$","_context8","_listStoreEntries","_loadKeyValueStore","split","_x12","_loadKeyValueStore2","_callee9","_this5","_callee9$","_context9","reject","then","_x13","_getStore","_callee10","_callee10$","_context10","getStore","_x14","isValidAddress","uniqueEntries","e1","a","findIndex","e2","_getAddressLinks","_callee12","_this6","linkEntries","resolveLinks","_callee12$","_context12","_ref3","_callee11","cid","obj","_callee11$","_context11","dag","get","pin","_x15","_getAuthData","_callee14","_this7","authEntries","_callee14$","_context14","_ref4","_callee13","_callee13$","_context13","_x16","_ensureConnected","_callee15","_this8","isThread","roomPeers","_callee15$","_context15","peers","p","_pinningNodePeerId","ensureConnected","_x17","_publishDB2","_callee16","_ref5","_this9","pinningNodeJoined","_callee16$","_context16","publish","thread","removeAllListeners","_x18","_x19","_getNumEntries2","_callee17","_this10","_callee17$","_context17","eventName","_getNumEntries","_x20","_syncDB","_callee18","dbInstance","numRemoteEntries","isNumber","_callee18$","_context18","_oplog","values","_x21","pop","_create","_callee19","replicator","_args19","_callee19$","_context19","create","_x22","module","exports"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2[\"default\"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nvar path = require('path');\n\nvar EventEmitter = require('events');\n\nvar OrbitDB = require('orbit-db');\n\nvar Pubsub = require('orbit-db-pubsub');\n\nvar AccessControllers = require('orbit-db-access-controllers');\n\nvar OdbStorage = require('orbit-db-storage-adapter');\n\nvar OdbCache = require('orbit-db-cache');\n\nvar OdbKeystore = require('orbit-db-keystore');\n\nvar resolveDID = require('did-resolver')[\"default\"];\n\nvar _require = require('3box-orbitdb-plugins'),\n    OdbIdentityProvider = _require.OdbIdentityProvider,\n    LegacyIPFS3BoxAccessController = _require.LegacyIPFS3BoxAccessController,\n    ThreadAccessController = _require.ThreadAccessController,\n    ModeratorAccessController = _require.ModeratorAccessController;\n\nAccessControllers.addAccessController({\n  AccessController: LegacyIPFS3BoxAccessController\n});\nAccessControllers.addAccessController({\n  AccessController: ThreadAccessController\n});\nAccessControllers.addAccessController({\n  AccessController: ModeratorAccessController\n});\n\nvar config = require('./config');\n\nvar Identities = require('orbit-db-identity-provider');\n\nIdentities.addIdentityProvider(OdbIdentityProvider);\nvar PINNING_NODE = config.pinning_node;\nvar PINNING_ROOM = config.pinning_room;\nvar ORBITDB_OPTS = config.orbitdb_options;\n\nvar ODB_STORE_OPTS = _objectSpread({}, ORBITDB_OPTS, {\n  accessController: {\n    type: 'legacy-ipfs-3box',\n    skipManifest: true\n  }\n});\n\nvar entryTypes = {\n  SPACE: 'space',\n  ADDRESS_LINK: 'address-link',\n  AUTH_DATA: 'auth-data'\n};\n\nvar pinDID = function pinDID(did) {\n  if (!did) return; // We resolve the DID in order to pin the ipfs object\n\n  try {\n    resolveDID(did); // if this throws it's not a DID\n  } catch (e) {}\n};\n\nvar Replicator =\n/*#__PURE__*/\nfunction () {\n  function Replicator(ipfs, opts) {\n    var _this = this;\n\n    (0, _classCallCheck2[\"default\"])(this, Replicator);\n    this.events = new EventEmitter();\n    this.ipfs = ipfs;\n    this._pinningNode = opts.pinningNode || PINNING_NODE;\n    this.ipfs.swarm.connect(this._pinningNode, function () {});\n    this._stores = {};\n    this._storePromises = {}; // TODO - this should only be done in 3box-js. For use in\n    // 3box-pinning-node the below code should be disabled\n\n    this._hasPubsubMsgs = {};\n    this.events.on('pinning-room-message', function (topic, data) {\n      if (data.type === 'HAS_ENTRIES' && data.odbAddress) {\n        var odbAddress = data.odbAddress;\n\n        if (_this._pinningRoomFilter) {\n          var hasMsgFor = Object.keys(_this._hasPubsubMsgs);\n\n          if (_this._pinningRoomFilter.length <= hasMsgFor.length) {\n            var haveAllMsgs = _this._pinningRoomFilter.reduce(function (acc, addr) {\n              return acc && hasMsgFor.includes(addr);\n            }, true);\n\n            if (haveAllMsgs) {\n              _this._pubsub.unsubscribe(PINNING_ROOM);\n            }\n          } // Before the pinning room filter is created we will keep all has messages\n          // in memory. After we only care about the ones that are relevant.\n\n\n          if (!_this._pinningRoomFilter.includes(odbAddress)) {\n            return;\n          }\n        }\n\n        _this._hasPubsubMsgs[odbAddress] = data;\n\n        _this.events.emit(\"has-\".concat(odbAddress), data);\n      }\n    });\n  }\n\n  (0, _createClass2[\"default\"])(Replicator, [{\n    key: \"_initPinningRoomFilter\",\n    value: function _initPinningRoomFilter() {\n      this._pinningRoomFilter = this.listStoreAddresses(); // clear out any messages that are not relevant\n\n      for (var odbAddress in this._hasPubsubMsgs) {\n        if (!this._pinningRoomFilter.includes(odbAddress)) {\n          delete this._hasPubsubMsgs[odbAddress];\n        }\n      }\n    }\n  }, {\n    key: \"_init\",\n    value: function () {\n      var _init2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee(opts) {\n        var cachePath, levelDown, cacheStorage, cache, keystorePath, keyStorage, keystore, identity;\n        return _regenerator[\"default\"].wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.t0 = Pubsub;\n                _context.t1 = this.ipfs;\n                _context.next = 4;\n                return this.ipfs.id();\n\n              case 4:\n                _context.t2 = _context.sent.id;\n                this._pubsub = new _context.t0(_context.t1, _context.t2);\n                // Passes default cache but with fixed path instead of path based on\n                // orbitdb/ipfs id which can change on page load\n                cachePath = path.join(opts.orbitPath || './orbitdb', '/cache');\n                levelDown = OdbStorage(null, {});\n                _context.next = 10;\n                return levelDown.createStore(cachePath);\n\n              case 10:\n                cacheStorage = _context.sent;\n                cache = new OdbCache(cacheStorage);\n                keystorePath = path.join(opts.orbitPath || './orbitdb', '/keystore');\n                _context.next = 15;\n                return levelDown.createStore(keystorePath);\n\n              case 15:\n                keyStorage = _context.sent;\n                keystore = new OdbKeystore(keyStorage); // Identity not used, passes ref to 3ID orbit identity provider\n\n                _context.next = 19;\n                return Identities.createIdentity({\n                  id: 'nullid',\n                  keystore: keystore\n                });\n\n              case 19:\n                identity = _context.sent;\n                _context.next = 22;\n                return OrbitDB.createInstance(this.ipfs, {\n                  directory: opts.orbitPath,\n                  identity: identity,\n                  cache: cache,\n                  keystore: keystore\n                });\n\n              case 22:\n                this._orbitdb = _context.sent;\n\n              case 23:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function _init(_x) {\n        return _init2.apply(this, arguments);\n      }\n\n      return _init;\n    }()\n  }, {\n    key: \"_joinPinningRoom\",\n    value: function () {\n      var _joinPinningRoom2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee2(firstJoin) {\n        var _this2 = this;\n\n        return _regenerator[\"default\"].wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.t0 = !firstJoin;\n\n                if (!_context2.t0) {\n                  _context2.next = 6;\n                  break;\n                }\n\n                _context2.next = 4;\n                return this.ipfs.pubsub.ls();\n\n              case 4:\n                _context2.t1 = PINNING_ROOM;\n                _context2.t0 = _context2.sent.includes(_context2.t1);\n\n              case 6:\n                if (!_context2.t0) {\n                  _context2.next = 8;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\");\n\n              case 8:\n                this._pubsub.subscribe(PINNING_ROOM, function (topic, data) {\n                  // console.log('message', topic, data)\n                  _this2.events.emit('pinning-room-message', topic, data);\n                }, function (topic, peer) {\n                  // console.log('peer', topic, peer)\n                  _this2.events.emit('pinning-room-peer', topic, peer);\n                });\n\n              case 9:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function _joinPinningRoom(_x2) {\n        return _joinPinningRoom2.apply(this, arguments);\n      }\n\n      return _joinPinningRoom;\n    }()\n  }, {\n    key: \"start\",\n    value: function () {\n      var _start = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee4(rootstoreAddress, did) {\n        var _this3 = this;\n\n        var opts,\n            waitForSync,\n            _args4 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                opts = _args4.length > 2 && _args4[2] !== undefined ? _args4[2] : {};\n                this._did = did;\n                _context4.next = 4;\n                return this._joinPinningRoom(true);\n\n              case 4:\n                this._publishDB({\n                  odbAddress: rootstoreAddress\n                });\n\n                _context4.next = 7;\n                return this._orbitdb.feed(rootstoreAddress, ODB_STORE_OPTS);\n\n              case 7:\n                this.rootstore = _context4.sent;\n                _context4.next = 10;\n                return this.rootstore.load();\n\n              case 10:\n                this.rootstoreSyncDone = this.syncDB(this.rootstore);\n\n                waitForSync =\n                /*#__PURE__*/\n                function () {\n                  var _ref = (0, _asyncToGenerator2[\"default\"])(\n                  /*#__PURE__*/\n                  _regenerator[\"default\"].mark(function _callee3() {\n                    var addressLinkPinPromise, authDataPinPromise;\n                    return _regenerator[\"default\"].wrap(function _callee3$(_context3) {\n                      while (1) {\n                        switch (_context3.prev = _context3.next) {\n                          case 0:\n                            _context3.next = 2;\n                            return _this3.rootstoreSyncDone;\n\n                          case 2:\n                            addressLinkPinPromise = _this3.getAddressLinks();\n                            authDataPinPromise = _this3.getAuthData();\n\n                            _this3._initPinningRoomFilter();\n\n                            _context3.next = 7;\n                            return _this3._loadStores(opts);\n\n                          case 7:\n                            _context3.next = 9;\n                            return Promise.all(Object.keys(_this3._stores).map(function (addr) {\n                              return _this3.syncDB(_this3._stores[addr]);\n                            }));\n\n                          case 9:\n                            _context3.next = 11;\n                            return addressLinkPinPromise;\n\n                          case 11:\n                            _context3.next = 13;\n                            return authDataPinPromise;\n\n                          case 13:\n                          case \"end\":\n                            return _context3.stop();\n                        }\n                      }\n                    }, _callee3);\n                  }));\n\n                  return function waitForSync() {\n                    return _ref.apply(this, arguments);\n                  };\n                }();\n\n                this.syncDone = waitForSync();\n\n              case 13:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function start(_x3, _x4) {\n        return _start.apply(this, arguments);\n      }\n\n      return start;\n    }()\n  }, {\n    key: \"new\",\n    value: function () {\n      var _new2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee5(rootstoreName, pubkey, did) {\n        var opts;\n        return _regenerator[\"default\"].wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                if (!this.rootstore) {\n                  _context5.next = 2;\n                  break;\n                }\n\n                throw new Error('This method can only be called once before the replicator has started');\n\n              case 2:\n                this._did = did;\n                _context5.next = 5;\n                return this._joinPinningRoom(true);\n\n              case 5:\n                opts = _objectSpread({}, ODB_STORE_OPTS, {\n                  format: 'dag-pb'\n                });\n                opts.accessController.write = [pubkey];\n                _context5.next = 9;\n                return this._orbitdb.feed(rootstoreName, opts);\n\n              case 9:\n                this.rootstore = _context5.sent;\n                this._pinningRoomFilter = [];\n\n                this._publishDB({\n                  odbAddress: this.rootstore.address.toString()\n                });\n\n                _context5.next = 14;\n                return this.rootstore.load();\n\n              case 14:\n                this.rootstoreSyncDone = Promise.resolve();\n                this.syncDone = Promise.resolve();\n\n              case 16:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function _new(_x5, _x6, _x7) {\n        return _new2.apply(this, arguments);\n      }\n\n      return _new;\n    }()\n  }, {\n    key: \"stop\",\n    value: function () {\n      var _stop = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee6() {\n        return _regenerator[\"default\"].wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                _context6.next = 2;\n                return this._orbitdb.stop();\n\n              case 2:\n                _context6.next = 4;\n                return this._pubsub.disconnect();\n\n              case 4:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this);\n      }));\n\n      function stop() {\n        return _stop.apply(this, arguments);\n      }\n\n      return stop;\n    }()\n  }, {\n    key: \"addKVStore\",\n    value: function () {\n      var _addKVStore = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee7(name, pubkey, isSpace, did) {\n        var opts, store, storeAddress, entries, entry;\n        return _regenerator[\"default\"].wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                if (this.rootstore) {\n                  _context7.next = 2;\n                  break;\n                }\n\n                throw new Error('This method can only be called once before the replicator has started');\n\n              case 2:\n                opts = _objectSpread({}, ODB_STORE_OPTS, {\n                  format: 'dag-pb'\n                });\n                opts.accessController.write = [pubkey];\n                _context7.next = 6;\n                return this._orbitdb.keyvalue(name, opts);\n\n              case 6:\n                store = _context7.sent;\n                storeAddress = store.address.toString();\n                this._stores[storeAddress] = store; // add entry to rootstore\n\n                _context7.next = 11;\n                return this.rootstoreSyncDone;\n\n              case 11:\n                _context7.next = 13;\n                return this.rootstore.iterator({\n                  limit: -1\n                }).collect();\n\n              case 13:\n                entries = _context7.sent;\n                entry = entries.find(function (entry) {\n                  return entry.payload.value.odbAddress === storeAddress;\n                });\n\n                if (!isSpace) {\n                  _context7.next = 28;\n                  break;\n                }\n\n                if (entry) {\n                  _context7.next = 21;\n                  break;\n                }\n\n                _context7.next = 19;\n                return this.rootstore.add({\n                  type: entryTypes.SPACE,\n                  DID: did,\n                  odbAddress: storeAddress\n                });\n\n              case 19:\n                _context7.next = 26;\n                break;\n\n              case 21:\n                if (entry.payload.value.type) {\n                  _context7.next = 26;\n                  break;\n                }\n\n                _context7.next = 24;\n                return this.rootstore.del(entry.hash);\n\n              case 24:\n                _context7.next = 26;\n                return this.rootstore.add({\n                  type: entryTypes.SPACE,\n                  DID: did,\n                  odbAddress: storeAddress\n                });\n\n              case 26:\n                _context7.next = 31;\n                break;\n\n              case 28:\n                if (entry) {\n                  _context7.next = 31;\n                  break;\n                }\n\n                _context7.next = 31;\n                return this.rootstore.add({\n                  odbAddress: storeAddress\n                });\n\n              case 31:\n                if (!this._hasPubsubMsgs[storeAddress]) {\n                  this._hasPubsubMsgs[storeAddress] = {\n                    numEntries: 0\n                  };\n                }\n\n                return _context7.abrupt(\"return\", store);\n\n              case 33:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this);\n      }));\n\n      function addKVStore(_x8, _x9, _x10, _x11) {\n        return _addKVStore.apply(this, arguments);\n      }\n\n      return addKVStore;\n    }()\n  }, {\n    key: \"_loadStores\",\n    value: function () {\n      var _loadStores2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee8(_ref2) {\n        var _this4 = this;\n\n        var profile, allSpaces, spacesList, storeEntries, loadPromises;\n        return _regenerator[\"default\"].wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                profile = _ref2.profile, allSpaces = _ref2.allSpaces, spacesList = _ref2.spacesList;\n                storeEntries = this._listStoreEntries();\n                loadPromises = storeEntries.map(function (entry) {\n                  var data = entry.payload.value;\n\n                  if (data.type === entryTypes.SPACE && data.DID) {\n                    pinDID(data.DID);\n                  }\n\n                  if (profile && (data.odbAddress.includes('public') || data.odbAddress.includes('private'))) {\n                    return _this4._loadKeyValueStore(data.odbAddress);\n                  } else if (data.odbAddress.includes(entryTypes.SPACE) && (allSpaces || spacesList && spacesList.includes(data.odbAddress.split('.')[2]))) {\n                    return _this4._loadKeyValueStore(data.odbAddress);\n                  }\n                });\n                return _context8.abrupt(\"return\", Promise.all(loadPromises));\n\n              case 4:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8, this);\n      }));\n\n      function _loadStores(_x12) {\n        return _loadStores2.apply(this, arguments);\n      }\n\n      return _loadStores;\n    }()\n  }, {\n    key: \"_loadKeyValueStore\",\n    value: function () {\n      var _loadKeyValueStore2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee9(odbAddress) {\n        var _this5 = this;\n\n        return _regenerator[\"default\"].wrap(function _callee9$(_context9) {\n          while (1) {\n            switch (_context9.prev = _context9.next) {\n              case 0:\n                if (!this._storePromises[odbAddress]) {\n                  this._storePromises[odbAddress] = new Promise(function (resolve, reject) {\n                    _this5._orbitdb.keyvalue(odbAddress, ODB_STORE_OPTS).then(function (store) {\n                      store.load().then(function () {\n                        resolve(store);\n                      });\n                    });\n                  });\n                }\n\n                _context9.next = 3;\n                return this._storePromises[odbAddress];\n\n              case 3:\n                this._stores[odbAddress] = _context9.sent;\n                return _context9.abrupt(\"return\", this._stores[odbAddress]);\n\n              case 5:\n              case \"end\":\n                return _context9.stop();\n            }\n          }\n        }, _callee9, this);\n      }));\n\n      function _loadKeyValueStore(_x13) {\n        return _loadKeyValueStore2.apply(this, arguments);\n      }\n\n      return _loadKeyValueStore;\n    }()\n  }, {\n    key: \"getStore\",\n    value: function () {\n      var _getStore = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee10(odbAddress) {\n        return _regenerator[\"default\"].wrap(function _callee10$(_context10) {\n          while (1) {\n            switch (_context10.prev = _context10.next) {\n              case 0:\n                return _context10.abrupt(\"return\", this._stores[odbAddress] || this._loadKeyValueStore(odbAddress));\n\n              case 1:\n              case \"end\":\n                return _context10.stop();\n            }\n          }\n        }, _callee10, this);\n      }));\n\n      function getStore(_x14) {\n        return _getStore.apply(this, arguments);\n      }\n\n      return getStore;\n    }()\n  }, {\n    key: \"listStoreAddresses\",\n    value: function listStoreAddresses() {\n      return this._listStoreEntries().map(function (entry) {\n        return entry.payload.value.odbAddress;\n      });\n    }\n  }, {\n    key: \"_listStoreEntries\",\n    value: function _listStoreEntries() {\n      var entries = this.rootstore.iterator({\n        limit: -1\n      }).collect().filter(function (e) {\n        return OrbitDB.isValidAddress(e.payload.value.odbAddress || '');\n      });\n      var uniqueEntries = entries.filter(function (e1, i, a) {\n        return a.findIndex(function (e2) {\n          return e2.payload.value.odbAddress === e1.payload.value.odbAddress;\n        }) === i;\n      });\n      return uniqueEntries;\n    }\n  }, {\n    key: \"getAddressLinks\",\n    value: function () {\n      var _getAddressLinks = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee12() {\n        var _this6 = this;\n\n        var entries, linkEntries, resolveLinks;\n        return _regenerator[\"default\"].wrap(function _callee12$(_context12) {\n          while (1) {\n            switch (_context12.prev = _context12.next) {\n              case 0:\n                _context12.next = 2;\n                return this.rootstore.iterator({\n                  limit: -1\n                }).collect();\n\n              case 2:\n                entries = _context12.sent;\n                linkEntries = entries.filter(function (e) {\n                  return e.payload.value.type === entryTypes.ADDRESS_LINK;\n                });\n                resolveLinks = linkEntries.map(\n                /*#__PURE__*/\n                function () {\n                  var _ref3 = (0, _asyncToGenerator2[\"default\"])(\n                  /*#__PURE__*/\n                  _regenerator[\"default\"].mark(function _callee11(entry) {\n                    var cid, obj;\n                    return _regenerator[\"default\"].wrap(function _callee11$(_context11) {\n                      while (1) {\n                        switch (_context11.prev = _context11.next) {\n                          case 0:\n                            cid = entry.payload.value.data; // TODO handle missing ipfs obj??, timeouts?\n\n                            _context11.next = 3;\n                            return _this6.ipfs.dag.get(cid);\n\n                          case 3:\n                            obj = _context11.sent.value;\n\n                            _this6.ipfs.pin.add(cid);\n\n                            obj.entry = entry;\n                            return _context11.abrupt(\"return\", obj);\n\n                          case 7:\n                          case \"end\":\n                            return _context11.stop();\n                        }\n                      }\n                    }, _callee11);\n                  }));\n\n                  return function (_x15) {\n                    return _ref3.apply(this, arguments);\n                  };\n                }());\n                return _context12.abrupt(\"return\", Promise.all(resolveLinks));\n\n              case 6:\n              case \"end\":\n                return _context12.stop();\n            }\n          }\n        }, _callee12, this);\n      }));\n\n      function getAddressLinks() {\n        return _getAddressLinks.apply(this, arguments);\n      }\n\n      return getAddressLinks;\n    }()\n  }, {\n    key: \"getAuthData\",\n    value: function () {\n      var _getAuthData = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee14() {\n        var _this7 = this;\n\n        var entries, authEntries, resolveLinks;\n        return _regenerator[\"default\"].wrap(function _callee14$(_context14) {\n          while (1) {\n            switch (_context14.prev = _context14.next) {\n              case 0:\n                _context14.next = 2;\n                return this.rootstore.iterator({\n                  limit: -1\n                }).collect();\n\n              case 2:\n                entries = _context14.sent;\n                authEntries = entries.filter(function (e) {\n                  return e.payload.value.type === entryTypes.AUTH_DATA;\n                });\n                resolveLinks = authEntries.map(\n                /*#__PURE__*/\n                function () {\n                  var _ref4 = (0, _asyncToGenerator2[\"default\"])(\n                  /*#__PURE__*/\n                  _regenerator[\"default\"].mark(function _callee13(entry) {\n                    var cid, obj;\n                    return _regenerator[\"default\"].wrap(function _callee13$(_context13) {\n                      while (1) {\n                        switch (_context13.prev = _context13.next) {\n                          case 0:\n                            cid = entry.payload.value.data; // TODO handle missing ipfs obj??, timeouts?\n\n                            _context13.next = 3;\n                            return _this7.ipfs.dag.get(cid);\n\n                          case 3:\n                            obj = _context13.sent.value;\n\n                            _this7.ipfs.pin.add(cid);\n\n                            obj.entry = entry;\n                            return _context13.abrupt(\"return\", obj);\n\n                          case 7:\n                          case \"end\":\n                            return _context13.stop();\n                        }\n                      }\n                    }, _callee13);\n                  }));\n\n                  return function (_x16) {\n                    return _ref4.apply(this, arguments);\n                  };\n                }());\n                return _context14.abrupt(\"return\", Promise.all(resolveLinks));\n\n              case 6:\n              case \"end\":\n                return _context14.stop();\n            }\n          }\n        }, _callee14, this);\n      }));\n\n      function getAuthData() {\n        return _getAuthData.apply(this, arguments);\n      }\n\n      return getAuthData;\n    }()\n  }, {\n    key: \"ensureConnected\",\n    value: function () {\n      var _ensureConnected = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee15(odbAddress) {\n        var _this8 = this;\n\n        var isThread, roomPeers;\n        return _regenerator[\"default\"].wrap(function _callee15$(_context15) {\n          while (1) {\n            switch (_context15.prev = _context15.next) {\n              case 0:\n                isThread = odbAddress.includes('thread');\n                _context15.next = 3;\n                return this.ipfs.pubsub.peers(odbAddress);\n\n              case 3:\n                roomPeers = _context15.sent;\n\n                if (!roomPeers.find(function (p) {\n                  return p === _this8._pinningNodePeerId;\n                })) {\n                  this.ipfs.swarm.connect(this._pinningNode, function () {});\n                  odbAddress = isThread ? odbAddress : this.rootstore.address.toString();\n\n                  this._publishDB({\n                    odbAddress: odbAddress,\n                    isThread: isThread\n                  }, true);\n                }\n\n              case 5:\n              case \"end\":\n                return _context15.stop();\n            }\n          }\n        }, _callee15, this);\n      }));\n\n      function ensureConnected(_x17) {\n        return _ensureConnected.apply(this, arguments);\n      }\n\n      return ensureConnected;\n    }()\n  }, {\n    key: \"_publishDB\",\n    value: function () {\n      var _publishDB2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee16(_ref5, unsubscribe) {\n        var _this9 = this;\n\n        var odbAddress, isThread, pinningNodeJoined;\n        return _regenerator[\"default\"].wrap(function _callee16$(_context16) {\n          while (1) {\n            switch (_context16.prev = _context16.next) {\n              case 0:\n                odbAddress = _ref5.odbAddress, isThread = _ref5.isThread;\n\n                this._joinPinningRoom();\n\n                odbAddress = odbAddress || this.rootstore.address.toString(); // make sure that the pinning node is in the pubsub room before publishing\n\n                pinningNodeJoined = new Promise(function (resolve, reject) {\n                  _this9.events.on('pinning-room-peer', function (topic, peer) {\n                    if (peer === _this9._pinningNodePeerId) {\n                      resolve();\n                    }\n                  });\n                });\n                _context16.next = 6;\n                return this.ipfs.pubsub.peers(PINNING_ROOM);\n\n              case 6:\n                _context16.t0 = this._pinningNodePeerId;\n\n                if (_context16.sent.includes(_context16.t0)) {\n                  _context16.next = 10;\n                  break;\n                }\n\n                _context16.next = 10;\n                return pinningNodeJoined;\n\n              case 10:\n                this._pubsub.publish(PINNING_ROOM, {\n                  type: isThread ? 'SYNC_DB' : 'PIN_DB',\n                  odbAddress: odbAddress,\n                  did: this._did,\n                  thread: isThread\n                });\n\n                this.events.removeAllListeners('pinning-room-peer');\n\n                if (unsubscribe) {\n                  this._pubsub.unsubscribe(PINNING_ROOM);\n                }\n\n              case 13:\n              case \"end\":\n                return _context16.stop();\n            }\n          }\n        }, _callee16, this);\n      }));\n\n      function _publishDB(_x18, _x19) {\n        return _publishDB2.apply(this, arguments);\n      }\n\n      return _publishDB;\n    }()\n  }, {\n    key: \"_getNumEntries\",\n    value: function () {\n      var _getNumEntries2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee17(odbAddress) {\n        var _this10 = this;\n\n        return _regenerator[\"default\"].wrap(function _callee17$(_context17) {\n          while (1) {\n            switch (_context17.prev = _context17.next) {\n              case 0:\n                return _context17.abrupt(\"return\", new Promise(function (resolve, reject) {\n                  var eventName = \"has-\".concat(odbAddress);\n\n                  _this10.events.on(eventName, function (data) {\n                    _this10.events.removeAllListeners(eventName);\n\n                    resolve(data.numEntries);\n                  });\n\n                  if (_this10._hasPubsubMsgs[odbAddress]) {\n                    _this10.events.removeAllListeners(eventName);\n\n                    resolve(_this10._hasPubsubMsgs[odbAddress].numEntries);\n                  }\n                }));\n\n              case 1:\n              case \"end\":\n                return _context17.stop();\n            }\n          }\n        }, _callee17);\n      }));\n\n      function _getNumEntries(_x20) {\n        return _getNumEntries2.apply(this, arguments);\n      }\n\n      return _getNumEntries;\n    }()\n  }, {\n    key: \"syncDB\",\n    value: function () {\n      var _syncDB = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee18(dbInstance) {\n        var numRemoteEntries, isNumber;\n        return _regenerator[\"default\"].wrap(function _callee18$(_context18) {\n          while (1) {\n            switch (_context18.prev = _context18.next) {\n              case 0:\n                _context18.next = 2;\n                return this._getNumEntries(dbInstance.address.toString());\n\n              case 2:\n                numRemoteEntries = _context18.sent;\n                isNumber = typeof numRemoteEntries === 'number';\n\n                if (!(isNumber && numRemoteEntries <= dbInstance._oplog.values.length)) {\n                  _context18.next = 6;\n                  break;\n                }\n\n                return _context18.abrupt(\"return\", Promise.resolve());\n\n              case 6:\n                _context18.next = 8;\n                return new Promise(function (resolve, reject) {\n                  dbInstance.events.on('replicated', function () {\n                    if (numRemoteEntries <= dbInstance._oplog.values.length) {\n                      resolve();\n                      dbInstance.events.removeAllListeners('replicated');\n                    }\n                  });\n                });\n\n              case 8:\n              case \"end\":\n                return _context18.stop();\n            }\n          }\n        }, _callee18, this);\n      }));\n\n      function syncDB(_x21) {\n        return _syncDB.apply(this, arguments);\n      }\n\n      return syncDB;\n    }()\n  }, {\n    key: \"_pinningNodePeerId\",\n    get: function get() {\n      return this._pinningNode.split('/').pop();\n    }\n  }], [{\n    key: \"create\",\n    value: function () {\n      var _create = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee19(ipfs) {\n        var opts,\n            replicator,\n            _args19 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee19$(_context19) {\n          while (1) {\n            switch (_context19.prev = _context19.next) {\n              case 0:\n                opts = _args19.length > 1 && _args19[1] !== undefined ? _args19[1] : {};\n                replicator = new Replicator(ipfs, opts);\n                _context19.next = 4;\n                return replicator._init(opts);\n\n              case 4:\n                return _context19.abrupt(\"return\", replicator);\n\n              case 5:\n              case \"end\":\n                return _context19.stop();\n            }\n          }\n        }, _callee19);\n      }));\n\n      function create(_x22) {\n        return _create.apply(this, arguments);\n      }\n\n      return create;\n    }()\n  }, {\n    key: \"entryTypes\",\n    get: function get() {\n      return entryTypes;\n    }\n  }]);\n  return Replicator;\n}();\n\nmodule.exports = Replicator;"]},"metadata":{},"sourceType":"script"}