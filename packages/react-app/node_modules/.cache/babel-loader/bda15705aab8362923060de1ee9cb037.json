{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    if (enumerableOnly) symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    });\n    keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n\n    if (i % 2) {\n      ownKeys(source, true).forEach(function (key) {\n        (0, _defineProperty2[\"default\"])(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(source).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n\n  return target;\n}\n\nvar _require = require('@ethersproject/hdnode'),\n    mnemonicToSeed = _require.mnemonicToSeed,\n    entropyToMnemonic = _require.entropyToMnemonic;\n\nvar EventEmitter = require('events');\n\nvar didJWT = require('did-jwt');\n\nvar DidDocument = require('ipfs-did-document');\n\nvar IpfsMini = require('ipfs-mini');\n\nvar localstorage = require('store');\n\nvar Identities = require('orbit-db-identity-provider');\n\nvar _require2 = require('3box-orbitdb-plugins'),\n    OdbIdentityProvider = _require2.OdbIdentityProvider;\n\nIdentities.addIdentityProvider(OdbIdentityProvider);\n\nvar utils = require('../utils/index');\n\nvar Keyring = require('./keyring');\n\nvar config = require('../config.js');\n\nvar nacl = require('tweetnacl');\n\nvar _require3 = require('./utils'),\n    randomNonce = _require3.randomNonce;\n\nvar DID_METHOD_NAME = '3';\nvar STORAGE_KEY = 'serialized3id_';\nvar MUPORT_IPFS = {\n  host: config.muport_ipfs_host,\n  port: config.muport_ipfs_port,\n  protocol: config.muport_ipfs_protocol\n};\nvar POLL_INTERVAL = 500;\n\nvar ThreeId = /*#__PURE__*/function () {\n  function ThreeId(provider, ipfs, keystore) {\n    var opts = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {};\n    (0, _classCallCheck2[\"default\"])(this, ThreeId);\n    this.events = new EventEmitter();\n    this._provider = provider;\n    this._has3idProv = Boolean(opts.has3idProv);\n    this._ipfs = ipfs;\n    this._muportIpfs = opts.muportIpfs || MUPORT_IPFS;\n    this._pubkeys = {\n      spaces: {}\n    };\n    this._keystore = keystore;\n  }\n\n  (0, _createClass2[\"default\"])(ThreeId, [{\n    key: \"startUpdatePolling\",\n    value: function startUpdatePolling() {\n      var _this = this;\n\n      if (this._has3idProv) {\n        var poll = /*#__PURE__*/function () {\n          var _ref = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(method, event) {\n            var result;\n            return _regenerator[\"default\"].wrap(function _callee$(_context) {\n              while (1) {\n                switch (_context.prev = _context.next) {\n                  case 0:\n                    _context.next = 2;\n                    return utils.callRpc(_this._provider, method);\n\n                  case 2:\n                    result = _context.sent;\n                    result.map(function (data) {\n                      _this.events.emit(event, data);\n                    });\n\n                  case 4:\n                  case \"end\":\n                    return _context.stop();\n                }\n              }\n            }, _callee);\n          }));\n\n          return function poll(_x, _x2) {\n            return _ref.apply(this, arguments);\n          };\n        }();\n\n        setInterval(function () {\n          poll('3id_newAuthMethodPoll', 'new-auth-method');\n          poll('3id_newLinkPoll', 'new-link-proof');\n        }, POLL_INTERVAL);\n      }\n    }\n  }, {\n    key: \"signJWT\",\n    value: function () {\n      var _signJWT = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee2(payload) {\n        var _ref2,\n            space,\n            expiresIn,\n            issuer,\n            keyring,\n            settings,\n            _args2 = arguments;\n\n        return _regenerator[\"default\"].wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _ref2 = _args2.length > 1 && _args2[1] !== undefined ? _args2[1] : {}, space = _ref2.space, expiresIn = _ref2.expiresIn;\n                issuer = this.DID;\n\n                if (space) {\n                  issuer = this._subDIDs[space];\n                }\n\n                if (!this._has3idProv) {\n                  _context2.next = 7;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\", utils.callRpc(this._provider, '3id_signClaim', {\n                  payload: payload,\n                  did: issuer,\n                  space: space,\n                  expiresIn: expiresIn\n                }));\n\n              case 7:\n                keyring = this._keyringBySpace(space);\n                settings = {\n                  signer: keyring.getJWTSigner(),\n                  issuer: issuer,\n                  expiresIn: expiresIn\n                };\n                return _context2.abrupt(\"return\", didJWT.createJWT(payload, settings));\n\n              case 10:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function signJWT(_x3) {\n        return _signJWT.apply(this, arguments);\n      }\n\n      return signJWT;\n    }()\n  }, {\n    key: \"getSubDID\",\n    value: function getSubDID(space) {\n      return this._subDIDs[space];\n    }\n  }, {\n    key: \"getOdbId\",\n    value: function () {\n      var _getOdbId = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee3(space) {\n        return _regenerator[\"default\"].wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                return _context3.abrupt(\"return\", Identities.createIdentity({\n                  type: '3ID',\n                  threeId: this,\n                  space: space,\n                  keystore: this._keystore\n                }));\n\n              case 1:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function getOdbId(_x4) {\n        return _getOdbId.apply(this, arguments);\n      }\n\n      return getOdbId;\n    }()\n  }, {\n    key: \"serializeState\",\n    value: function serializeState() {\n      var _this2 = this;\n\n      if (this._has3idProv) throw new Error('Can not serializeState of IdentityWallet');\n      var stateObj = {\n        managementAddress: this.managementAddress,\n        seed: this._mainKeyring.serialize(),\n        spaceSeeds: {}\n      };\n      Object.keys(this._keyrings).map(function (name) {\n        stateObj.spaceSeeds[name] = _this2._keyrings[name].serialize();\n      });\n      return JSON.stringify(stateObj);\n    }\n  }, {\n    key: \"_initKeys\",\n    value: function _initKeys(serializedState) {\n      var _this3 = this;\n\n      if (this._has3idProv) throw new Error('Can not initKeys of IdentityWallet');\n      this._keyrings = {};\n      var state = JSON.parse(serializedState); // TODO remove toLowerCase() in future, should be sanitized elsewhere\n      //      this forces existing state to correct state so that address <->\n      //      rootstore relation holds\n\n      this.managementAddress = state.managementAddress.toLowerCase();\n      this._mainKeyring = new Keyring(state.seed);\n      Object.keys(state.spaceSeeds).map(function (name) {\n        _this3._keyrings[name] = new Keyring(state.spaceSeeds[name]);\n      });\n      localstorage.set(STORAGE_KEY + this.managementAddress, this.serializeState());\n    }\n  }, {\n    key: \"_initDID\",\n    value: function () {\n      var _initDID2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee4() {\n        var _this4 = this;\n\n        var muportPromise, spaces, subDIDs;\n        return _regenerator[\"default\"].wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                muportPromise = this._initMuport();\n                _context4.next = 3;\n                return this._init3ID();\n\n              case 3:\n                this._rootDID = _context4.sent;\n\n                if (this._has3idProv) {\n                  spaces = Object.keys(this._pubkeys.spaces);\n                } else {\n                  spaces = Object.keys(this._keyrings);\n                }\n\n                _context4.next = 7;\n                return Promise.all(spaces.map(function (space) {\n                  return _this4._init3ID(space);\n                }));\n\n              case 7:\n                subDIDs = _context4.sent;\n                this._subDIDs = {};\n                spaces.map(function (space, i) {\n                  _this4._subDIDs[space] = subDIDs[i];\n                });\n                _context4.next = 12;\n                return muportPromise;\n\n              case 12:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function _initDID() {\n        return _initDID2.apply(this, arguments);\n      }\n\n      return _initDID;\n    }()\n  }, {\n    key: \"_init3ID\",\n    value: function () {\n      var _init3ID2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee5(spaceName) {\n        var doc, pubkeys, payload, signature;\n        return _regenerator[\"default\"].wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                doc = new DidDocument(this._ipfs, DID_METHOD_NAME);\n                _context5.next = 3;\n                return this.getPublicKeys(spaceName, true);\n\n              case 3:\n                pubkeys = _context5.sent;\n\n                if (spaceName) {\n                  _context5.next = 11;\n                  break;\n                }\n\n                doc.addPublicKey('signingKey', 'Secp256k1VerificationKey2018', 'publicKeyHex', pubkeys.signingKey);\n                doc.addPublicKey('encryptionKey', 'Curve25519EncryptionPublicKey', 'publicKeyBase64', pubkeys.asymEncryptionKey);\n                doc.addPublicKey('managementKey', 'Secp256k1VerificationKey2018', 'ethereumAddress', pubkeys.managementKey);\n                doc.addAuthentication('Secp256k1SignatureAuthentication2018', 'signingKey');\n                _context5.next = 21;\n                break;\n\n              case 11:\n                doc.addPublicKey('subSigningKey', 'Secp256k1VerificationKey2018', 'publicKeyHex', pubkeys.signingKey);\n                doc.addPublicKey('subEncryptionKey', 'Curve25519EncryptionPublicKey', 'publicKeyBase64', pubkeys.asymEncryptionKey);\n                doc.addAuthentication('Secp256k1SignatureAuthentication2018', 'subSigningKey');\n                doc.addCustomProperty('space', spaceName);\n                doc.addCustomProperty('root', this.DID);\n                payload = {\n                  subSigningKey: pubkeys.signingKey,\n                  subEncryptionKey: pubkeys.asymEncryptionKey,\n                  space: spaceName,\n                  iat: null\n                };\n                _context5.next = 19;\n                return this.signJWT(payload, {\n                  use3ID: true\n                });\n\n              case 19:\n                signature = _context5.sent.split('.')[2];\n                doc.addCustomProperty('proof', {\n                  alg: 'ES256K',\n                  signature: signature\n                });\n\n              case 21:\n                _context5.next = 23;\n                return doc.commit({\n                  noTimestamp: true\n                });\n\n              case 23:\n                return _context5.abrupt(\"return\", doc.DID);\n\n              case 24:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function _init3ID(_x5) {\n        return _init3ID2.apply(this, arguments);\n      }\n\n      return _init3ID;\n    }()\n  }, {\n    key: \"_initMuport\",\n    value: function () {\n      var _initMuport2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee6() {\n        var keys, doc, docHash;\n        return _regenerator[\"default\"].wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                _context6.next = 2;\n                return this.getPublicKeys(null);\n\n              case 2:\n                keys = _context6.sent;\n                doc = createMuportDocument(keys.signingKey, keys.managementKey, keys.asymEncryptionKey);\n                _context6.next = 6;\n                return this._ipfs.add(Buffer.from(JSON.stringify(doc)));\n\n              case 6:\n                docHash = _context6.sent[0].hash;\n                this._muportDID = 'did:muport:' + docHash;\n                this.muportFingerprint = utils.sha256Multihash(this.muportDID);\n\n              case 9:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this);\n      }));\n\n      function _initMuport() {\n        return _initMuport2.apply(this, arguments);\n      }\n\n      return _initMuport;\n    }()\n  }, {\n    key: \"getAddress\",\n    value: function () {\n      var _getAddress = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee7() {\n        return _regenerator[\"default\"].wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                if (!this._has3idProv) {\n                  _context7.next = 4;\n                  break;\n                }\n\n                return _context7.abrupt(\"return\", utils.callRpc(this._provider, '3id_getLink'));\n\n              case 4:\n                return _context7.abrupt(\"return\", this.managementAddress);\n\n              case 5:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this);\n      }));\n\n      function getAddress() {\n        return _getAddress.apply(this, arguments);\n      }\n\n      return getAddress;\n    }()\n  }, {\n    key: \"authenticate\",\n    value: function () {\n      var _authenticate = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee8(spaces) {\n        var opts,\n            pubkeys,\n            _iteratorNormalCompletion,\n            _didIteratorError,\n            _iteratorError,\n            _iterator,\n            _step,\n            space,\n            _iteratorNormalCompletion2,\n            _didIteratorError2,\n            _iteratorError2,\n            _iterator2,\n            _step2,\n            _space,\n            _args8 = arguments;\n\n        return _regenerator[\"default\"].wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                opts = _args8.length > 1 && _args8[1] !== undefined ? _args8[1] : {};\n                spaces = spaces || [];\n\n                if (!this._has3idProv) {\n                  _context8.next = 43;\n                  break;\n                }\n\n                _context8.next = 5;\n                return utils.callRpc(this._provider, '3id_authenticate', {\n                  spaces: spaces,\n                  authData: opts.authData\n                });\n\n              case 5:\n                pubkeys = _context8.sent;\n                this._pubkeys.main = pubkeys.main;\n                this._pubkeys.spaces = Object.assign(this._pubkeys.spaces, pubkeys.spaces);\n\n                if (this.DID) {\n                  _context8.next = 13;\n                  break;\n                }\n\n                _context8.next = 11;\n                return this._initDID();\n\n              case 11:\n                _context8.next = 41;\n                break;\n\n              case 13:\n                _iteratorNormalCompletion = true;\n                _didIteratorError = false;\n                _iteratorError = undefined;\n                _context8.prev = 16;\n                _iterator = spaces[Symbol.iterator]();\n\n              case 18:\n                if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {\n                  _context8.next = 27;\n                  break;\n                }\n\n                space = _step.value;\n\n                if (this._subDIDs[space]) {\n                  _context8.next = 24;\n                  break;\n                }\n\n                _context8.next = 23;\n                return this._init3ID(space);\n\n              case 23:\n                this._subDIDs[space] = _context8.sent;\n\n              case 24:\n                _iteratorNormalCompletion = true;\n                _context8.next = 18;\n                break;\n\n              case 27:\n                _context8.next = 33;\n                break;\n\n              case 29:\n                _context8.prev = 29;\n                _context8.t0 = _context8[\"catch\"](16);\n                _didIteratorError = true;\n                _iteratorError = _context8.t0;\n\n              case 33:\n                _context8.prev = 33;\n                _context8.prev = 34;\n\n                if (!_iteratorNormalCompletion && _iterator[\"return\"] != null) {\n                  _iterator[\"return\"]();\n                }\n\n              case 36:\n                _context8.prev = 36;\n\n                if (!_didIteratorError) {\n                  _context8.next = 39;\n                  break;\n                }\n\n                throw _iteratorError;\n\n              case 39:\n                return _context8.finish(36);\n\n              case 40:\n                return _context8.finish(33);\n\n              case 41:\n                _context8.next = 69;\n                break;\n\n              case 43:\n                _iteratorNormalCompletion2 = true;\n                _didIteratorError2 = false;\n                _iteratorError2 = undefined;\n                _context8.prev = 46;\n                _iterator2 = spaces[Symbol.iterator]();\n\n              case 48:\n                if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {\n                  _context8.next = 55;\n                  break;\n                }\n\n                _space = _step2.value;\n                _context8.next = 52;\n                return this._initKeyringByName(_space);\n\n              case 52:\n                _iteratorNormalCompletion2 = true;\n                _context8.next = 48;\n                break;\n\n              case 55:\n                _context8.next = 61;\n                break;\n\n              case 57:\n                _context8.prev = 57;\n                _context8.t1 = _context8[\"catch\"](46);\n                _didIteratorError2 = true;\n                _iteratorError2 = _context8.t1;\n\n              case 61:\n                _context8.prev = 61;\n                _context8.prev = 62;\n\n                if (!_iteratorNormalCompletion2 && _iterator2[\"return\"] != null) {\n                  _iterator2[\"return\"]();\n                }\n\n              case 64:\n                _context8.prev = 64;\n\n                if (!_didIteratorError2) {\n                  _context8.next = 67;\n                  break;\n                }\n\n                throw _iteratorError2;\n\n              case 67:\n                return _context8.finish(64);\n\n              case 68:\n                return _context8.finish(61);\n\n              case 69:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8, this, [[16, 29, 33, 41], [34,, 36, 40], [46, 57, 61, 69], [62,, 64, 68]]);\n      }));\n\n      function authenticate(_x6) {\n        return _authenticate.apply(this, arguments);\n      }\n\n      return authenticate;\n    }()\n  }, {\n    key: \"isAuthenticated\",\n    value: function () {\n      var _isAuthenticated = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee9() {\n        var _this5 = this;\n\n        var spaces,\n            _args9 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee9$(_context9) {\n          while (1) {\n            switch (_context9.prev = _context9.next) {\n              case 0:\n                spaces = _args9.length > 0 && _args9[0] !== undefined ? _args9[0] : [];\n                return _context9.abrupt(\"return\", spaces.reduce(function (acc, space) {\n                  return acc && Object.keys(_this5._subDIDs).includes(space);\n                }, true));\n\n              case 2:\n              case \"end\":\n                return _context9.stop();\n            }\n          }\n        }, _callee9);\n      }));\n\n      function isAuthenticated() {\n        return _isAuthenticated.apply(this, arguments);\n      }\n\n      return isAuthenticated;\n    }()\n  }, {\n    key: \"_initKeyringByName\",\n    value: function () {\n      var _initKeyringByName2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee10(name) {\n        var sig, entropy, seed;\n        return _regenerator[\"default\"].wrap(function _callee10$(_context10) {\n          while (1) {\n            switch (_context10.prev = _context10.next) {\n              case 0:\n                if (!this._has3idProv) {\n                  _context10.next = 2;\n                  break;\n                }\n\n                throw new Error('Can not initKeyringByName of IdentityWallet');\n\n              case 2:\n                if (this._keyrings[name]) {\n                  _context10.next = 16;\n                  break;\n                }\n\n                _context10.next = 5;\n                return utils.openSpaceConsent(this.managementAddress, this._provider, name);\n\n              case 5:\n                sig = _context10.sent;\n                entropy = '0x' + utils.sha256(sig.slice(2));\n                seed = mnemonicToSeed(entropyToMnemonic(entropy));\n                this._keyrings[name] = new Keyring(seed);\n                _context10.next = 11;\n                return this._init3ID(name);\n\n              case 11:\n                this._subDIDs[name] = _context10.sent;\n                localstorage.set(STORAGE_KEY + this.managementAddress, this.serializeState());\n                return _context10.abrupt(\"return\", true);\n\n              case 16:\n                return _context10.abrupt(\"return\", false);\n\n              case 17:\n              case \"end\":\n                return _context10.stop();\n            }\n          }\n        }, _callee10, this);\n      }));\n\n      function _initKeyringByName(_x7) {\n        return _initKeyringByName2.apply(this, arguments);\n      }\n\n      return _initKeyringByName;\n    }()\n  }, {\n    key: \"getPublicKeys\",\n    value: function () {\n      var _getPublicKeys = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee11(space, uncompressed) {\n        var pubkeys;\n        return _regenerator[\"default\"].wrap(function _callee11$(_context11) {\n          while (1) {\n            switch (_context11.prev = _context11.next) {\n              case 0:\n                if (this._has3idProv) {\n                  pubkeys = Object.assign({}, space ? this._pubkeys.spaces[space] : this._pubkeys.main);\n\n                  if (uncompressed) {\n                    pubkeys.signingKey = Keyring.uncompress(pubkeys.signingKey);\n                  }\n                } else {\n                  pubkeys = this._keyringBySpace(space).getPublicKeys(uncompressed);\n                  pubkeys.managementKey = this.managementAddress;\n                }\n\n                return _context11.abrupt(\"return\", pubkeys);\n\n              case 2:\n              case \"end\":\n                return _context11.stop();\n            }\n          }\n        }, _callee11, this);\n      }));\n\n      function getPublicKeys(_x8, _x9) {\n        return _getPublicKeys.apply(this, arguments);\n      }\n\n      return getPublicKeys;\n    }()\n  }, {\n    key: \"encrypt\",\n    value: function () {\n      var _encrypt = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee12(message, space, to) {\n        var keyring, paddedMsg;\n        return _regenerator[\"default\"].wrap(function _callee12$(_context12) {\n          while (1) {\n            switch (_context12.prev = _context12.next) {\n              case 0:\n                if (!this._has3idProv) {\n                  _context12.next = 4;\n                  break;\n                }\n\n                return _context12.abrupt(\"return\", utils.callRpc(this._provider, '3id_encrypt', {\n                  message: message,\n                  space: space,\n                  to: to\n                }));\n\n              case 4:\n                keyring = this._keyringBySpace(space);\n                paddedMsg = typeof message === 'string' ? utils.pad(message) : message;\n\n                if (!to) {\n                  _context12.next = 10;\n                  break;\n                }\n\n                return _context12.abrupt(\"return\", keyring.asymEncrypt(paddedMsg, to));\n\n              case 10:\n                return _context12.abrupt(\"return\", keyring.symEncrypt(paddedMsg));\n\n              case 11:\n              case \"end\":\n                return _context12.stop();\n            }\n          }\n        }, _callee12, this);\n      }));\n\n      function encrypt(_x10, _x11, _x12) {\n        return _encrypt.apply(this, arguments);\n      }\n\n      return encrypt;\n    }()\n  }, {\n    key: \"decrypt\",\n    value: function () {\n      var _decrypt = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee13(encObj, space, toBuffer) {\n        var keyring, paddedMsg;\n        return _regenerator[\"default\"].wrap(function _callee13$(_context13) {\n          while (1) {\n            switch (_context13.prev = _context13.next) {\n              case 0:\n                if (!this._has3idProv) {\n                  _context13.next = 4;\n                  break;\n                }\n\n                return _context13.abrupt(\"return\", utils.callRpc(this._provider, '3id_decrypt', _objectSpread({}, encObj, {\n                  space: space\n                })));\n\n              case 4:\n                keyring = this._keyringBySpace(space);\n\n                if (encObj.ephemeralFrom) {\n                  paddedMsg = keyring.asymDecrypt(encObj.ciphertext, encObj.ephemeralFrom, encObj.nonce, toBuffer);\n                } else {\n                  paddedMsg = keyring.symDecrypt(encObj.ciphertext, encObj.nonce, toBuffer);\n                }\n\n                return _context13.abrupt(\"return\", toBuffer ? paddedMsg : utils.unpad(paddedMsg));\n\n              case 7:\n              case \"end\":\n                return _context13.stop();\n            }\n          }\n        }, _callee13, this);\n      }));\n\n      function decrypt(_x13, _x14, _x15) {\n        return _decrypt.apply(this, arguments);\n      }\n\n      return decrypt;\n    }()\n  }, {\n    key: \"hashDBKey\",\n    value: function () {\n      var _hashDBKey = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee14(key, space) {\n        var salt;\n        return _regenerator[\"default\"].wrap(function _callee14$(_context14) {\n          while (1) {\n            switch (_context14.prev = _context14.next) {\n              case 0:\n                if (!this._has3idProv) {\n                  _context14.next = 4;\n                  break;\n                }\n\n                return _context14.abrupt(\"return\", utils.callRpc(this._provider, '3id_hashEntryKey', {\n                  key: key,\n                  space: space\n                }));\n\n              case 4:\n                salt = this._keyringBySpace(space).getDBSalt();\n                return _context14.abrupt(\"return\", utils.sha256Multihash(salt + key));\n\n              case 6:\n              case \"end\":\n                return _context14.stop();\n            }\n          }\n        }, _callee14, this);\n      }));\n\n      function hashDBKey(_x16, _x17) {\n        return _hashDBKey.apply(this, arguments);\n      }\n\n      return hashDBKey;\n    }()\n  }, {\n    key: \"_keyringBySpace\",\n    value: function _keyringBySpace(space) {\n      return space ? this._keyrings[space] : this._mainKeyring;\n    }\n  }, {\n    key: \"logout\",\n    value: function logout() {\n      localstorage.remove(STORAGE_KEY + this.managementAddress);\n    }\n  }, {\n    key: \"DID\",\n    get: function get() {\n      return this._rootDID;\n    }\n  }, {\n    key: \"muportDID\",\n    get: function get() {\n      return this._muportDID;\n    }\n  }], [{\n    key: \"isLoggedIn\",\n    value: function isLoggedIn(address) {\n      return Boolean(localstorage.get(STORAGE_KEY + address.toLowerCase()));\n    }\n  }, {\n    key: \"getIdFromEthAddress\",\n    value: function () {\n      var _getIdFromEthAddress = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee15(address, provider, ipfs, keystore) {\n        var opts,\n            normalizedAddress,\n            serialized3id,\n            sig,\n            entropy,\n            mnemonic,\n            seed,\n            threeId,\n            _args15 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee15$(_context15) {\n          while (1) {\n            switch (_context15.prev = _context15.next) {\n              case 0:\n                opts = _args15.length > 4 && _args15[4] !== undefined ? _args15[4] : {};\n                opts.has3idProv = Boolean(provider.is3idProvider);\n\n                if (!opts.has3idProv) {\n                  _context15.next = 6;\n                  break;\n                }\n\n                return _context15.abrupt(\"return\", new ThreeId(provider, ipfs, keystore, opts));\n\n              case 6:\n                normalizedAddress = address.toLowerCase();\n                serialized3id = localstorage.get(STORAGE_KEY + normalizedAddress);\n\n                if (!serialized3id) {\n                  _context15.next = 12;\n                  break;\n                }\n\n                if (opts.consentCallback) opts.consentCallback(false);\n                _context15.next = 24;\n                break;\n\n              case 12:\n                if (!opts.contentSignature) {\n                  _context15.next = 16;\n                  break;\n                }\n\n                sig = opts.contentSignature;\n                _context15.next = 19;\n                break;\n\n              case 16:\n                _context15.next = 18;\n                return utils.openBoxConsent(normalizedAddress, provider);\n\n              case 18:\n                sig = _context15.sent;\n\n              case 19:\n                if (opts.consentCallback) opts.consentCallback(true);\n                entropy = '0x' + utils.sha256(sig.slice(2));\n                mnemonic = entropyToMnemonic(entropy);\n                seed = mnemonicToSeed(mnemonic);\n                serialized3id = JSON.stringify({\n                  managementAddress: normalizedAddress,\n                  seed: seed,\n                  spaceSeeds: {}\n                });\n\n              case 24:\n                threeId = new ThreeId(provider, ipfs, keystore, opts);\n\n                threeId._initKeys(serialized3id);\n\n                _context15.next = 28;\n                return threeId._initDID();\n\n              case 28:\n                return _context15.abrupt(\"return\", threeId);\n\n              case 29:\n              case \"end\":\n                return _context15.stop();\n            }\n          }\n        }, _callee15);\n      }));\n\n      function getIdFromEthAddress(_x18, _x19, _x20, _x21) {\n        return _getIdFromEthAddress.apply(this, arguments);\n      }\n\n      return getIdFromEthAddress;\n    }()\n  }]);\n  return ThreeId;\n}();\n\nvar createMuportDocument = function createMuportDocument(signingKey, managementKey, asymEncryptionKey) {\n  return {\n    version: 1,\n    signingKey: signingKey,\n    managementKey: managementKey,\n    asymEncryptionKey: asymEncryptionKey\n  };\n};\n\nmodule.exports = ThreeId;","map":{"version":3,"sources":["/home/dekan/Projects/raid-guild/dao-badges-web/node_modules/3box/lib/3id/index.js"],"names":["_interopRequireDefault","require","_defineProperty2","_regenerator","_asyncToGenerator2","_classCallCheck2","_createClass2","ownKeys","object","enumerableOnly","keys","Object","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","getOwnPropertyDescriptors","defineProperties","defineProperty","_require","mnemonicToSeed","entropyToMnemonic","EventEmitter","didJWT","DidDocument","IpfsMini","localstorage","Identities","_require2","OdbIdentityProvider","addIdentityProvider","utils","Keyring","config","nacl","_require3","randomNonce","DID_METHOD_NAME","STORAGE_KEY","MUPORT_IPFS","host","muport_ipfs_host","port","muport_ipfs_port","protocol","muport_ipfs_protocol","POLL_INTERVAL","ThreeId","provider","ipfs","keystore","opts","undefined","events","_provider","_has3idProv","Boolean","has3idProv","_ipfs","_muportIpfs","muportIpfs","_pubkeys","spaces","_keystore","value","startUpdatePolling","_this","poll","_ref","mark","_callee","method","event","result","wrap","_callee$","_context","prev","next","callRpc","sent","map","data","emit","stop","_x","_x2","setInterval","_signJWT","_callee2","payload","_ref2","space","expiresIn","issuer","keyring","settings","_args2","_callee2$","_context2","DID","_subDIDs","abrupt","did","_keyringBySpace","signer","getJWTSigner","createJWT","signJWT","_x3","getSubDID","_getOdbId","_callee3","_callee3$","_context3","createIdentity","type","threeId","getOdbId","_x4","serializeState","_this2","Error","stateObj","managementAddress","seed","_mainKeyring","serialize","spaceSeeds","_keyrings","name","JSON","stringify","_initKeys","serializedState","_this3","state","parse","toLowerCase","set","_initDID2","_callee4","_this4","muportPromise","subDIDs","_callee4$","_context4","_initMuport","_init3ID","_rootDID","Promise","all","_initDID","_init3ID2","_callee5","spaceName","doc","pubkeys","signature","_callee5$","_context5","getPublicKeys","addPublicKey","signingKey","asymEncryptionKey","managementKey","addAuthentication","addCustomProperty","subSigningKey","subEncryptionKey","iat","use3ID","split","alg","commit","noTimestamp","_x5","_initMuport2","_callee6","docHash","_callee6$","_context6","createMuportDocument","add","Buffer","from","hash","_muportDID","muportFingerprint","sha256Multihash","muportDID","_getAddress","_callee7","_callee7$","_context7","getAddress","_authenticate","_callee8","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_iterator","_step","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_iterator2","_step2","_space","_args8","_callee8$","_context8","authData","main","assign","Symbol","iterator","done","t0","finish","_initKeyringByName","t1","authenticate","_x6","_isAuthenticated","_callee9","_this5","_args9","_callee9$","_context9","reduce","acc","includes","isAuthenticated","_initKeyringByName2","_callee10","sig","entropy","_callee10$","_context10","openSpaceConsent","sha256","slice","_x7","_getPublicKeys","_callee11","uncompressed","_callee11$","_context11","uncompress","_x8","_x9","_encrypt","_callee12","message","to","paddedMsg","_callee12$","_context12","pad","asymEncrypt","symEncrypt","encrypt","_x10","_x11","_x12","_decrypt","_callee13","encObj","toBuffer","_callee13$","_context13","ephemeralFrom","asymDecrypt","ciphertext","nonce","symDecrypt","unpad","decrypt","_x13","_x14","_x15","_hashDBKey","_callee14","salt","_callee14$","_context14","getDBSalt","hashDBKey","_x16","_x17","logout","remove","get","isLoggedIn","address","_getIdFromEthAddress","_callee15","normalizedAddress","serialized3id","mnemonic","_args15","_callee15$","_context15","is3idProvider","consentCallback","contentSignature","openBoxConsent","getIdFromEthAddress","_x18","_x19","_x20","_x21","version","module","exports"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2[\"default\"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nvar _require = require('@ethersproject/hdnode'),\n    mnemonicToSeed = _require.mnemonicToSeed,\n    entropyToMnemonic = _require.entropyToMnemonic;\n\nvar EventEmitter = require('events');\n\nvar didJWT = require('did-jwt');\n\nvar DidDocument = require('ipfs-did-document');\n\nvar IpfsMini = require('ipfs-mini');\n\nvar localstorage = require('store');\n\nvar Identities = require('orbit-db-identity-provider');\n\nvar _require2 = require('3box-orbitdb-plugins'),\n    OdbIdentityProvider = _require2.OdbIdentityProvider;\n\nIdentities.addIdentityProvider(OdbIdentityProvider);\n\nvar utils = require('../utils/index');\n\nvar Keyring = require('./keyring');\n\nvar config = require('../config.js');\n\nvar nacl = require('tweetnacl');\n\nvar _require3 = require('./utils'),\n    randomNonce = _require3.randomNonce;\n\nvar DID_METHOD_NAME = '3';\nvar STORAGE_KEY = 'serialized3id_';\nvar MUPORT_IPFS = {\n  host: config.muport_ipfs_host,\n  port: config.muport_ipfs_port,\n  protocol: config.muport_ipfs_protocol\n};\nvar POLL_INTERVAL = 500;\n\nvar ThreeId =\n/*#__PURE__*/\nfunction () {\n  function ThreeId(provider, ipfs, keystore) {\n    var opts = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {};\n    (0, _classCallCheck2[\"default\"])(this, ThreeId);\n    this.events = new EventEmitter();\n    this._provider = provider;\n    this._has3idProv = Boolean(opts.has3idProv);\n    this._ipfs = ipfs;\n    this._muportIpfs = opts.muportIpfs || MUPORT_IPFS;\n    this._pubkeys = {\n      spaces: {}\n    };\n    this._keystore = keystore;\n  }\n\n  (0, _createClass2[\"default\"])(ThreeId, [{\n    key: \"startUpdatePolling\",\n    value: function startUpdatePolling() {\n      var _this = this;\n\n      if (this._has3idProv) {\n        var poll =\n        /*#__PURE__*/\n        function () {\n          var _ref = (0, _asyncToGenerator2[\"default\"])(\n          /*#__PURE__*/\n          _regenerator[\"default\"].mark(function _callee(method, event) {\n            var result;\n            return _regenerator[\"default\"].wrap(function _callee$(_context) {\n              while (1) {\n                switch (_context.prev = _context.next) {\n                  case 0:\n                    _context.next = 2;\n                    return utils.callRpc(_this._provider, method);\n\n                  case 2:\n                    result = _context.sent;\n                    result.map(function (data) {\n                      _this.events.emit(event, data);\n                    });\n\n                  case 4:\n                  case \"end\":\n                    return _context.stop();\n                }\n              }\n            }, _callee);\n          }));\n\n          return function poll(_x, _x2) {\n            return _ref.apply(this, arguments);\n          };\n        }();\n\n        setInterval(function () {\n          poll('3id_newAuthMethodPoll', 'new-auth-method');\n          poll('3id_newLinkPoll', 'new-link-proof');\n        }, POLL_INTERVAL);\n      }\n    }\n  }, {\n    key: \"signJWT\",\n    value: function () {\n      var _signJWT = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee2(payload) {\n        var _ref2,\n            space,\n            expiresIn,\n            issuer,\n            keyring,\n            settings,\n            _args2 = arguments;\n\n        return _regenerator[\"default\"].wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _ref2 = _args2.length > 1 && _args2[1] !== undefined ? _args2[1] : {}, space = _ref2.space, expiresIn = _ref2.expiresIn;\n                issuer = this.DID;\n\n                if (space) {\n                  issuer = this._subDIDs[space];\n                }\n\n                if (!this._has3idProv) {\n                  _context2.next = 7;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\", utils.callRpc(this._provider, '3id_signClaim', {\n                  payload: payload,\n                  did: issuer,\n                  space: space,\n                  expiresIn: expiresIn\n                }));\n\n              case 7:\n                keyring = this._keyringBySpace(space);\n                settings = {\n                  signer: keyring.getJWTSigner(),\n                  issuer: issuer,\n                  expiresIn: expiresIn\n                };\n                return _context2.abrupt(\"return\", didJWT.createJWT(payload, settings));\n\n              case 10:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function signJWT(_x3) {\n        return _signJWT.apply(this, arguments);\n      }\n\n      return signJWT;\n    }()\n  }, {\n    key: \"getSubDID\",\n    value: function getSubDID(space) {\n      return this._subDIDs[space];\n    }\n  }, {\n    key: \"getOdbId\",\n    value: function () {\n      var _getOdbId = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee3(space) {\n        return _regenerator[\"default\"].wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                return _context3.abrupt(\"return\", Identities.createIdentity({\n                  type: '3ID',\n                  threeId: this,\n                  space: space,\n                  keystore: this._keystore\n                }));\n\n              case 1:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function getOdbId(_x4) {\n        return _getOdbId.apply(this, arguments);\n      }\n\n      return getOdbId;\n    }()\n  }, {\n    key: \"serializeState\",\n    value: function serializeState() {\n      var _this2 = this;\n\n      if (this._has3idProv) throw new Error('Can not serializeState of IdentityWallet');\n      var stateObj = {\n        managementAddress: this.managementAddress,\n        seed: this._mainKeyring.serialize(),\n        spaceSeeds: {}\n      };\n      Object.keys(this._keyrings).map(function (name) {\n        stateObj.spaceSeeds[name] = _this2._keyrings[name].serialize();\n      });\n      return JSON.stringify(stateObj);\n    }\n  }, {\n    key: \"_initKeys\",\n    value: function _initKeys(serializedState) {\n      var _this3 = this;\n\n      if (this._has3idProv) throw new Error('Can not initKeys of IdentityWallet');\n      this._keyrings = {};\n      var state = JSON.parse(serializedState); // TODO remove toLowerCase() in future, should be sanitized elsewhere\n      //      this forces existing state to correct state so that address <->\n      //      rootstore relation holds\n\n      this.managementAddress = state.managementAddress.toLowerCase();\n      this._mainKeyring = new Keyring(state.seed);\n      Object.keys(state.spaceSeeds).map(function (name) {\n        _this3._keyrings[name] = new Keyring(state.spaceSeeds[name]);\n      });\n      localstorage.set(STORAGE_KEY + this.managementAddress, this.serializeState());\n    }\n  }, {\n    key: \"_initDID\",\n    value: function () {\n      var _initDID2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee4() {\n        var _this4 = this;\n\n        var muportPromise, spaces, subDIDs;\n        return _regenerator[\"default\"].wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                muportPromise = this._initMuport();\n                _context4.next = 3;\n                return this._init3ID();\n\n              case 3:\n                this._rootDID = _context4.sent;\n\n                if (this._has3idProv) {\n                  spaces = Object.keys(this._pubkeys.spaces);\n                } else {\n                  spaces = Object.keys(this._keyrings);\n                }\n\n                _context4.next = 7;\n                return Promise.all(spaces.map(function (space) {\n                  return _this4._init3ID(space);\n                }));\n\n              case 7:\n                subDIDs = _context4.sent;\n                this._subDIDs = {};\n                spaces.map(function (space, i) {\n                  _this4._subDIDs[space] = subDIDs[i];\n                });\n                _context4.next = 12;\n                return muportPromise;\n\n              case 12:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function _initDID() {\n        return _initDID2.apply(this, arguments);\n      }\n\n      return _initDID;\n    }()\n  }, {\n    key: \"_init3ID\",\n    value: function () {\n      var _init3ID2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee5(spaceName) {\n        var doc, pubkeys, payload, signature;\n        return _regenerator[\"default\"].wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                doc = new DidDocument(this._ipfs, DID_METHOD_NAME);\n                _context5.next = 3;\n                return this.getPublicKeys(spaceName, true);\n\n              case 3:\n                pubkeys = _context5.sent;\n\n                if (spaceName) {\n                  _context5.next = 11;\n                  break;\n                }\n\n                doc.addPublicKey('signingKey', 'Secp256k1VerificationKey2018', 'publicKeyHex', pubkeys.signingKey);\n                doc.addPublicKey('encryptionKey', 'Curve25519EncryptionPublicKey', 'publicKeyBase64', pubkeys.asymEncryptionKey);\n                doc.addPublicKey('managementKey', 'Secp256k1VerificationKey2018', 'ethereumAddress', pubkeys.managementKey);\n                doc.addAuthentication('Secp256k1SignatureAuthentication2018', 'signingKey');\n                _context5.next = 21;\n                break;\n\n              case 11:\n                doc.addPublicKey('subSigningKey', 'Secp256k1VerificationKey2018', 'publicKeyHex', pubkeys.signingKey);\n                doc.addPublicKey('subEncryptionKey', 'Curve25519EncryptionPublicKey', 'publicKeyBase64', pubkeys.asymEncryptionKey);\n                doc.addAuthentication('Secp256k1SignatureAuthentication2018', 'subSigningKey');\n                doc.addCustomProperty('space', spaceName);\n                doc.addCustomProperty('root', this.DID);\n                payload = {\n                  subSigningKey: pubkeys.signingKey,\n                  subEncryptionKey: pubkeys.asymEncryptionKey,\n                  space: spaceName,\n                  iat: null\n                };\n                _context5.next = 19;\n                return this.signJWT(payload, {\n                  use3ID: true\n                });\n\n              case 19:\n                signature = _context5.sent.split('.')[2];\n                doc.addCustomProperty('proof', {\n                  alg: 'ES256K',\n                  signature: signature\n                });\n\n              case 21:\n                _context5.next = 23;\n                return doc.commit({\n                  noTimestamp: true\n                });\n\n              case 23:\n                return _context5.abrupt(\"return\", doc.DID);\n\n              case 24:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function _init3ID(_x5) {\n        return _init3ID2.apply(this, arguments);\n      }\n\n      return _init3ID;\n    }()\n  }, {\n    key: \"_initMuport\",\n    value: function () {\n      var _initMuport2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee6() {\n        var keys, doc, docHash;\n        return _regenerator[\"default\"].wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                _context6.next = 2;\n                return this.getPublicKeys(null);\n\n              case 2:\n                keys = _context6.sent;\n                doc = createMuportDocument(keys.signingKey, keys.managementKey, keys.asymEncryptionKey);\n                _context6.next = 6;\n                return this._ipfs.add(Buffer.from(JSON.stringify(doc)));\n\n              case 6:\n                docHash = _context6.sent[0].hash;\n                this._muportDID = 'did:muport:' + docHash;\n                this.muportFingerprint = utils.sha256Multihash(this.muportDID);\n\n              case 9:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this);\n      }));\n\n      function _initMuport() {\n        return _initMuport2.apply(this, arguments);\n      }\n\n      return _initMuport;\n    }()\n  }, {\n    key: \"getAddress\",\n    value: function () {\n      var _getAddress = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee7() {\n        return _regenerator[\"default\"].wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                if (!this._has3idProv) {\n                  _context7.next = 4;\n                  break;\n                }\n\n                return _context7.abrupt(\"return\", utils.callRpc(this._provider, '3id_getLink'));\n\n              case 4:\n                return _context7.abrupt(\"return\", this.managementAddress);\n\n              case 5:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this);\n      }));\n\n      function getAddress() {\n        return _getAddress.apply(this, arguments);\n      }\n\n      return getAddress;\n    }()\n  }, {\n    key: \"authenticate\",\n    value: function () {\n      var _authenticate = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee8(spaces) {\n        var opts,\n            pubkeys,\n            _iteratorNormalCompletion,\n            _didIteratorError,\n            _iteratorError,\n            _iterator,\n            _step,\n            space,\n            _iteratorNormalCompletion2,\n            _didIteratorError2,\n            _iteratorError2,\n            _iterator2,\n            _step2,\n            _space,\n            _args8 = arguments;\n\n        return _regenerator[\"default\"].wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                opts = _args8.length > 1 && _args8[1] !== undefined ? _args8[1] : {};\n                spaces = spaces || [];\n\n                if (!this._has3idProv) {\n                  _context8.next = 43;\n                  break;\n                }\n\n                _context8.next = 5;\n                return utils.callRpc(this._provider, '3id_authenticate', {\n                  spaces: spaces,\n                  authData: opts.authData\n                });\n\n              case 5:\n                pubkeys = _context8.sent;\n                this._pubkeys.main = pubkeys.main;\n                this._pubkeys.spaces = Object.assign(this._pubkeys.spaces, pubkeys.spaces);\n\n                if (this.DID) {\n                  _context8.next = 13;\n                  break;\n                }\n\n                _context8.next = 11;\n                return this._initDID();\n\n              case 11:\n                _context8.next = 41;\n                break;\n\n              case 13:\n                _iteratorNormalCompletion = true;\n                _didIteratorError = false;\n                _iteratorError = undefined;\n                _context8.prev = 16;\n                _iterator = spaces[Symbol.iterator]();\n\n              case 18:\n                if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {\n                  _context8.next = 27;\n                  break;\n                }\n\n                space = _step.value;\n\n                if (this._subDIDs[space]) {\n                  _context8.next = 24;\n                  break;\n                }\n\n                _context8.next = 23;\n                return this._init3ID(space);\n\n              case 23:\n                this._subDIDs[space] = _context8.sent;\n\n              case 24:\n                _iteratorNormalCompletion = true;\n                _context8.next = 18;\n                break;\n\n              case 27:\n                _context8.next = 33;\n                break;\n\n              case 29:\n                _context8.prev = 29;\n                _context8.t0 = _context8[\"catch\"](16);\n                _didIteratorError = true;\n                _iteratorError = _context8.t0;\n\n              case 33:\n                _context8.prev = 33;\n                _context8.prev = 34;\n\n                if (!_iteratorNormalCompletion && _iterator[\"return\"] != null) {\n                  _iterator[\"return\"]();\n                }\n\n              case 36:\n                _context8.prev = 36;\n\n                if (!_didIteratorError) {\n                  _context8.next = 39;\n                  break;\n                }\n\n                throw _iteratorError;\n\n              case 39:\n                return _context8.finish(36);\n\n              case 40:\n                return _context8.finish(33);\n\n              case 41:\n                _context8.next = 69;\n                break;\n\n              case 43:\n                _iteratorNormalCompletion2 = true;\n                _didIteratorError2 = false;\n                _iteratorError2 = undefined;\n                _context8.prev = 46;\n                _iterator2 = spaces[Symbol.iterator]();\n\n              case 48:\n                if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {\n                  _context8.next = 55;\n                  break;\n                }\n\n                _space = _step2.value;\n                _context8.next = 52;\n                return this._initKeyringByName(_space);\n\n              case 52:\n                _iteratorNormalCompletion2 = true;\n                _context8.next = 48;\n                break;\n\n              case 55:\n                _context8.next = 61;\n                break;\n\n              case 57:\n                _context8.prev = 57;\n                _context8.t1 = _context8[\"catch\"](46);\n                _didIteratorError2 = true;\n                _iteratorError2 = _context8.t1;\n\n              case 61:\n                _context8.prev = 61;\n                _context8.prev = 62;\n\n                if (!_iteratorNormalCompletion2 && _iterator2[\"return\"] != null) {\n                  _iterator2[\"return\"]();\n                }\n\n              case 64:\n                _context8.prev = 64;\n\n                if (!_didIteratorError2) {\n                  _context8.next = 67;\n                  break;\n                }\n\n                throw _iteratorError2;\n\n              case 67:\n                return _context8.finish(64);\n\n              case 68:\n                return _context8.finish(61);\n\n              case 69:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8, this, [[16, 29, 33, 41], [34,, 36, 40], [46, 57, 61, 69], [62,, 64, 68]]);\n      }));\n\n      function authenticate(_x6) {\n        return _authenticate.apply(this, arguments);\n      }\n\n      return authenticate;\n    }()\n  }, {\n    key: \"isAuthenticated\",\n    value: function () {\n      var _isAuthenticated = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee9() {\n        var _this5 = this;\n\n        var spaces,\n            _args9 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee9$(_context9) {\n          while (1) {\n            switch (_context9.prev = _context9.next) {\n              case 0:\n                spaces = _args9.length > 0 && _args9[0] !== undefined ? _args9[0] : [];\n                return _context9.abrupt(\"return\", spaces.reduce(function (acc, space) {\n                  return acc && Object.keys(_this5._subDIDs).includes(space);\n                }, true));\n\n              case 2:\n              case \"end\":\n                return _context9.stop();\n            }\n          }\n        }, _callee9);\n      }));\n\n      function isAuthenticated() {\n        return _isAuthenticated.apply(this, arguments);\n      }\n\n      return isAuthenticated;\n    }()\n  }, {\n    key: \"_initKeyringByName\",\n    value: function () {\n      var _initKeyringByName2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee10(name) {\n        var sig, entropy, seed;\n        return _regenerator[\"default\"].wrap(function _callee10$(_context10) {\n          while (1) {\n            switch (_context10.prev = _context10.next) {\n              case 0:\n                if (!this._has3idProv) {\n                  _context10.next = 2;\n                  break;\n                }\n\n                throw new Error('Can not initKeyringByName of IdentityWallet');\n\n              case 2:\n                if (this._keyrings[name]) {\n                  _context10.next = 16;\n                  break;\n                }\n\n                _context10.next = 5;\n                return utils.openSpaceConsent(this.managementAddress, this._provider, name);\n\n              case 5:\n                sig = _context10.sent;\n                entropy = '0x' + utils.sha256(sig.slice(2));\n                seed = mnemonicToSeed(entropyToMnemonic(entropy));\n                this._keyrings[name] = new Keyring(seed);\n                _context10.next = 11;\n                return this._init3ID(name);\n\n              case 11:\n                this._subDIDs[name] = _context10.sent;\n                localstorage.set(STORAGE_KEY + this.managementAddress, this.serializeState());\n                return _context10.abrupt(\"return\", true);\n\n              case 16:\n                return _context10.abrupt(\"return\", false);\n\n              case 17:\n              case \"end\":\n                return _context10.stop();\n            }\n          }\n        }, _callee10, this);\n      }));\n\n      function _initKeyringByName(_x7) {\n        return _initKeyringByName2.apply(this, arguments);\n      }\n\n      return _initKeyringByName;\n    }()\n  }, {\n    key: \"getPublicKeys\",\n    value: function () {\n      var _getPublicKeys = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee11(space, uncompressed) {\n        var pubkeys;\n        return _regenerator[\"default\"].wrap(function _callee11$(_context11) {\n          while (1) {\n            switch (_context11.prev = _context11.next) {\n              case 0:\n                if (this._has3idProv) {\n                  pubkeys = Object.assign({}, space ? this._pubkeys.spaces[space] : this._pubkeys.main);\n\n                  if (uncompressed) {\n                    pubkeys.signingKey = Keyring.uncompress(pubkeys.signingKey);\n                  }\n                } else {\n                  pubkeys = this._keyringBySpace(space).getPublicKeys(uncompressed);\n                  pubkeys.managementKey = this.managementAddress;\n                }\n\n                return _context11.abrupt(\"return\", pubkeys);\n\n              case 2:\n              case \"end\":\n                return _context11.stop();\n            }\n          }\n        }, _callee11, this);\n      }));\n\n      function getPublicKeys(_x8, _x9) {\n        return _getPublicKeys.apply(this, arguments);\n      }\n\n      return getPublicKeys;\n    }()\n  }, {\n    key: \"encrypt\",\n    value: function () {\n      var _encrypt = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee12(message, space, to) {\n        var keyring, paddedMsg;\n        return _regenerator[\"default\"].wrap(function _callee12$(_context12) {\n          while (1) {\n            switch (_context12.prev = _context12.next) {\n              case 0:\n                if (!this._has3idProv) {\n                  _context12.next = 4;\n                  break;\n                }\n\n                return _context12.abrupt(\"return\", utils.callRpc(this._provider, '3id_encrypt', {\n                  message: message,\n                  space: space,\n                  to: to\n                }));\n\n              case 4:\n                keyring = this._keyringBySpace(space);\n                paddedMsg = typeof message === 'string' ? utils.pad(message) : message;\n\n                if (!to) {\n                  _context12.next = 10;\n                  break;\n                }\n\n                return _context12.abrupt(\"return\", keyring.asymEncrypt(paddedMsg, to));\n\n              case 10:\n                return _context12.abrupt(\"return\", keyring.symEncrypt(paddedMsg));\n\n              case 11:\n              case \"end\":\n                return _context12.stop();\n            }\n          }\n        }, _callee12, this);\n      }));\n\n      function encrypt(_x10, _x11, _x12) {\n        return _encrypt.apply(this, arguments);\n      }\n\n      return encrypt;\n    }()\n  }, {\n    key: \"decrypt\",\n    value: function () {\n      var _decrypt = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee13(encObj, space, toBuffer) {\n        var keyring, paddedMsg;\n        return _regenerator[\"default\"].wrap(function _callee13$(_context13) {\n          while (1) {\n            switch (_context13.prev = _context13.next) {\n              case 0:\n                if (!this._has3idProv) {\n                  _context13.next = 4;\n                  break;\n                }\n\n                return _context13.abrupt(\"return\", utils.callRpc(this._provider, '3id_decrypt', _objectSpread({}, encObj, {\n                  space: space\n                })));\n\n              case 4:\n                keyring = this._keyringBySpace(space);\n\n                if (encObj.ephemeralFrom) {\n                  paddedMsg = keyring.asymDecrypt(encObj.ciphertext, encObj.ephemeralFrom, encObj.nonce, toBuffer);\n                } else {\n                  paddedMsg = keyring.symDecrypt(encObj.ciphertext, encObj.nonce, toBuffer);\n                }\n\n                return _context13.abrupt(\"return\", toBuffer ? paddedMsg : utils.unpad(paddedMsg));\n\n              case 7:\n              case \"end\":\n                return _context13.stop();\n            }\n          }\n        }, _callee13, this);\n      }));\n\n      function decrypt(_x13, _x14, _x15) {\n        return _decrypt.apply(this, arguments);\n      }\n\n      return decrypt;\n    }()\n  }, {\n    key: \"hashDBKey\",\n    value: function () {\n      var _hashDBKey = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee14(key, space) {\n        var salt;\n        return _regenerator[\"default\"].wrap(function _callee14$(_context14) {\n          while (1) {\n            switch (_context14.prev = _context14.next) {\n              case 0:\n                if (!this._has3idProv) {\n                  _context14.next = 4;\n                  break;\n                }\n\n                return _context14.abrupt(\"return\", utils.callRpc(this._provider, '3id_hashEntryKey', {\n                  key: key,\n                  space: space\n                }));\n\n              case 4:\n                salt = this._keyringBySpace(space).getDBSalt();\n                return _context14.abrupt(\"return\", utils.sha256Multihash(salt + key));\n\n              case 6:\n              case \"end\":\n                return _context14.stop();\n            }\n          }\n        }, _callee14, this);\n      }));\n\n      function hashDBKey(_x16, _x17) {\n        return _hashDBKey.apply(this, arguments);\n      }\n\n      return hashDBKey;\n    }()\n  }, {\n    key: \"_keyringBySpace\",\n    value: function _keyringBySpace(space) {\n      return space ? this._keyrings[space] : this._mainKeyring;\n    }\n  }, {\n    key: \"logout\",\n    value: function logout() {\n      localstorage.remove(STORAGE_KEY + this.managementAddress);\n    }\n  }, {\n    key: \"DID\",\n    get: function get() {\n      return this._rootDID;\n    }\n  }, {\n    key: \"muportDID\",\n    get: function get() {\n      return this._muportDID;\n    }\n  }], [{\n    key: \"isLoggedIn\",\n    value: function isLoggedIn(address) {\n      return Boolean(localstorage.get(STORAGE_KEY + address.toLowerCase()));\n    }\n  }, {\n    key: \"getIdFromEthAddress\",\n    value: function () {\n      var _getIdFromEthAddress = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee15(address, provider, ipfs, keystore) {\n        var opts,\n            normalizedAddress,\n            serialized3id,\n            sig,\n            entropy,\n            mnemonic,\n            seed,\n            threeId,\n            _args15 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee15$(_context15) {\n          while (1) {\n            switch (_context15.prev = _context15.next) {\n              case 0:\n                opts = _args15.length > 4 && _args15[4] !== undefined ? _args15[4] : {};\n                opts.has3idProv = Boolean(provider.is3idProvider);\n\n                if (!opts.has3idProv) {\n                  _context15.next = 6;\n                  break;\n                }\n\n                return _context15.abrupt(\"return\", new ThreeId(provider, ipfs, keystore, opts));\n\n              case 6:\n                normalizedAddress = address.toLowerCase();\n                serialized3id = localstorage.get(STORAGE_KEY + normalizedAddress);\n\n                if (!serialized3id) {\n                  _context15.next = 12;\n                  break;\n                }\n\n                if (opts.consentCallback) opts.consentCallback(false);\n                _context15.next = 24;\n                break;\n\n              case 12:\n                if (!opts.contentSignature) {\n                  _context15.next = 16;\n                  break;\n                }\n\n                sig = opts.contentSignature;\n                _context15.next = 19;\n                break;\n\n              case 16:\n                _context15.next = 18;\n                return utils.openBoxConsent(normalizedAddress, provider);\n\n              case 18:\n                sig = _context15.sent;\n\n              case 19:\n                if (opts.consentCallback) opts.consentCallback(true);\n                entropy = '0x' + utils.sha256(sig.slice(2));\n                mnemonic = entropyToMnemonic(entropy);\n                seed = mnemonicToSeed(mnemonic);\n                serialized3id = JSON.stringify({\n                  managementAddress: normalizedAddress,\n                  seed: seed,\n                  spaceSeeds: {}\n                });\n\n              case 24:\n                threeId = new ThreeId(provider, ipfs, keystore, opts);\n\n                threeId._initKeys(serialized3id);\n\n                _context15.next = 28;\n                return threeId._initDID();\n\n              case 28:\n                return _context15.abrupt(\"return\", threeId);\n\n              case 29:\n              case \"end\":\n                return _context15.stop();\n            }\n          }\n        }, _callee15);\n      }));\n\n      function getIdFromEthAddress(_x18, _x19, _x20, _x21) {\n        return _getIdFromEthAddress.apply(this, arguments);\n      }\n\n      return getIdFromEthAddress;\n    }()\n  }]);\n  return ThreeId;\n}();\n\nvar createMuportDocument = function createMuportDocument(signingKey, managementKey, asymEncryptionKey) {\n  return {\n    version: 1,\n    signingKey: signingKey,\n    managementKey: managementKey,\n    asymEncryptionKey: asymEncryptionKey\n  };\n};\n\nmodule.exports = ThreeId;"]},"metadata":{},"sourceType":"script"}