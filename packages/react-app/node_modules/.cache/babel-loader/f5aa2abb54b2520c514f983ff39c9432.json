{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _toConsumableArray2 = _interopRequireDefault(require(\"@babel/runtime/helpers/toConsumableArray\"));\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nvar _possibleConstructorReturn2 = _interopRequireDefault(require(\"@babel/runtime/helpers/possibleConstructorReturn\"));\n\nvar _getPrototypeOf2 = _interopRequireDefault(require(\"@babel/runtime/helpers/getPrototypeOf\"));\n\nvar _inherits2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inherits\"));\n\nvar EventEmitter = require('events').EventEmitter;\n\nvar _require = require('did-jwt'),\n    verifyJWT = _require.verifyJWT;\n\nvar Room = require('ipfs-pubsub-room');\n\nvar DEFAULT_BACKLOG_LIMIT = 100;\n\nvar GhostThread = /*#__PURE__*/function (_EventEmitter) {\n  (0, _inherits2[\"default\"])(GhostThread, _EventEmitter);\n\n  function GhostThread(name, _ref) {\n    var _this;\n\n    var ipfs = _ref.ipfs;\n    var opts = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n    (0, _classCallCheck2[\"default\"])(this, GhostThread);\n    _this = (0, _possibleConstructorReturn2[\"default\"])(this, (0, _getPrototypeOf2[\"default\"])(GhostThread).call(this));\n    _this._name = name;\n    _this._spaceName = name.split('.')[2];\n    _this._room = Room(ipfs, name); // instance of ipfs pubsub room\n\n    _this._ipfs = ipfs;\n    _this._peerId = ipfs._peerInfo.id.toB58String();\n    _this._members = {};\n    _this._backlog = new Set(); // set of past messages\n\n    _this._backlogLimit = opts.ghostBacklogLimit || DEFAULT_BACKLOG_LIMIT;\n    _this._filters = opts.ghostFilters || [];\n\n    _this._room.on('message', /*#__PURE__*/function () {\n      var _ref3 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(_ref2) {\n        var from, data, payload, issuer, verified, passesFilters;\n        return _regenerator[\"default\"].wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                from = _ref2.from, data = _ref2.data;\n\n                if (!data.toString().startsWith('{')) {\n                  _context.next = 7;\n                  break;\n                } // we got a non signed message (can only be backlog request, or response)\n\n\n                payload = JSON.parse(data);\n\n                if (!(payload.type !== 'request_backlog' && payload.type !== 'backlog_response')) {\n                  _context.next = 5;\n                  break;\n                }\n\n                return _context.abrupt(\"return\");\n\n              case 5:\n                _context.next = 12;\n                break;\n\n              case 7:\n                _context.next = 9;\n                return _this._verifyData(data);\n\n              case 9:\n                verified = _context.sent;\n                payload = verified.payload;\n                issuer = verified.issuer;\n\n              case 12:\n                // we pass the payload, issuer and peerID (from) to each filter in our filters array and reduce the value to a single boolean\n                // this boolean indicates whether the message passed the filters\n                passesFilters = _this._filters.reduce(function (acc, filter) {\n                  return acc && filter(payload, issuer, from);\n                }, true);\n\n                if (!(payload && passesFilters)) {\n                  _context.next = 25;\n                  break;\n                }\n\n                _context.t0 = payload.type;\n                _context.next = _context.t0 === 'join' ? 17 : _context.t0 === 'request_backlog' ? 19 : _context.t0 === 'backlog_response' ? 21 : 24;\n                break;\n\n              case 17:\n                _this._userJoined(issuer, from);\n\n                return _context.abrupt(\"break\", 25);\n\n              case 19:\n                _this.getPosts(_this._backlogLimit).then(function (posts) {\n                  return _this._sendDirect({\n                    type: 'backlog_response',\n                    message: posts\n                  }, from, true);\n                });\n\n                return _context.abrupt(\"break\", 25);\n\n              case 21:\n                payload.message.map(function (msg) {\n                  _this._backlog.add(JSON.stringify(msg));\n                });\n\n                _this.emit('backlog-received', {\n                  type: 'backlog',\n                  author: issuer,\n                  message: payload.message,\n                  timestamp: payload.iat\n                });\n\n                return _context.abrupt(\"break\", 25);\n\n              case 24:\n                _this._messageReceived(payload);\n\n              case 25:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee);\n      }));\n\n      return function (_x) {\n        return _ref3.apply(this, arguments);\n      };\n    }());\n\n    _this._room.on('peer joined', function (peer) {\n      _this._announce(peer);\n\n      _this._requestBacklog(peer);\n    });\n\n    _this._room.on('peer left', function (peer) {\n      return _this._userLeft(peer);\n    });\n\n    return _this;\n  }\n\n  (0, _createClass2[\"default\"])(GhostThread, [{\n    key: \"_set3id\",\n    value: function _set3id(threeId) {\n      var _this2 = this;\n\n      this._3id = threeId; // announce to other peers that we are online\n\n      this.listMembers().then(function (members) {\n        _this2._room.getPeers().map(function (id) {\n          _this2._announce(id);\n        });\n      });\n    }\n    /**\n     * Get a list of users online\n     *\n     * @return    {Array<String>}      users online\n     */\n\n  }, {\n    key: \"listMembers\",\n    value: function () {\n      var _listMembers = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee2() {\n        return _regenerator[\"default\"].wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                return _context2.abrupt(\"return\", Object.keys(this._members).filter(function (id) {\n                  return !id.startsWith('Qm');\n                }));\n\n              case 1:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function listMembers() {\n        return _listMembers.apply(this, arguments);\n      }\n\n      return listMembers;\n    }()\n    /**\n     * Get a peerId's corresponding 3ID\n     *\n     * @param     {String}      did               The DID of the user\n     * @return    {String}      ipfs peer id\n     */\n\n  }, {\n    key: \"_threeIdToPeerId\",\n    value: function _threeIdToPeerId(did) {\n      return this._members[did];\n    }\n    /**\n     * Get backlog of all past messages\n     *\n     * @return    {Array<Object>}      users online\n     */\n\n  }, {\n    key: \"getPosts\",\n    value: function () {\n      var _getPosts = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee3() {\n        var num,\n            posts,\n            _args3 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                num = _args3.length > 0 && _args3[0] !== undefined ? _args3[0] : 0;\n                posts = (0, _toConsumableArray2[\"default\"])(this._backlog).map(function (msg) {\n                  return JSON.parse(msg);\n                }).sort(function (p1, p2) {\n                  return p1.timestamp - p2.timestamp;\n                }).slice(-num);\n                return _context3.abrupt(\"return\", posts);\n\n              case 3:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function getPosts() {\n        return _getPosts.apply(this, arguments);\n      }\n\n      return getPosts;\n    }()\n    /**\n     * Announce entry in chat and share our 3id and peerID\n     *\n     * @param     {String}      to              The PeerID of a user (optional)\n     */\n\n  }, {\n    key: \"_announce\",\n    value: function () {\n      var _announce2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee4(to) {\n        return _regenerator[\"default\"].wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                if (!this._3id) {\n                  _context4.next = 8;\n                  break;\n                }\n\n                if (to) {\n                  _context4.next = 6;\n                  break;\n                }\n\n                _context4.next = 4;\n                return this._broadcast({\n                  type: 'join'\n                });\n\n              case 4:\n                _context4.next = 8;\n                break;\n\n              case 6:\n                _context4.next = 8;\n                return this._sendDirect({\n                  type: 'join'\n                }, to);\n\n              case 8:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function _announce(_x2) {\n        return _announce2.apply(this, arguments);\n      }\n\n      return _announce;\n    }()\n    /**\n     * Post a message to the thread\n     *\n     * @param     {Object}    message                 The message\n     * @param     {String}    to                      PeerID to send the message to (optional)\n     */\n\n  }, {\n    key: \"post\",\n    value: function () {\n      var _post = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee5(message, to) {\n        return _regenerator[\"default\"].wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                if (to) {\n                  _context5.next = 5;\n                  break;\n                }\n\n                _context5.next = 3;\n                return this._broadcast({\n                  type: 'chat',\n                  message: message\n                });\n\n              case 3:\n                _context5.next = 7;\n                break;\n\n              case 5:\n                _context5.next = 7;\n                return this._sendDirect({\n                  type: 'chat',\n                  message: message\n                }, to);\n\n              case 7:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function post(_x3, _x4) {\n        return _post.apply(this, arguments);\n      }\n\n      return post;\n    }()\n  }, {\n    key: \"deletePost\",\n    value: function () {\n      var _deletePost = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee6(hash) {\n        return _regenerator[\"default\"].wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                throw new Error('Not possible to delete post in Ghost Thread');\n\n              case 1:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6);\n      }));\n\n      function deletePost(_x5) {\n        return _deletePost.apply(this, arguments);\n      }\n\n      return deletePost;\n    }()\n  }, {\n    key: \"addModerator\",\n    value: function () {\n      var _addModerator = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee7(id) {\n        return _regenerator[\"default\"].wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                throw new Error('Not possible to add moderator in Ghost Thread');\n\n              case 1:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7);\n      }));\n\n      function addModerator(_x6) {\n        return _addModerator.apply(this, arguments);\n      }\n\n      return addModerator;\n    }()\n  }, {\n    key: \"listModerators\",\n    value: function () {\n      var _listModerators = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee8() {\n        return _regenerator[\"default\"].wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                throw new Error('Not possible to list moderators in Ghost Thread');\n\n              case 1:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8);\n      }));\n\n      function listModerators() {\n        return _listModerators.apply(this, arguments);\n      }\n\n      return listModerators;\n    }()\n  }, {\n    key: \"addMember\",\n    value: function () {\n      var _addMember = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee9(id) {\n        return _regenerator[\"default\"].wrap(function _callee9$(_context9) {\n          while (1) {\n            switch (_context9.prev = _context9.next) {\n              case 0:\n                throw new Error('Not possible to add member in Ghost Thread');\n\n              case 1:\n              case \"end\":\n                return _context9.stop();\n            }\n          }\n        }, _callee9);\n      }));\n\n      function addMember(_x7) {\n        return _addMember.apply(this, arguments);\n      }\n\n      return addMember;\n    }()\n    /**\n     * Request a backlog of past messages from peers in the chat\n     *\n     * @param     {String}      to              The PeerID of a user (optional)\n     */\n\n  }, {\n    key: \"_requestBacklog\",\n    value: function () {\n      var _requestBacklog2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee10(to) {\n        return _regenerator[\"default\"].wrap(function _callee10$(_context10) {\n          while (1) {\n            switch (_context10.prev = _context10.next) {\n              case 0:\n                if (to) {\n                  _context10.next = 5;\n                  break;\n                }\n\n                _context10.next = 3;\n                return this._broadcast({\n                  type: 'request_backlog'\n                });\n\n              case 3:\n                _context10.next = 7;\n                break;\n\n              case 5:\n                _context10.next = 7;\n                return this._sendDirect({\n                  type: 'request_backlog'\n                }, to, true);\n\n              case 7:\n              case \"end\":\n                return _context10.stop();\n            }\n          }\n        }, _callee10, this);\n      }));\n\n      function _requestBacklog(_x8) {\n        return _requestBacklog2.apply(this, arguments);\n      }\n\n      return _requestBacklog;\n    }()\n    /**\n     * Leave the chat\n     *\n     */\n\n  }, {\n    key: \"close\",\n    value: function () {\n      var _close = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee11() {\n        return _regenerator[\"default\"].wrap(function _callee11$(_context11) {\n          while (1) {\n            switch (_context11.prev = _context11.next) {\n              case 0:\n                _context11.next = 2;\n                return this._room.leave();\n\n              case 2:\n              case \"end\":\n                return _context11.stop();\n            }\n          }\n        }, _callee11, this);\n      }));\n\n      function close() {\n        return _close.apply(this, arguments);\n      }\n\n      return close;\n    }()\n    /**\n     * Broadcast a message to peers in the room\n     *\n     * @param     {Object}    message                 The message\n     */\n\n  }, {\n    key: \"_broadcast\",\n    value: function () {\n      var _broadcast2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee12(message, noSignature) {\n        var payload;\n        return _regenerator[\"default\"].wrap(function _callee12$(_context12) {\n          while (1) {\n            switch (_context12.prev = _context12.next) {\n              case 0:\n                if (!(!this._3id ? !noSignature : false)) {\n                  _context12.next = 2;\n                  break;\n                }\n\n                throw new Error('Can not send message if not authenticated');\n\n              case 2:\n                if (!noSignature) {\n                  _context12.next = 6;\n                  break;\n                }\n\n                _context12.t0 = JSON.stringify(message);\n                _context12.next = 9;\n                break;\n\n              case 6:\n                _context12.next = 8;\n                return this._3id.signJWT(message);\n\n              case 8:\n                _context12.t0 = _context12.sent;\n\n              case 9:\n                payload = _context12.t0;\n\n                this._room.broadcast(payload);\n\n              case 11:\n              case \"end\":\n                return _context12.stop();\n            }\n          }\n        }, _callee12, this);\n      }));\n\n      function _broadcast(_x9, _x10) {\n        return _broadcast2.apply(this, arguments);\n      }\n\n      return _broadcast;\n    }()\n    /**\n     * Send a direct message to a peer\n     *\n     * @param     {Object}    message             The message\n     * @param     {String}    to                  The PeerID or 3ID of the receiver\n     */\n\n  }, {\n    key: \"_sendDirect\",\n    value: function () {\n      var _sendDirect2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee13(message, to, noSignature) {\n        var payload;\n        return _regenerator[\"default\"].wrap(function _callee13$(_context13) {\n          while (1) {\n            switch (_context13.prev = _context13.next) {\n              case 0:\n                if (!(!this._3id ? !noSignature : false)) {\n                  _context13.next = 2;\n                  break;\n                }\n\n                throw new Error('Can not send message if not authenticated');\n\n              case 2:\n                if (!noSignature) {\n                  _context13.next = 6;\n                  break;\n                }\n\n                _context13.t0 = JSON.stringify(message);\n                _context13.next = 9;\n                break;\n\n              case 6:\n                _context13.next = 8;\n                return this._3id.signJWT(message);\n\n              case 8:\n                _context13.t0 = _context13.sent;\n\n              case 9:\n                payload = _context13.t0;\n                to.startsWith('Qm') ? this._room.sendTo(to, payload) : this._room.sendTo(this._threeIdToPeerId(to), payload);\n\n              case 11:\n              case \"end\":\n                return _context13.stop();\n            }\n          }\n        }, _callee13, this);\n      }));\n\n      function _sendDirect(_x11, _x12, _x13) {\n        return _sendDirect2.apply(this, arguments);\n      }\n\n      return _sendDirect;\n    }()\n    /**\n     * Register a function to be called after new updates\n     * have been received from the network or locally.\n     *\n     * @param     {Function}  updateFn               The function that will get called\n     */\n\n  }, {\n    key: \"onUpdate\",\n    value: function onUpdate(updateFn) {\n      this.removeAllListeners('message');\n      this.removeAllListeners('backlog-received');\n      this.on('message', updateFn);\n      this.on('backlog-received', updateFn);\n    }\n    /**\n     * Register a function to be called after new capabilities\n     * have been received from the network or locally.\n     *\n     * @param     {Function}  updateFn               The function that will get called\n     */\n\n  }, {\n    key: \"onNewCapabilities\",\n    value: function onNewCapabilities(updateFn) {\n      this.removeAllListeners('user-joined');\n      this.removeAllListeners('user-left');\n      this.on('user-joined', updateFn);\n      this.on('user-left', updateFn);\n    }\n    /**\n     * Handler function for users joining\n     *\n     * @param     {String}    did                The DID of the user\n     * @param     {Object}    peerID             The peerID of the user\n     */\n\n  }, {\n    key: \"_userJoined\",\n    value: function () {\n      var _userJoined2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee14(did, peerID) {\n        var members;\n        return _regenerator[\"default\"].wrap(function _callee14$(_context14) {\n          while (1) {\n            switch (_context14.prev = _context14.next) {\n              case 0:\n                _context14.next = 2;\n                return this.listMembers();\n\n              case 2:\n                members = _context14.sent;\n\n                if (!members.includes(did) && (!this._3id || this._3id.DID !== did)) {\n                  this._members[did] = peerID;\n                  this._members[peerID] = did;\n                  this.emit('user-joined', 'joined', did, peerID);\n                }\n\n              case 4:\n              case \"end\":\n                return _context14.stop();\n            }\n          }\n        }, _callee14, this);\n      }));\n\n      function _userJoined(_x14, _x15) {\n        return _userJoined2.apply(this, arguments);\n      }\n\n      return _userJoined;\n    }()\n    /**\n     * Handler function for users leaving\n     *\n     * @param     {String}    peerID              The peerID of the user\n     */\n\n  }, {\n    key: \"_userLeft\",\n    value: function () {\n      var _userLeft2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee15(peerID) {\n        var did;\n        return _regenerator[\"default\"].wrap(function _callee15$(_context15) {\n          while (1) {\n            switch (_context15.prev = _context15.next) {\n              case 0:\n                did = this._members[peerID];\n                delete this._members[did];\n                delete this._members[peerID];\n                this.emit('user-left', 'left', did, peerID);\n\n              case 4:\n              case \"end\":\n                return _context15.stop();\n            }\n          }\n        }, _callee15, this);\n      }));\n\n      function _userLeft(_x16) {\n        return _userLeft2.apply(this, arguments);\n      }\n\n      return _userLeft;\n    }()\n    /**\n     * Handler function for received messages\n     *\n     * @param     {String}    issuer              The issuer of the message\n     * @param     {Object}    payload             The payload of the message\n     */\n\n  }, {\n    key: \"_messageReceived\",\n    value: function () {\n      var _messageReceived2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee16(payload) {\n        var type, message, author, timestamp, postId;\n        return _regenerator[\"default\"].wrap(function _callee16$(_context16) {\n          while (1) {\n            switch (_context16.prev = _context16.next) {\n              case 0:\n                type = payload.type, message = payload.message, author = payload.iss, timestamp = payload.iat, postId = payload.postId;\n\n                this._backlog.add(JSON.stringify({\n                  type: type,\n                  author: author,\n                  message: message,\n                  timestamp: timestamp,\n                  postId: postId\n                }));\n\n                this.emit('message', {\n                  type: type,\n                  author: author,\n                  message: message,\n                  timestamp: timestamp,\n                  postId: postId\n                });\n\n              case 3:\n              case \"end\":\n                return _context16.stop();\n            }\n          }\n        }, _callee16, this);\n      }));\n\n      function _messageReceived(_x17) {\n        return _messageReceived2.apply(this, arguments);\n      }\n\n      return _messageReceived;\n    }()\n    /**\n     * Verifies the data received\n     *\n     * @param     {Buffer}    data                A buffer of the jwt\n     * @return    {JWT}                           A verified JWT with our payload and issuer\n     */\n\n  }, {\n    key: \"_verifyData\",\n    value: function () {\n      var _verifyData2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee17(data) {\n        var jwt, cidPromise, verified;\n        return _regenerator[\"default\"].wrap(function _callee17$(_context17) {\n          while (1) {\n            switch (_context17.prev = _context17.next) {\n              case 0:\n                jwt = data.toString();\n                cidPromise = this._ipfs.dag.put(jwt);\n                _context17.prev = 2;\n                _context17.next = 5;\n                return verifyJWT(jwt);\n\n              case 5:\n                verified = _context17.sent;\n                _context17.next = 8;\n                return cidPromise;\n\n              case 8:\n                verified.payload.postId = _context17.sent.toString();\n                return _context17.abrupt(\"return\", verified);\n\n              case 12:\n                _context17.prev = 12;\n                _context17.t0 = _context17[\"catch\"](2);\n                console.log(_context17.t0);\n\n              case 15:\n              case \"end\":\n                return _context17.stop();\n            }\n          }\n        }, _callee17, this, [[2, 12]]);\n      }));\n\n      function _verifyData(_x18) {\n        return _verifyData2.apply(this, arguments);\n      }\n\n      return _verifyData;\n    }()\n  }, {\n    key: \"isGhost\",\n    get: function get() {\n      return true;\n    }\n  }]);\n  return GhostThread;\n}(EventEmitter);\n\nmodule.exports = GhostThread;","map":{"version":3,"sources":["/home/samkuhlmann/Documents/ody/moloch/moloch-dao-badges/node_modules/3box/lib/ghost.js"],"names":["_interopRequireDefault","require","_toConsumableArray2","_regenerator","_asyncToGenerator2","_classCallCheck2","_createClass2","_possibleConstructorReturn2","_getPrototypeOf2","_inherits2","EventEmitter","_require","verifyJWT","Room","DEFAULT_BACKLOG_LIMIT","GhostThread","_EventEmitter","name","_ref","_this","ipfs","opts","arguments","length","undefined","call","_name","_spaceName","split","_room","_ipfs","_peerId","_peerInfo","id","toB58String","_members","_backlog","Set","_backlogLimit","ghostBacklogLimit","_filters","ghostFilters","on","_ref3","mark","_callee","_ref2","from","data","payload","issuer","verified","passesFilters","wrap","_callee$","_context","prev","next","toString","startsWith","JSON","parse","type","abrupt","_verifyData","sent","reduce","acc","filter","t0","_userJoined","getPosts","then","posts","_sendDirect","message","map","msg","add","stringify","emit","author","timestamp","iat","_messageReceived","stop","_x","apply","peer","_announce","_requestBacklog","_userLeft","key","value","_set3id","threeId","_this2","_3id","listMembers","members","getPeers","_listMembers","_callee2","_callee2$","_context2","Object","keys","_threeIdToPeerId","did","_getPosts","_callee3","num","_args3","_callee3$","_context3","sort","p1","p2","slice","_announce2","_callee4","to","_callee4$","_context4","_broadcast","_x2","_post","_callee5","_callee5$","_context5","post","_x3","_x4","_deletePost","_callee6","hash","_callee6$","_context6","Error","deletePost","_x5","_addModerator","_callee7","_callee7$","_context7","addModerator","_x6","_listModerators","_callee8","_callee8$","_context8","listModerators","_addMember","_callee9","_callee9$","_context9","addMember","_x7","_requestBacklog2","_callee10","_callee10$","_context10","_x8","_close","_callee11","_callee11$","_context11","leave","close","_broadcast2","_callee12","noSignature","_callee12$","_context12","signJWT","broadcast","_x9","_x10","_sendDirect2","_callee13","_callee13$","_context13","sendTo","_x11","_x12","_x13","onUpdate","updateFn","removeAllListeners","onNewCapabilities","_userJoined2","_callee14","peerID","_callee14$","_context14","includes","DID","_x14","_x15","_userLeft2","_callee15","_callee15$","_context15","_x16","_messageReceived2","_callee16","postId","_callee16$","_context16","iss","_x17","_verifyData2","_callee17","jwt","cidPromise","_callee17$","_context17","dag","put","console","log","_x18","get","module","exports"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _toConsumableArray2 = _interopRequireDefault(require(\"@babel/runtime/helpers/toConsumableArray\"));\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nvar _possibleConstructorReturn2 = _interopRequireDefault(require(\"@babel/runtime/helpers/possibleConstructorReturn\"));\n\nvar _getPrototypeOf2 = _interopRequireDefault(require(\"@babel/runtime/helpers/getPrototypeOf\"));\n\nvar _inherits2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inherits\"));\n\nvar EventEmitter = require('events').EventEmitter;\n\nvar _require = require('did-jwt'),\n    verifyJWT = _require.verifyJWT;\n\nvar Room = require('ipfs-pubsub-room');\n\nvar DEFAULT_BACKLOG_LIMIT = 100;\n\nvar GhostThread =\n/*#__PURE__*/\nfunction (_EventEmitter) {\n  (0, _inherits2[\"default\"])(GhostThread, _EventEmitter);\n\n  function GhostThread(name, _ref) {\n    var _this;\n\n    var ipfs = _ref.ipfs;\n    var opts = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n    (0, _classCallCheck2[\"default\"])(this, GhostThread);\n    _this = (0, _possibleConstructorReturn2[\"default\"])(this, (0, _getPrototypeOf2[\"default\"])(GhostThread).call(this));\n    _this._name = name;\n    _this._spaceName = name.split('.')[2];\n    _this._room = Room(ipfs, name); // instance of ipfs pubsub room\n\n    _this._ipfs = ipfs;\n    _this._peerId = ipfs._peerInfo.id.toB58String();\n    _this._members = {};\n    _this._backlog = new Set(); // set of past messages\n\n    _this._backlogLimit = opts.ghostBacklogLimit || DEFAULT_BACKLOG_LIMIT;\n    _this._filters = opts.ghostFilters || [];\n\n    _this._room.on('message',\n    /*#__PURE__*/\n    function () {\n      var _ref3 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee(_ref2) {\n        var from, data, payload, issuer, verified, passesFilters;\n        return _regenerator[\"default\"].wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                from = _ref2.from, data = _ref2.data;\n\n                if (!data.toString().startsWith('{')) {\n                  _context.next = 7;\n                  break;\n                }\n\n                // we got a non signed message (can only be backlog request, or response)\n                payload = JSON.parse(data);\n\n                if (!(payload.type !== 'request_backlog' && payload.type !== 'backlog_response')) {\n                  _context.next = 5;\n                  break;\n                }\n\n                return _context.abrupt(\"return\");\n\n              case 5:\n                _context.next = 12;\n                break;\n\n              case 7:\n                _context.next = 9;\n                return _this._verifyData(data);\n\n              case 9:\n                verified = _context.sent;\n                payload = verified.payload;\n                issuer = verified.issuer;\n\n              case 12:\n                // we pass the payload, issuer and peerID (from) to each filter in our filters array and reduce the value to a single boolean\n                // this boolean indicates whether the message passed the filters\n                passesFilters = _this._filters.reduce(function (acc, filter) {\n                  return acc && filter(payload, issuer, from);\n                }, true);\n\n                if (!(payload && passesFilters)) {\n                  _context.next = 25;\n                  break;\n                }\n\n                _context.t0 = payload.type;\n                _context.next = _context.t0 === 'join' ? 17 : _context.t0 === 'request_backlog' ? 19 : _context.t0 === 'backlog_response' ? 21 : 24;\n                break;\n\n              case 17:\n                _this._userJoined(issuer, from);\n\n                return _context.abrupt(\"break\", 25);\n\n              case 19:\n                _this.getPosts(_this._backlogLimit).then(function (posts) {\n                  return _this._sendDirect({\n                    type: 'backlog_response',\n                    message: posts\n                  }, from, true);\n                });\n\n                return _context.abrupt(\"break\", 25);\n\n              case 21:\n                payload.message.map(function (msg) {\n                  _this._backlog.add(JSON.stringify(msg));\n                });\n\n                _this.emit('backlog-received', {\n                  type: 'backlog',\n                  author: issuer,\n                  message: payload.message,\n                  timestamp: payload.iat\n                });\n\n                return _context.abrupt(\"break\", 25);\n\n              case 24:\n                _this._messageReceived(payload);\n\n              case 25:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee);\n      }));\n\n      return function (_x) {\n        return _ref3.apply(this, arguments);\n      };\n    }());\n\n    _this._room.on('peer joined', function (peer) {\n      _this._announce(peer);\n\n      _this._requestBacklog(peer);\n    });\n\n    _this._room.on('peer left', function (peer) {\n      return _this._userLeft(peer);\n    });\n\n    return _this;\n  }\n\n  (0, _createClass2[\"default\"])(GhostThread, [{\n    key: \"_set3id\",\n    value: function _set3id(threeId) {\n      var _this2 = this;\n\n      this._3id = threeId; // announce to other peers that we are online\n\n      this.listMembers().then(function (members) {\n        _this2._room.getPeers().map(function (id) {\n          _this2._announce(id);\n        });\n      });\n    }\n    /**\n     * Get a list of users online\n     *\n     * @return    {Array<String>}      users online\n     */\n\n  }, {\n    key: \"listMembers\",\n    value: function () {\n      var _listMembers = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee2() {\n        return _regenerator[\"default\"].wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                return _context2.abrupt(\"return\", Object.keys(this._members).filter(function (id) {\n                  return !id.startsWith('Qm');\n                }));\n\n              case 1:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function listMembers() {\n        return _listMembers.apply(this, arguments);\n      }\n\n      return listMembers;\n    }()\n    /**\n     * Get a peerId's corresponding 3ID\n     *\n     * @param     {String}      did               The DID of the user\n     * @return    {String}      ipfs peer id\n     */\n\n  }, {\n    key: \"_threeIdToPeerId\",\n    value: function _threeIdToPeerId(did) {\n      return this._members[did];\n    }\n    /**\n     * Get backlog of all past messages\n     *\n     * @return    {Array<Object>}      users online\n     */\n\n  }, {\n    key: \"getPosts\",\n    value: function () {\n      var _getPosts = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee3() {\n        var num,\n            posts,\n            _args3 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                num = _args3.length > 0 && _args3[0] !== undefined ? _args3[0] : 0;\n                posts = (0, _toConsumableArray2[\"default\"])(this._backlog).map(function (msg) {\n                  return JSON.parse(msg);\n                }).sort(function (p1, p2) {\n                  return p1.timestamp - p2.timestamp;\n                }).slice(-num);\n                return _context3.abrupt(\"return\", posts);\n\n              case 3:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function getPosts() {\n        return _getPosts.apply(this, arguments);\n      }\n\n      return getPosts;\n    }()\n    /**\n     * Announce entry in chat and share our 3id and peerID\n     *\n     * @param     {String}      to              The PeerID of a user (optional)\n     */\n\n  }, {\n    key: \"_announce\",\n    value: function () {\n      var _announce2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee4(to) {\n        return _regenerator[\"default\"].wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                if (!this._3id) {\n                  _context4.next = 8;\n                  break;\n                }\n\n                if (to) {\n                  _context4.next = 6;\n                  break;\n                }\n\n                _context4.next = 4;\n                return this._broadcast({\n                  type: 'join'\n                });\n\n              case 4:\n                _context4.next = 8;\n                break;\n\n              case 6:\n                _context4.next = 8;\n                return this._sendDirect({\n                  type: 'join'\n                }, to);\n\n              case 8:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function _announce(_x2) {\n        return _announce2.apply(this, arguments);\n      }\n\n      return _announce;\n    }()\n    /**\n     * Post a message to the thread\n     *\n     * @param     {Object}    message                 The message\n     * @param     {String}    to                      PeerID to send the message to (optional)\n     */\n\n  }, {\n    key: \"post\",\n    value: function () {\n      var _post = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee5(message, to) {\n        return _regenerator[\"default\"].wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                if (to) {\n                  _context5.next = 5;\n                  break;\n                }\n\n                _context5.next = 3;\n                return this._broadcast({\n                  type: 'chat',\n                  message: message\n                });\n\n              case 3:\n                _context5.next = 7;\n                break;\n\n              case 5:\n                _context5.next = 7;\n                return this._sendDirect({\n                  type: 'chat',\n                  message: message\n                }, to);\n\n              case 7:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function post(_x3, _x4) {\n        return _post.apply(this, arguments);\n      }\n\n      return post;\n    }()\n  }, {\n    key: \"deletePost\",\n    value: function () {\n      var _deletePost = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee6(hash) {\n        return _regenerator[\"default\"].wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                throw new Error('Not possible to delete post in Ghost Thread');\n\n              case 1:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6);\n      }));\n\n      function deletePost(_x5) {\n        return _deletePost.apply(this, arguments);\n      }\n\n      return deletePost;\n    }()\n  }, {\n    key: \"addModerator\",\n    value: function () {\n      var _addModerator = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee7(id) {\n        return _regenerator[\"default\"].wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                throw new Error('Not possible to add moderator in Ghost Thread');\n\n              case 1:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7);\n      }));\n\n      function addModerator(_x6) {\n        return _addModerator.apply(this, arguments);\n      }\n\n      return addModerator;\n    }()\n  }, {\n    key: \"listModerators\",\n    value: function () {\n      var _listModerators = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee8() {\n        return _regenerator[\"default\"].wrap(function _callee8$(_context8) {\n          while (1) {\n            switch (_context8.prev = _context8.next) {\n              case 0:\n                throw new Error('Not possible to list moderators in Ghost Thread');\n\n              case 1:\n              case \"end\":\n                return _context8.stop();\n            }\n          }\n        }, _callee8);\n      }));\n\n      function listModerators() {\n        return _listModerators.apply(this, arguments);\n      }\n\n      return listModerators;\n    }()\n  }, {\n    key: \"addMember\",\n    value: function () {\n      var _addMember = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee9(id) {\n        return _regenerator[\"default\"].wrap(function _callee9$(_context9) {\n          while (1) {\n            switch (_context9.prev = _context9.next) {\n              case 0:\n                throw new Error('Not possible to add member in Ghost Thread');\n\n              case 1:\n              case \"end\":\n                return _context9.stop();\n            }\n          }\n        }, _callee9);\n      }));\n\n      function addMember(_x7) {\n        return _addMember.apply(this, arguments);\n      }\n\n      return addMember;\n    }()\n    /**\n     * Request a backlog of past messages from peers in the chat\n     *\n     * @param     {String}      to              The PeerID of a user (optional)\n     */\n\n  }, {\n    key: \"_requestBacklog\",\n    value: function () {\n      var _requestBacklog2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee10(to) {\n        return _regenerator[\"default\"].wrap(function _callee10$(_context10) {\n          while (1) {\n            switch (_context10.prev = _context10.next) {\n              case 0:\n                if (to) {\n                  _context10.next = 5;\n                  break;\n                }\n\n                _context10.next = 3;\n                return this._broadcast({\n                  type: 'request_backlog'\n                });\n\n              case 3:\n                _context10.next = 7;\n                break;\n\n              case 5:\n                _context10.next = 7;\n                return this._sendDirect({\n                  type: 'request_backlog'\n                }, to, true);\n\n              case 7:\n              case \"end\":\n                return _context10.stop();\n            }\n          }\n        }, _callee10, this);\n      }));\n\n      function _requestBacklog(_x8) {\n        return _requestBacklog2.apply(this, arguments);\n      }\n\n      return _requestBacklog;\n    }()\n    /**\n     * Leave the chat\n     *\n     */\n\n  }, {\n    key: \"close\",\n    value: function () {\n      var _close = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee11() {\n        return _regenerator[\"default\"].wrap(function _callee11$(_context11) {\n          while (1) {\n            switch (_context11.prev = _context11.next) {\n              case 0:\n                _context11.next = 2;\n                return this._room.leave();\n\n              case 2:\n              case \"end\":\n                return _context11.stop();\n            }\n          }\n        }, _callee11, this);\n      }));\n\n      function close() {\n        return _close.apply(this, arguments);\n      }\n\n      return close;\n    }()\n    /**\n     * Broadcast a message to peers in the room\n     *\n     * @param     {Object}    message                 The message\n     */\n\n  }, {\n    key: \"_broadcast\",\n    value: function () {\n      var _broadcast2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee12(message, noSignature) {\n        var payload;\n        return _regenerator[\"default\"].wrap(function _callee12$(_context12) {\n          while (1) {\n            switch (_context12.prev = _context12.next) {\n              case 0:\n                if (!(!this._3id ? !noSignature : false)) {\n                  _context12.next = 2;\n                  break;\n                }\n\n                throw new Error('Can not send message if not authenticated');\n\n              case 2:\n                if (!noSignature) {\n                  _context12.next = 6;\n                  break;\n                }\n\n                _context12.t0 = JSON.stringify(message);\n                _context12.next = 9;\n                break;\n\n              case 6:\n                _context12.next = 8;\n                return this._3id.signJWT(message);\n\n              case 8:\n                _context12.t0 = _context12.sent;\n\n              case 9:\n                payload = _context12.t0;\n\n                this._room.broadcast(payload);\n\n              case 11:\n              case \"end\":\n                return _context12.stop();\n            }\n          }\n        }, _callee12, this);\n      }));\n\n      function _broadcast(_x9, _x10) {\n        return _broadcast2.apply(this, arguments);\n      }\n\n      return _broadcast;\n    }()\n    /**\n     * Send a direct message to a peer\n     *\n     * @param     {Object}    message             The message\n     * @param     {String}    to                  The PeerID or 3ID of the receiver\n     */\n\n  }, {\n    key: \"_sendDirect\",\n    value: function () {\n      var _sendDirect2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee13(message, to, noSignature) {\n        var payload;\n        return _regenerator[\"default\"].wrap(function _callee13$(_context13) {\n          while (1) {\n            switch (_context13.prev = _context13.next) {\n              case 0:\n                if (!(!this._3id ? !noSignature : false)) {\n                  _context13.next = 2;\n                  break;\n                }\n\n                throw new Error('Can not send message if not authenticated');\n\n              case 2:\n                if (!noSignature) {\n                  _context13.next = 6;\n                  break;\n                }\n\n                _context13.t0 = JSON.stringify(message);\n                _context13.next = 9;\n                break;\n\n              case 6:\n                _context13.next = 8;\n                return this._3id.signJWT(message);\n\n              case 8:\n                _context13.t0 = _context13.sent;\n\n              case 9:\n                payload = _context13.t0;\n                to.startsWith('Qm') ? this._room.sendTo(to, payload) : this._room.sendTo(this._threeIdToPeerId(to), payload);\n\n              case 11:\n              case \"end\":\n                return _context13.stop();\n            }\n          }\n        }, _callee13, this);\n      }));\n\n      function _sendDirect(_x11, _x12, _x13) {\n        return _sendDirect2.apply(this, arguments);\n      }\n\n      return _sendDirect;\n    }()\n    /**\n     * Register a function to be called after new updates\n     * have been received from the network or locally.\n     *\n     * @param     {Function}  updateFn               The function that will get called\n     */\n\n  }, {\n    key: \"onUpdate\",\n    value: function onUpdate(updateFn) {\n      this.removeAllListeners('message');\n      this.removeAllListeners('backlog-received');\n      this.on('message', updateFn);\n      this.on('backlog-received', updateFn);\n    }\n    /**\n     * Register a function to be called after new capabilities\n     * have been received from the network or locally.\n     *\n     * @param     {Function}  updateFn               The function that will get called\n     */\n\n  }, {\n    key: \"onNewCapabilities\",\n    value: function onNewCapabilities(updateFn) {\n      this.removeAllListeners('user-joined');\n      this.removeAllListeners('user-left');\n      this.on('user-joined', updateFn);\n      this.on('user-left', updateFn);\n    }\n    /**\n     * Handler function for users joining\n     *\n     * @param     {String}    did                The DID of the user\n     * @param     {Object}    peerID             The peerID of the user\n     */\n\n  }, {\n    key: \"_userJoined\",\n    value: function () {\n      var _userJoined2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee14(did, peerID) {\n        var members;\n        return _regenerator[\"default\"].wrap(function _callee14$(_context14) {\n          while (1) {\n            switch (_context14.prev = _context14.next) {\n              case 0:\n                _context14.next = 2;\n                return this.listMembers();\n\n              case 2:\n                members = _context14.sent;\n\n                if (!members.includes(did) && (!this._3id || this._3id.DID !== did)) {\n                  this._members[did] = peerID;\n                  this._members[peerID] = did;\n                  this.emit('user-joined', 'joined', did, peerID);\n                }\n\n              case 4:\n              case \"end\":\n                return _context14.stop();\n            }\n          }\n        }, _callee14, this);\n      }));\n\n      function _userJoined(_x14, _x15) {\n        return _userJoined2.apply(this, arguments);\n      }\n\n      return _userJoined;\n    }()\n    /**\n     * Handler function for users leaving\n     *\n     * @param     {String}    peerID              The peerID of the user\n     */\n\n  }, {\n    key: \"_userLeft\",\n    value: function () {\n      var _userLeft2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee15(peerID) {\n        var did;\n        return _regenerator[\"default\"].wrap(function _callee15$(_context15) {\n          while (1) {\n            switch (_context15.prev = _context15.next) {\n              case 0:\n                did = this._members[peerID];\n                delete this._members[did];\n                delete this._members[peerID];\n                this.emit('user-left', 'left', did, peerID);\n\n              case 4:\n              case \"end\":\n                return _context15.stop();\n            }\n          }\n        }, _callee15, this);\n      }));\n\n      function _userLeft(_x16) {\n        return _userLeft2.apply(this, arguments);\n      }\n\n      return _userLeft;\n    }()\n    /**\n     * Handler function for received messages\n     *\n     * @param     {String}    issuer              The issuer of the message\n     * @param     {Object}    payload             The payload of the message\n     */\n\n  }, {\n    key: \"_messageReceived\",\n    value: function () {\n      var _messageReceived2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee16(payload) {\n        var type, message, author, timestamp, postId;\n        return _regenerator[\"default\"].wrap(function _callee16$(_context16) {\n          while (1) {\n            switch (_context16.prev = _context16.next) {\n              case 0:\n                type = payload.type, message = payload.message, author = payload.iss, timestamp = payload.iat, postId = payload.postId;\n\n                this._backlog.add(JSON.stringify({\n                  type: type,\n                  author: author,\n                  message: message,\n                  timestamp: timestamp,\n                  postId: postId\n                }));\n\n                this.emit('message', {\n                  type: type,\n                  author: author,\n                  message: message,\n                  timestamp: timestamp,\n                  postId: postId\n                });\n\n              case 3:\n              case \"end\":\n                return _context16.stop();\n            }\n          }\n        }, _callee16, this);\n      }));\n\n      function _messageReceived(_x17) {\n        return _messageReceived2.apply(this, arguments);\n      }\n\n      return _messageReceived;\n    }()\n    /**\n     * Verifies the data received\n     *\n     * @param     {Buffer}    data                A buffer of the jwt\n     * @return    {JWT}                           A verified JWT with our payload and issuer\n     */\n\n  }, {\n    key: \"_verifyData\",\n    value: function () {\n      var _verifyData2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee17(data) {\n        var jwt, cidPromise, verified;\n        return _regenerator[\"default\"].wrap(function _callee17$(_context17) {\n          while (1) {\n            switch (_context17.prev = _context17.next) {\n              case 0:\n                jwt = data.toString();\n                cidPromise = this._ipfs.dag.put(jwt);\n                _context17.prev = 2;\n                _context17.next = 5;\n                return verifyJWT(jwt);\n\n              case 5:\n                verified = _context17.sent;\n                _context17.next = 8;\n                return cidPromise;\n\n              case 8:\n                verified.payload.postId = _context17.sent.toString();\n                return _context17.abrupt(\"return\", verified);\n\n              case 12:\n                _context17.prev = 12;\n                _context17.t0 = _context17[\"catch\"](2);\n                console.log(_context17.t0);\n\n              case 15:\n              case \"end\":\n                return _context17.stop();\n            }\n          }\n        }, _callee17, this, [[2, 12]]);\n      }));\n\n      function _verifyData(_x18) {\n        return _verifyData2.apply(this, arguments);\n      }\n\n      return _verifyData;\n    }()\n  }, {\n    key: \"isGhost\",\n    get: function get() {\n      return true;\n    }\n  }]);\n  return GhostThread;\n}(EventEmitter);\n\nmodule.exports = GhostThread;"]},"metadata":{},"sourceType":"script"}