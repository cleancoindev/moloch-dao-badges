{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nvar _possibleConstructorReturn2 = _interopRequireDefault(require(\"@babel/runtime/helpers/possibleConstructorReturn\"));\n\nvar _getPrototypeOf2 = _interopRequireDefault(require(\"@babel/runtime/helpers/getPrototypeOf\"));\n\nvar _assertThisInitialized2 = _interopRequireDefault(require(\"@babel/runtime/helpers/assertThisInitialized\"));\n\nvar _inherits2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inherits\"));\n\nvar localstorage = require('store');\n\nvar IPFS = require('ipfs');\n\nvar registerResolver = require('3id-resolver');\n\nvar _require = require('3id-blockchain-utils'),\n    createLink = _require.createLink,\n    validateLink = _require.validateLink;\n\nvar ThreeId = require('./3id');\n\nvar Replicator = require('./replicator');\n\nvar PublicStore = require('./publicStore');\n\nvar PrivateStore = require('./privateStore');\n\nvar Verified = require('./verified');\n\nvar Space = require('./space');\n\nvar utils = require('./utils/index');\n\nvar idUtils = require('./utils/id');\n\nvar config = require('./config.js');\n\nvar BoxApi = require('./api');\n\nvar IPFSRepo = require('ipfs-repo');\n\nvar LevelStore = require('datastore-level');\n\nvar didJWT = require('did-jwt');\n\nvar PINNING_NODE = config.pinning_node;\nvar ADDRESS_SERVER_URL = config.address_server_url;\nvar IPFS_OPTIONS = config.ipfs_options;\nvar globalIPFS, globalIPFSPromise; // , ipfsProxy, cacheProxy, iframeLoadedPromise\n\n/*\nif (typeof window !== 'undefined' && typeof document !== 'undefined') {\n  const iframe = document.createElement('iframe')\n  iframe.src = IFRAME_STORE_URL\n  iframe.style = 'width:0; height:0; border:0; border:none !important'\n\n  iframeLoadedPromise = new Promise((resolve, reject) => {\n    iframe.onload = () => { resolve() }\n  })\n\n  document.body.appendChild(iframe)\n  // Create proxy clients that talks to the iframe\n  const postMessage = iframe.contentWindow.postMessage.bind(iframe.contentWindow)\n  ipfsProxy = createProxyClient({ postMessage })\n  cacheProxy = OrbitDBCacheProxy({ postMessage })\n} */\n\n/**\n * @extends BoxApi\n */\n\nvar Box = /*#__PURE__*/function (_BoxApi) {\n  (0, _inherits2[\"default\"])(Box, _BoxApi);\n  /**\n   * Please use the **openBox** method to instantiate a 3Box\n   * @constructor\n   */\n\n  function Box(provider, ipfs) {\n    var _this;\n\n    var opts = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n    (0, _classCallCheck2[\"default\"])(this, Box);\n    _this = (0, _possibleConstructorReturn2[\"default\"])(this, (0, _getPrototypeOf2[\"default\"])(Box).call(this));\n    _this._provider = provider;\n    _this._ipfs = ipfs;\n    registerResolver(_this._ipfs, {\n      pin: true\n    });\n    _this._serverUrl = opts.addressServer || ADDRESS_SERVER_URL;\n    /**\n     * @property {KeyValueStore} public         access the profile store of the users 3Box\n     */\n\n    _this[\"public\"] = null;\n    /**\n     * @property {KeyValueStore} private        access the private store of the users 3Box\n     */\n\n    _this[\"private\"] = null;\n    /**\n     * @property {Verified} verified        check and create verifications\n     */\n\n    _this.verified = new Verified((0, _assertThisInitialized2[\"default\"])(_this));\n    /**\n     * @property {Object} spaces            an object containing all open spaces indexed by their name.\n     */\n\n    _this.spaces = {};\n    /**\n     * @property {Promise} syncDone         A promise that is resolved when the box is synced\n     */\n\n    _this.syncDone = null;\n    _this.hasPublishedLink = {};\n    return _this;\n  }\n\n  (0, _createClass2[\"default\"])(Box, [{\n    key: \"_init\",\n    value: function () {\n      var _init2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(opts) {\n        return _regenerator[\"default\"].wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return Replicator.create(this._ipfs, opts);\n\n              case 2:\n                this.replicator = _context.sent;\n\n              case 3:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function _init(_x) {\n        return _init2.apply(this, arguments);\n      }\n\n      return _init;\n    }()\n  }, {\n    key: \"_load\",\n    value: function () {\n      var _load2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee2() {\n        var _this2 = this;\n\n        var opts,\n            address,\n            _ref,\n            rootStoreAddress,\n            did,\n            authData,\n            rootstoreName,\n            key,\n            _args2 = arguments;\n\n        return _regenerator[\"default\"].wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                opts = _args2.length > 0 && _args2[0] !== undefined ? _args2[0] : {};\n                _context2.next = 3;\n                return this._3id.getAddress();\n\n              case 3:\n                address = _context2.sent;\n\n                if (!address) {\n                  _context2.next = 10;\n                  break;\n                }\n\n                _context2.next = 7;\n                return this._getLinkedData(address);\n\n              case 7:\n                _context2.t0 = _context2.sent;\n                _context2.next = 11;\n                break;\n\n              case 10:\n                _context2.t0 = {};\n\n              case 11:\n                _ref = _context2.t0;\n                rootStoreAddress = _ref.rootStoreAddress;\n                did = _ref.did;\n\n                if (!rootStoreAddress) {\n                  _context2.next = 26;\n                  break;\n                }\n\n                _context2.next = 17;\n                return this.replicator.start(rootStoreAddress, did, {\n                  profile: true\n                });\n\n              case 17:\n                _context2.next = 19;\n                return this.replicator.rootstoreSyncDone;\n\n              case 19:\n                _context2.next = 21;\n                return this.replicator.getAuthData();\n\n              case 21:\n                authData = _context2.sent;\n                _context2.next = 24;\n                return this._3id.authenticate(opts.spaces, {\n                  authData: authData\n                });\n\n              case 24:\n                _context2.next = 35;\n                break;\n\n              case 26:\n                _context2.next = 28;\n                return this._3id.authenticate(opts.spaces);\n\n              case 28:\n                rootstoreName = this._3id.muportFingerprint + '.root';\n                _context2.next = 31;\n                return this._3id.getPublicKeys(null, true);\n\n              case 31:\n                key = _context2.sent.signingKey;\n                _context2.next = 34;\n                return this.replicator[\"new\"](rootstoreName, key, this._3id.DID);\n\n              case 34:\n                this._publishRootStore(this.replicator.rootstore.address.toString());\n\n              case 35:\n                _context2.t1 = this.replicator.rootstore;\n                _context2.next = 38;\n                return this._3id.getOdbId();\n\n              case 38:\n                _context2.t2 = _context2.sent;\n\n                _context2.t1.setIdentity.call(_context2.t1, _context2.t2);\n\n                this.syncDone = this.replicator.syncDone;\n\n                this._3id.events.on('new-auth-method', function (authData) {\n                  _this2._writeRootstoreEntry(Replicator.entryTypes.AUTH_DATA, authData);\n                });\n\n                this._3id.events.on('new-link-proof', function (proof) {\n                  _this2._writeAddressLink(proof);\n                });\n\n                this._3id.startUpdatePolling();\n\n                this[\"public\"] = new PublicStore(this._3id.muportFingerprint + '.public', this._linkProfile.bind(this), this.replicator, this._3id);\n                this[\"private\"] = new PrivateStore(this._3id.muportFingerprint + '.private', this.replicator, this._3id);\n                _context2.next = 48;\n                return this[\"public\"]._load();\n\n              case 48:\n                _context2.next = 50;\n                return this[\"private\"]._load();\n\n              case 50:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function _load() {\n        return _load2.apply(this, arguments);\n      }\n\n      return _load;\n    }()\n    /**\n     * Creates an instance of 3Box\n     *\n     * @param     {provider}          provider                A 3ID provider, or ethereum provider\n     * @param     {Object}            opts                    Optional parameters\n     * @param     {String}            opts.pinningNode        A string with an ipfs multi-address to a 3box pinning node\n     * @param     {Object}            opts.ipfs               A js-ipfs ipfs object\n     * @param     {String}            opts.addressServer      URL of the Address Server\n     * @return    {Box}                                       the 3Box session instance\n     */\n\n  }, {\n    key: \"auth\",\n\n    /**\n     * Authenticate the user\n     *\n     * @param     {Array<String>}     spaces                  A list of spaces to authenticate (optional)\n     * @param     {Object}            opts                    Optional parameters\n     * @param     {String}            opts.address            An ethereum address\n     * @param     {Function}          opts.consentCallback    A function that will be called when the user has consented to opening the box\n     */\n    value: function () {\n      var _auth = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee4() {\n        var _this3 = this;\n\n        var spaces,\n            opts,\n            _args4 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                spaces = _args4.length > 0 && _args4[0] !== undefined ? _args4[0] : [];\n                opts = _args4.length > 1 && _args4[1] !== undefined ? _args4[1] : {};\n\n                if (this._3id) {\n                  _context4.next = 12;\n                  break;\n                }\n\n                if (!(!this._provider.is3idProvider && !opts.address)) {\n                  _context4.next = 5;\n                  break;\n                }\n\n                throw new Error('auth: address needed when 3ID provider is not used');\n\n              case 5:\n                _context4.next = 7;\n                return ThreeId.getIdFromEthAddress(opts.address, this._provider, this._ipfs, this.replicator._orbitdb.keystore, opts);\n\n              case 7:\n                this._3id = _context4.sent;\n                _context4.next = 10;\n                return this._load(Object.assign(opts, {\n                  spaces: spaces\n                }));\n\n              case 10:\n                _context4.next = 14;\n                break;\n\n              case 12:\n                _context4.next = 14;\n                return this._3id.authenticate(spaces);\n\n              case 14:\n                _context4.next = 16;\n                return Promise.all(spaces.map( /*#__PURE__*/function () {\n                  var _ref2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee3(space) {\n                    return _regenerator[\"default\"].wrap(function _callee3$(_context3) {\n                      while (1) {\n                        switch (_context3.prev = _context3.next) {\n                          case 0:\n                            if (!_this3.spaces[space]) {\n                              _context3.next = 3;\n                              break;\n                            }\n\n                            _context3.next = 3;\n                            return _this3.spaces[space]._authThreads(_this3._3id);\n\n                          case 3:\n                          case \"end\":\n                            return _context3.stop();\n                        }\n                      }\n                    }, _callee3);\n                  }));\n\n                  return function (_x2) {\n                    return _ref2.apply(this, arguments);\n                  };\n                }()));\n\n              case 16:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function auth() {\n        return _auth.apply(this, arguments);\n      }\n\n      return auth;\n    }()\n    /**\n     * Opens the 3Box associated with the given address\n     *\n     * @param     {String}            address                 An ethereum address\n     * @param     {provider}          provider                An ethereum or 3ID provider\n     * @param     {Object}            opts                    Optional parameters\n     * @param     {Function}          opts.consentCallback    A function that will be called when the user has consented to opening the box\n     * @param     {String}            opts.pinningNode        A string with an ipfs multi-address to a 3box pinning node\n     * @param     {Object}            opts.ipfs               A js-ipfs ipfs object\n     * @param     {String}            opts.addressServer      URL of the Address Server\n     * @param     {String}            opts.contentSignature   A signature, provided by a client of 3box using the private keys associated with the given address, of the 3box consent message\n     * @return    {Box}                                       the 3Box instance for the given address\n     */\n\n  }, {\n    key: \"openSpace\",\n\n    /**\n     * Opens the space with the given name in the users 3Box\n     *\n     * @param     {String}            name                    The name of the space\n     * @param     {Object}            opts                    Optional parameters\n     * @param     {Function}          opts.consentCallback    A function that will be called when the user has consented to opening the box\n     * @param     {Function}          opts.onSyncDone         A function that will be called when the space has finished syncing with the pinning node\n     * @return    {Space}                                     the Space instance for the given space name\n     */\n    value: function () {\n      var _openSpace = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee5(name) {\n        var opts,\n            _args5 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                opts = _args5.length > 1 && _args5[1] !== undefined ? _args5[1] : {};\n\n                if (!name.includes('.')) {\n                  _context5.next = 3;\n                  break;\n                }\n\n                throw new Error('Invalid name: character \".\" not allowed');\n\n              case 3:\n                if (this._3id) {\n                  _context5.next = 5;\n                  break;\n                }\n\n                throw new Error('openSpace: auth required');\n\n              case 5:\n                if (!this.spaces[name]) {\n                  this.spaces[name] = new Space(name, this.replicator);\n                }\n\n                if (this.spaces[name].isOpen) {\n                  _context5.next = 26;\n                  break;\n                }\n\n                _context5.prev = 7;\n                _context5.next = 10;\n                return this.spaces[name].open(this._3id, opts);\n\n              case 10:\n                _context5.next = 12;\n                return this.isAddressLinked();\n\n              case 12:\n                if (_context5.sent) {\n                  _context5.next = 14;\n                  break;\n                }\n\n                this.linkAddress();\n\n              case 14:\n                _context5.next = 24;\n                break;\n\n              case 16:\n                _context5.prev = 16;\n                _context5.t0 = _context5[\"catch\"](7);\n                delete this.spaces[name];\n\n                if (!_context5.t0.message.includes('User denied message signature.')) {\n                  _context5.next = 23;\n                  break;\n                }\n\n                throw new Error('User denied space consent.');\n\n              case 23:\n                throw new Error('An error occured while opening space: ', _context5.t0.message);\n\n              case 24:\n                _context5.next = 27;\n                break;\n\n              case 26:\n                if (opts.onSyncDone) {\n                  // since the space is already open we can call onSyncDone directly\n                  opts.onSyncDone();\n                }\n\n              case 27:\n                return _context5.abrupt(\"return\", this.spaces[name]);\n\n              case 28:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this, [[7, 16]]);\n      }));\n\n      function openSpace(_x3) {\n        return _openSpace.apply(this, arguments);\n      }\n\n      return openSpace;\n    }()\n    /**\n     * Open a thread. Use this to start receiving updates\n     *\n     * @param     {String}    space                   The name of the space for this thread\n     * @param     {String}    name                    The name of the thread\n     * @param     {Object}    opts                    Optional parameters\n     * @param     {String}    opts.firstModerator     DID of first moderator of a thread, by default, user is first moderator\n     * @param     {Boolean}   opts.members            join a members only thread, which only members can post in, defaults to open thread\n     * @param     {Boolean}   opts.noAutoSub          Disable auto subscription to the thread when posting to it (default false)\n     * @param     {Boolean}   opts.ghost              Enable ephemeral messaging via Ghost Thread\n     * @param     {Number}    opts.ghostBacklogLimit  The number of posts to maintain in the ghost backlog\n     * @param     {Array<Function>} opts.ghostFilters Array of functions for filtering messages\n     *\n     * @return    {Thread}                  An instance of the thread class for the joined thread\n     */\n\n  }, {\n    key: \"openThread\",\n    value: function () {\n      var _openThread = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee6(space, name, opts) {\n        return _regenerator[\"default\"].wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                if (!this.spaces[space]) {\n                  this.spaces[space] = new Space(space, this.replicator);\n                }\n\n                return _context6.abrupt(\"return\", this.spaces[space].joinThread(name, opts));\n\n              case 2:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this);\n      }));\n\n      function openThread(_x4, _x5, _x6) {\n        return _openThread.apply(this, arguments);\n      }\n\n      return openThread;\n    }()\n    /**\n     * Sets the callback function that will be called once when the box is fully synced.\n     *\n     * @param     {Function}      syncDone        The function that will be called\n     * @return    {Promise}                       A promise that is fulfilled when the box is syned\n     */\n\n  }, {\n    key: \"onSyncDone\",\n    value: function () {\n      var _onSyncDone = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee7(syncDone) {\n        return _regenerator[\"default\"].wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                _context7.next = 2;\n                return this.syncDone;\n\n              case 2:\n                syncDone();\n\n              case 3:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this);\n      }));\n\n      function onSyncDone(_x7) {\n        return _onSyncDone.apply(this, arguments);\n      }\n\n      return onSyncDone;\n    }()\n  }, {\n    key: \"_publishRootStore\",\n    value: function () {\n      var _publishRootStore2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee9(rootStoreAddress) {\n        var _this4 = this;\n\n        var addressToken, publish;\n        return _regenerator[\"default\"].wrap(function _callee9$(_context9) {\n          while (1) {\n            switch (_context9.prev = _context9.next) {\n              case 0:\n                _context9.next = 2;\n                return this._3id.signJWT({\n                  rootStoreAddress: rootStoreAddress\n                });\n\n              case 2:\n                addressToken = _context9.sent; // Store odbAddress on 3box-address-server\n\n                publish = /*#__PURE__*/function () {\n                  var _ref3 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee8(token) {\n                    return _regenerator[\"default\"].wrap(function _callee8$(_context8) {\n                      while (1) {\n                        switch (_context8.prev = _context8.next) {\n                          case 0:\n                            _context8.prev = 0;\n                            _context8.next = 3;\n                            return utils.fetchJson(_this4._serverUrl + '/odbAddress', {\n                              address_token: token\n                            });\n\n                          case 3:\n                            _context8.next = 14;\n                            break;\n\n                          case 5:\n                            _context8.prev = 5;\n                            _context8.t0 = _context8[\"catch\"](0);\n\n                            if (!(_context8.t0.message === 'Invalid JWT')) {\n                              _context8.next = 12;\n                              break;\n                            }\n\n                            _context8.next = 10;\n                            return new Promise(function (resolve) {\n                              return setTimeout(resolve, 300);\n                            });\n\n                          case 10:\n                            _context8.next = 12;\n                            return publish(token);\n\n                          case 12:\n                            if (_context8.t0.statusCode) {\n                              _context8.next = 14;\n                              break;\n                            }\n\n                            throw new Error(_context8.t0);\n\n                          case 14:\n                          case \"end\":\n                            return _context8.stop();\n                        }\n                      }\n                    }, _callee8, null, [[0, 5]]);\n                  }));\n\n                  return function publish(_x9) {\n                    return _ref3.apply(this, arguments);\n                  };\n                }();\n\n                _context9.next = 6;\n                return publish(addressToken);\n\n              case 6:\n                return _context9.abrupt(\"return\", true);\n\n              case 7:\n              case \"end\":\n                return _context9.stop();\n            }\n          }\n        }, _callee9, this);\n      }));\n\n      function _publishRootStore(_x8) {\n        return _publishRootStore2.apply(this, arguments);\n      }\n\n      return _publishRootStore;\n    }()\n  }, {\n    key: \"_getLinkedData\",\n    value: function () {\n      var _getLinkedData2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee10(ethereumAddress) {\n        var _data, rootStoreAddress, did;\n\n        return _regenerator[\"default\"].wrap(function _callee10$(_context10) {\n          while (1) {\n            switch (_context10.prev = _context10.next) {\n              case 0:\n                _context10.prev = 0;\n                _context10.next = 3;\n                return utils.fetchJson(\"\".concat(this._serverUrl, \"/odbAddress/\").concat(ethereumAddress));\n\n              case 3:\n                _data = _context10.sent.data;\n                rootStoreAddress = _data.rootStoreAddress;\n                did = _data.did;\n                return _context10.abrupt(\"return\", {\n                  rootStoreAddress: rootStoreAddress,\n                  did: did\n                });\n\n              case 9:\n                _context10.prev = 9;\n                _context10.t0 = _context10[\"catch\"](0);\n\n                if (!(_context10.t0.statusCode === 404)) {\n                  _context10.next = 13;\n                  break;\n                }\n\n                return _context10.abrupt(\"return\", {});\n\n              case 13:\n                throw new Error('Error while getting rootstore', _context10.t0);\n\n              case 14:\n              case \"end\":\n                return _context10.stop();\n            }\n          }\n        }, _callee10, this, [[0, 9]]);\n      }));\n\n      function _getLinkedData(_x10) {\n        return _getLinkedData2.apply(this, arguments);\n      }\n\n      return _getLinkedData;\n    }()\n    /**\n     * @property {String} DID        the DID of the user\n     */\n\n  }, {\n    key: \"linkAddress\",\n\n    /**\n     * Creates a proof that links an ethereum address to the 3Box account of the user. If given proof, it will simply be added to the root store.\n     *\n     * @param     {Object}    [link]                         Optional link object with type or proof\n     * @param     {Object}    [link.proof]                   Proof object, should follow [spec](https://github.com/3box/3box/blob/master/3IPs/3ip-5.md)\n     */\n    value: function () {\n      var _linkAddress = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee11() {\n        var link,\n            _args11 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee11$(_context11) {\n          while (1) {\n            switch (_context11.prev = _context11.next) {\n              case 0:\n                link = _args11.length > 0 && _args11[0] !== undefined ? _args11[0] : {};\n\n                if (this._3id) {\n                  _context11.next = 3;\n                  break;\n                }\n\n                throw new Error('linkAddress: auth required');\n\n              case 3:\n                if (!link.proof) {\n                  _context11.next = 8;\n                  break;\n                }\n\n                _context11.next = 6;\n                return this._writeAddressLink(link.proof);\n\n              case 6:\n                _context11.next = 10;\n                break;\n\n              case 8:\n                _context11.next = 10;\n                return this._linkProfile();\n\n              case 10:\n              case \"end\":\n                return _context11.stop();\n            }\n          }\n        }, _callee11, this);\n      }));\n\n      function linkAddress() {\n        return _linkAddress.apply(this, arguments);\n      }\n\n      return linkAddress;\n    }()\n    /**\n     * Remove given address link, returns true if successful\n     *\n     * @param     {String}   address      address that is linked\n     */\n\n  }, {\n    key: \"removeAddressLink\",\n    value: function () {\n      var _removeAddressLink = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee12(address) {\n        var linkExist, payload, oneHour, deleteToken;\n        return _regenerator[\"default\"].wrap(function _callee12$(_context12) {\n          while (1) {\n            switch (_context12.prev = _context12.next) {\n              case 0:\n                if (this._3id) {\n                  _context12.next = 2;\n                  break;\n                }\n\n                throw new Error('removeAddressLink: auth required');\n\n              case 2:\n                address = address.toLowerCase();\n                _context12.next = 5;\n                return this.isAddressLinked({\n                  address: address\n                });\n\n              case 5:\n                linkExist = _context12.sent;\n\n                if (linkExist) {\n                  _context12.next = 8;\n                  break;\n                }\n\n                throw new Error('removeAddressLink: link for given address does not exist');\n\n              case 8:\n                payload = {\n                  address: address,\n                  type: 'delete-address-link'\n                };\n                oneHour = 60 * 60;\n                _context12.next = 12;\n                return this._3id.signJWT(payload, {\n                  expiresIn: oneHour\n                });\n\n              case 12:\n                deleteToken = _context12.sent;\n                _context12.prev = 13;\n                _context12.next = 16;\n                return utils.fetchJson(this._serverUrl + '/linkdelete', {\n                  delete_token: deleteToken\n                });\n\n              case 16:\n                _context12.next = 22;\n                break;\n\n              case 18:\n                _context12.prev = 18;\n                _context12.t0 = _context12[\"catch\"](13);\n\n                if (_context12.t0.statusCode) {\n                  _context12.next = 22;\n                  break;\n                }\n\n                throw new Error(_context12.t0);\n\n              case 22:\n                _context12.next = 24;\n                return this._deleteAddressLink(address);\n\n              case 24:\n                return _context12.abrupt(\"return\", true);\n\n              case 25:\n              case \"end\":\n                return _context12.stop();\n            }\n          }\n        }, _callee12, this, [[13, 18]]);\n      }));\n\n      function removeAddressLink(_x11) {\n        return _removeAddressLink.apply(this, arguments);\n      }\n\n      return removeAddressLink;\n    }()\n    /**\n     * Checks if there is a proof that links an external account to the 3Box account of the user. If not params given and any link exists, returns true\n     *\n     * @param     {Object}    [query]            Optional object with address and/or type.\n     * @param     {String}    [query.type]       Does the given type of link exist\n     * @param     {String}    [query.address]    Is the given adressed linked\n     */\n\n  }, {\n    key: \"isAddressLinked\",\n    value: function () {\n      var _isAddressLinked = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee13() {\n        var query,\n            links,\n            linksQuery,\n            _args13 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee13$(_context13) {\n          while (1) {\n            switch (_context13.prev = _context13.next) {\n              case 0:\n                query = _args13.length > 0 && _args13[0] !== undefined ? _args13[0] : {};\n\n                if (this._3id) {\n                  _context13.next = 3;\n                  break;\n                }\n\n                throw new Error('isAddressLinked: auth required');\n\n              case 3:\n                if (query.address) query.address = query.address.toLowerCase();\n                _context13.next = 6;\n                return this._readAddressLinks();\n\n              case 6:\n                links = _context13.sent;\n                linksQuery = links.find(function (link) {\n                  var res = query.address ? link.address.toLowerCase() === query.address : true;\n                  return query.type ? res && link.type === query.type : res;\n                });\n                return _context13.abrupt(\"return\", Boolean(linksQuery));\n\n              case 9:\n              case \"end\":\n                return _context13.stop();\n            }\n          }\n        }, _callee13, this);\n      }));\n\n      function isAddressLinked() {\n        return _isAddressLinked.apply(this, arguments);\n      }\n\n      return isAddressLinked;\n    }()\n    /**\n     * Lists address links associated with this 3Box\n     *\n     * @return    {Array}                        An array of link objects\n     */\n\n  }, {\n    key: \"listAddressLinks\",\n    value: function () {\n      var _listAddressLinks = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee14() {\n        var entries;\n        return _regenerator[\"default\"].wrap(function _callee14$(_context14) {\n          while (1) {\n            switch (_context14.prev = _context14.next) {\n              case 0:\n                if (this._3id) {\n                  _context14.next = 2;\n                  break;\n                }\n\n                throw new Error('listAddressLinks: auth required');\n\n              case 2:\n                _context14.next = 4;\n                return this._readAddressLinks();\n\n              case 4:\n                entries = _context14.sent;\n                return _context14.abrupt(\"return\", entries.reduce(function (list, entry) {\n                  var item = Object.assign({}, entry);\n                  item.linkId = item.entry.hash;\n                  delete item.entry;\n                  list.push(item);\n                  return list;\n                }, []));\n\n              case 6:\n              case \"end\":\n                return _context14.stop();\n            }\n          }\n        }, _callee14, this);\n      }));\n\n      function listAddressLinks() {\n        return _listAddressLinks.apply(this, arguments);\n      }\n\n      return listAddressLinks;\n    }()\n  }, {\n    key: \"_writeAddressLink\",\n    value: function () {\n      var _writeAddressLink2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee15(proof) {\n        var validProof;\n        return _regenerator[\"default\"].wrap(function _callee15$(_context15) {\n          while (1) {\n            switch (_context15.prev = _context15.next) {\n              case 0:\n                _context15.next = 2;\n                return validateLink(proof);\n\n              case 2:\n                validProof = _context15.sent;\n\n                if (validProof) {\n                  _context15.next = 5;\n                  break;\n                }\n\n                throw new Error('tried to write invalid link proof', proof);\n\n              case 5:\n                _context15.next = 7;\n                return this.isAddressLinked({\n                  address: validProof.address\n                });\n\n              case 7:\n                if (!_context15.sent) {\n                  _context15.next = 9;\n                  break;\n                }\n\n                return _context15.abrupt(\"return\", true);\n\n              case 9:\n                _context15.next = 11;\n                return this._writeRootstoreEntry(Replicator.entryTypes.ADDRESS_LINK, proof);\n\n              case 11:\n                _context15.next = 13;\n                return utils.fetchJson(this._serverUrl + '/link', proof);\n\n              case 13:\n              case \"end\":\n                return _context15.stop();\n            }\n          }\n        }, _callee15, this);\n      }));\n\n      function _writeAddressLink(_x12) {\n        return _writeAddressLink2.apply(this, arguments);\n      }\n\n      return _writeAddressLink;\n    }()\n  }, {\n    key: \"_linkProfile\",\n    value: function () {\n      var _linkProfile2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee16() {\n        var address, proof, proofdid, issuer, jwt;\n        return _regenerator[\"default\"].wrap(function _callee16$(_context16) {\n          while (1) {\n            switch (_context16.prev = _context16.next) {\n              case 0:\n                _context16.next = 2;\n                return this._3id.getAddress();\n\n              case 2:\n                address = _context16.sent;\n                _context16.next = 5;\n                return this._readAddressLink(address);\n\n              case 5:\n                proof = _context16.sent;\n\n                if (proof) {\n                  _context16.next = 27;\n                  break;\n                }\n\n                if (this._provider.is3idProvider) {\n                  _context16.next = 25;\n                  break;\n                }\n\n                _context16.prev = 8;\n                _context16.next = 11;\n                return createLink(this._3id.DID, address, this._provider);\n\n              case 11:\n                proof = _context16.sent;\n                _context16.next = 17;\n                break;\n\n              case 14:\n                _context16.prev = 14;\n                _context16.t0 = _context16[\"catch\"](8);\n                throw new Error('Link consent message must be signed before adding data, to link address to store', _context16.t0);\n\n              case 17:\n                _context16.prev = 17;\n                _context16.next = 20;\n                return this._writeAddressLink(proof);\n\n              case 20:\n                _context16.next = 25;\n                break;\n\n              case 22:\n                _context16.prev = 22;\n                _context16.t1 = _context16[\"catch\"](17);\n                throw new Error('An error occured while publishing link:', _context16.t1);\n\n              case 25:\n                _context16.next = 37;\n                break;\n\n              case 27:\n                if (this.hasPublishedLink[proof.signature]) {\n                  _context16.next = 37;\n                  break;\n                } // Don't want to publish on every call to _linkProfile\n\n\n                this.hasPublishedLink[proof.signature] = true;\n                _context16.prev = 29;\n                _context16.next = 32;\n                return utils.fetchJson(this._serverUrl + '/link', proof);\n\n              case 32:\n                _context16.next = 37;\n                break;\n\n              case 34:\n                _context16.prev = 34;\n                _context16.t2 = _context16[\"catch\"](29);\n                throw new Error('An error occured while publishing link:', _context16.t2);\n\n              case 37:\n                _context16.next = 39;\n                return this[\"public\"].get('proof_did');\n\n              case 39:\n                proofdid = _context16.sent;\n\n                if (!proofdid) {\n                  _context16.next = 53;\n                  break;\n                } // if prior muport, re publish with 3id including muport\n\n\n                issuer = didJWT.decodeJWT(proofdid).payload.iss;\n\n                if (!issuer.includes('muport')) {\n                  _context16.next = 51;\n                  break;\n                }\n\n                jwt = {\n                  muport: proofdid\n                };\n                _context16.t3 = this[\"public\"];\n                _context16.next = 47;\n                return this._3id.signJWT(jwt);\n\n              case 47:\n                _context16.t4 = _context16.sent;\n                _context16.t5 = {\n                  noLink: true\n                };\n                _context16.next = 51;\n                return _context16.t3.set.call(_context16.t3, 'proof_did', _context16.t4, _context16.t5);\n\n              case 51:\n                _context16.next = 60;\n                break;\n\n              case 53:\n                _context16.t6 = this[\"public\"];\n                _context16.next = 56;\n                return this._3id.signJWT();\n\n              case 56:\n                _context16.t7 = _context16.sent;\n                _context16.t8 = {\n                  noLink: true\n                };\n                _context16.next = 60;\n                return _context16.t6.set.call(_context16.t6, 'proof_did', _context16.t7, _context16.t8);\n\n              case 60:\n              case \"end\":\n                return _context16.stop();\n            }\n          }\n        }, _callee16, this, [[8, 14], [17, 22], [29, 34]]);\n      }));\n\n      function _linkProfile() {\n        return _linkProfile2.apply(this, arguments);\n      }\n\n      return _linkProfile;\n    }()\n  }, {\n    key: \"_writeRootstoreEntry\",\n    value: function () {\n      var _writeRootstoreEntry2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee18(type, payload) {\n        var _this5 = this;\n\n        var cid, entryExist, entry, prev;\n        return _regenerator[\"default\"].wrap(function _callee18$(_context18) {\n          while (1) {\n            switch (_context18.prev = _context18.next) {\n              case 0:\n                _context18.next = 2;\n                return this._ipfs.dag.put(payload);\n\n              case 2:\n                cid = _context18.sent.toBaseEncodedString();\n                _context18.next = 5;\n                return this._ipfs.pin.add(cid);\n\n              case 5:\n                _context18.next = 7;\n                return this._typeCIDExists(type, cid);\n\n              case 7:\n                entryExist = _context18.sent;\n\n                if (!entryExist) {\n                  _context18.next = 10;\n                  break;\n                }\n\n                return _context18.abrupt(\"return\");\n\n              case 10:\n                entry = {\n                  type: type,\n                  data: cid\n                }; // the below code prevents multiple simultaneous writes,\n                // which orbitdb doesn't support\n\n                prev = this._rootstoreQueue;\n                this._rootstoreQueue = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee17() {\n                  return _regenerator[\"default\"].wrap(function _callee17$(_context17) {\n                    while (1) {\n                      switch (_context17.prev = _context17.next) {\n                        case 0:\n                          if (!prev) {\n                            _context17.next = 3;\n                            break;\n                          }\n\n                          _context17.next = 3;\n                          return prev;\n\n                        case 3:\n                          _context17.next = 5;\n                          return _this5.replicator.rootstore.add(entry);\n\n                        case 5:\n                        case \"end\":\n                          return _context17.stop();\n                      }\n                    }\n                  }, _callee17);\n                }))();\n\n              case 13:\n              case \"end\":\n                return _context18.stop();\n            }\n          }\n        }, _callee18, this);\n      }));\n\n      function _writeRootstoreEntry(_x13, _x14) {\n        return _writeRootstoreEntry2.apply(this, arguments);\n      }\n\n      return _writeRootstoreEntry;\n    }()\n  }, {\n    key: \"_typeCIDExists\",\n    value: function () {\n      var _typeCIDExists2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee19(type, cid) {\n        var entries, typeEntries;\n        return _regenerator[\"default\"].wrap(function _callee19$(_context19) {\n          while (1) {\n            switch (_context19.prev = _context19.next) {\n              case 0:\n                _context19.next = 2;\n                return this.replicator.rootstore.iterator({\n                  limit: -1\n                }).collect();\n\n              case 2:\n                entries = _context19.sent;\n                typeEntries = entries.filter(function (e) {\n                  return e.payload.value.type === type;\n                });\n                return _context19.abrupt(\"return\", Boolean(typeEntries.find(function (entry) {\n                  return entry.data === cid;\n                })));\n\n              case 5:\n              case \"end\":\n                return _context19.stop();\n            }\n          }\n        }, _callee19, this);\n      }));\n\n      function _typeCIDExists(_x15, _x16) {\n        return _typeCIDExists2.apply(this, arguments);\n      }\n\n      return _typeCIDExists;\n    }()\n  }, {\n    key: \"_deleteAddressLink\",\n    value: function () {\n      var _deleteAddressLink2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee20(address) {\n        var link;\n        return _regenerator[\"default\"].wrap(function _callee20$(_context20) {\n          while (1) {\n            switch (_context20.prev = _context20.next) {\n              case 0:\n                address = address.toLowerCase();\n                _context20.next = 3;\n                return this._readAddressLink(address);\n\n              case 3:\n                link = _context20.sent;\n\n                if (link) {\n                  _context20.next = 6;\n                  break;\n                }\n\n                throw new Error('_deleteAddressLink: link for given address does not exist');\n\n              case 6:\n                return _context20.abrupt(\"return\", this.replicator.rootstore.remove(link.entry.hash));\n\n              case 7:\n              case \"end\":\n                return _context20.stop();\n            }\n          }\n        }, _callee20, this);\n      }));\n\n      function _deleteAddressLink(_x17) {\n        return _deleteAddressLink2.apply(this, arguments);\n      }\n\n      return _deleteAddressLink;\n    }()\n  }, {\n    key: \"_readAddressLinks\",\n    value: function () {\n      var _readAddressLinks2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee21() {\n        var links, allLinks;\n        return _regenerator[\"default\"].wrap(function _callee21$(_context21) {\n          while (1) {\n            switch (_context21.prev = _context21.next) {\n              case 0:\n                _context21.next = 2;\n                return this.replicator.getAddressLinks();\n\n              case 2:\n                links = _context21.sent;\n                _context21.next = 5;\n                return Promise.all(links.map(validateLink));\n\n              case 5:\n                allLinks = _context21.sent;\n                return _context21.abrupt(\"return\", allLinks.filter(Boolean));\n\n              case 7:\n              case \"end\":\n                return _context21.stop();\n            }\n          }\n        }, _callee21, this);\n      }));\n\n      function _readAddressLinks() {\n        return _readAddressLinks2.apply(this, arguments);\n      }\n\n      return _readAddressLinks;\n    }()\n  }, {\n    key: \"_readAddressLink\",\n    value: function () {\n      var _readAddressLink2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee22(address) {\n        var links;\n        return _regenerator[\"default\"].wrap(function _callee22$(_context22) {\n          while (1) {\n            switch (_context22.prev = _context22.next) {\n              case 0:\n                address = address.toLowerCase();\n                _context22.next = 3;\n                return this._readAddressLinks();\n\n              case 3:\n                links = _context22.sent;\n                return _context22.abrupt(\"return\", links.find(function (link) {\n                  return link.address.toLowerCase() === address;\n                }));\n\n              case 5:\n              case \"end\":\n                return _context22.stop();\n            }\n          }\n        }, _callee22, this);\n      }));\n\n      function _readAddressLink(_x18) {\n        return _readAddressLink2.apply(this, arguments);\n      }\n\n      return _readAddressLink;\n    }()\n  }, {\n    key: \"close\",\n    value: function () {\n      var _close = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee23() {\n        return _regenerator[\"default\"].wrap(function _callee23$(_context23) {\n          while (1) {\n            switch (_context23.prev = _context23.next) {\n              case 0:\n                if (this._3id) {\n                  _context23.next = 2;\n                  break;\n                }\n\n                throw new Error('close: auth required');\n\n              case 2:\n                _context23.next = 4;\n                return this.replicator.stop();\n\n              case 4:\n              case \"end\":\n                return _context23.stop();\n            }\n          }\n        }, _callee23, this);\n      }));\n\n      function close() {\n        return _close.apply(this, arguments);\n      }\n\n      return close;\n    }()\n    /**\n     * Closes the 3box instance and clears local cache. If you call this,\n     * users will need to sign a consent message to log in the next time\n     * you call openBox.\n     */\n\n  }, {\n    key: \"logout\",\n    value: function () {\n      var _logout = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee24() {\n        var address;\n        return _regenerator[\"default\"].wrap(function _callee24$(_context24) {\n          while (1) {\n            switch (_context24.prev = _context24.next) {\n              case 0:\n                if (this._3id) {\n                  _context24.next = 2;\n                  break;\n                }\n\n                throw new Error('logout: auth required');\n\n              case 2:\n                _context24.next = 4;\n                return this.close();\n\n              case 4:\n                this._3id.logout();\n\n                _context24.next = 7;\n                return this._3id.getAddress();\n\n              case 7:\n                address = _context24.sent;\n                localstorage.remove('linkConsent_' + address);\n\n              case 9:\n              case \"end\":\n                return _context24.stop();\n            }\n          }\n        }, _callee24, this);\n      }));\n\n      function logout() {\n        return _logout.apply(this, arguments);\n      }\n\n      return logout;\n    }()\n    /**\n     * Check if the given address is logged in\n     *\n     * @param     {String}    address                 An ethereum address\n     * @return    {Boolean}                           true if the user is logged in\n     */\n\n  }, {\n    key: \"DID\",\n    get: function get() {\n      if (!this._3id) throw new Error('DID: auth required');\n      return this._3id.DID;\n    }\n  }], [{\n    key: \"create\",\n    value: function () {\n      var _create = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee25(provider) {\n        var opts,\n            ipfs,\n            box,\n            _args25 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee25$(_context25) {\n          while (1) {\n            switch (_context25.prev = _context25.next) {\n              case 0:\n                opts = _args25.length > 1 && _args25[1] !== undefined ? _args25[1] : {};\n                _context25.next = 3;\n                return Box.getIPFS(opts);\n\n              case 3:\n                ipfs = _context25.sent;\n                box = new Box(provider, ipfs, opts);\n                _context25.next = 7;\n                return box._init(opts);\n\n              case 7:\n                return _context25.abrupt(\"return\", box);\n\n              case 8:\n              case \"end\":\n                return _context25.stop();\n            }\n          }\n        }, _callee25);\n      }));\n\n      function create(_x19) {\n        return _create.apply(this, arguments);\n      }\n\n      return create;\n    }()\n  }, {\n    key: \"openBox\",\n    value: function () {\n      var _openBox = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee26(address, provider) {\n        var opts,\n            box,\n            _args26 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee26$(_context26) {\n          while (1) {\n            switch (_context26.prev = _context26.next) {\n              case 0:\n                opts = _args26.length > 2 && _args26[2] !== undefined ? _args26[2] : {};\n                opts = Object.assign(opts, {\n                  address: address\n                });\n                _context26.next = 4;\n                return Box.create(provider, opts);\n\n              case 4:\n                box = _context26.sent;\n                _context26.next = 7;\n                return box.auth([], opts);\n\n              case 7:\n                return _context26.abrupt(\"return\", box);\n\n              case 8:\n              case \"end\":\n                return _context26.stop();\n            }\n          }\n        }, _callee26);\n      }));\n\n      function openBox(_x20, _x21) {\n        return _openBox.apply(this, arguments);\n      }\n\n      return openBox;\n    }()\n  }, {\n    key: \"isLoggedIn\",\n    value: function isLoggedIn(address) {\n      return ThreeId.isLoggedIn(address);\n    }\n    /**\n     * Instanciate ipfs used by 3Box without calling openBox.\n     *\n     * @return    {IPFS}                           the ipfs instance\n     */\n\n  }, {\n    key: \"getIPFS\",\n    value: function () {\n      var _getIPFS = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee27() {\n        var opts,\n            ipfs,\n            pinningNode,\n            _args27 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee27$(_context27) {\n          while (1) {\n            switch (_context27.prev = _context27.next) {\n              case 0:\n                opts = _args27.length > 0 && _args27[0] !== undefined ? _args27[0] : {};\n\n                if (typeof window !== 'undefined') {\n                  globalIPFS = window.globalIPFS;\n                  globalIPFSPromise = window.globalIPFSPromise;\n                }\n\n                if (!globalIPFS && !globalIPFSPromise) {\n                  globalIPFSPromise = initIPFS(opts.ipfs, opts.iframeStore, opts.ipfsOptions);\n                }\n\n                if (typeof window !== 'undefined') window.globalIPFSPromise = globalIPFSPromise;\n\n                if (globalIPFS) {\n                  _context27.next = 8;\n                  break;\n                }\n\n                _context27.next = 7;\n                return globalIPFSPromise;\n\n              case 7:\n                globalIPFS = _context27.sent;\n\n              case 8:\n                if (typeof window !== 'undefined') window.globalIPFS = globalIPFS;\n                ipfs = globalIPFS;\n                pinningNode = opts.pinningNode || PINNING_NODE;\n                ipfs.swarm.connect(pinningNode, function () {});\n                return _context27.abrupt(\"return\", ipfs);\n\n              case 13:\n              case \"end\":\n                return _context27.stop();\n            }\n          }\n        }, _callee27);\n      }));\n\n      function getIPFS() {\n        return _getIPFS.apply(this, arguments);\n      }\n\n      return getIPFS;\n    }()\n  }]);\n  return Box;\n}(BoxApi);\n\nfunction initIPFSRepo() {\n  var repoOpts = {};\n  var ipfsRootPath; // if in browser, create unique root storage, and ipfs id on each instance\n\n  if (typeof window !== 'undefined' && window.indexedDB) {\n    var sessionID = utils.randInt(10000);\n    ipfsRootPath = 'ipfs/root/' + sessionID;\n    var levelInstance = new LevelStore(ipfsRootPath);\n    repoOpts = {\n      storageBackends: {\n        root: function root() {\n          return levelInstance;\n        }\n      }\n    };\n  }\n\n  var repo = new IPFSRepo('ipfs', repoOpts);\n  return {\n    repo: repo,\n    rootPath: ipfsRootPath\n  };\n}\n\nfunction initIPFS(_x22, _x23, _x24) {\n  return _initIPFS.apply(this, arguments);\n}\n\nfunction _initIPFS() {\n  _initIPFS = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee28(ipfs, iframeStore, ipfsOptions) {\n    var ipfsRepo;\n    return _regenerator[\"default\"].wrap(function _callee28$(_context28) {\n      while (1) {\n        switch (_context28.prev = _context28.next) {\n          case 0:\n            // if (!ipfs && !ipfsProxy) throw new Error('No IPFS object configured and no default available for environment')\n            if (!!ipfs && iframeStore) console.warn('Warning: iframeStore true, orbit db cache in iframe, but the given ipfs object is being used, and may not be running in same iframe.');\n\n            if (!ipfs) {\n              _context28.next = 5;\n              break;\n            }\n\n            return _context28.abrupt(\"return\", ipfs);\n\n          case 5:\n            // await iframeLoadedPromise\n            // return ipfsProxy\n            if (!ipfsOptions) {\n              ipfsRepo = initIPFSRepo();\n              ipfsOptions = Object.assign(IPFS_OPTIONS, {\n                repo: ipfsRepo.repo\n              });\n            }\n\n            _context28.next = 8;\n            return IPFS.create(ipfsOptions);\n\n          case 8:\n            ipfs = _context28.sent;\n\n            if (ipfsRepo && typeof window !== 'undefined' && window.indexedDB) {\n              // deletes once db is closed again\n              window.indexedDB.deleteDatabase(ipfsRepo.rootPath);\n            }\n\n            return _context28.abrupt(\"return\", ipfs);\n\n          case 11:\n          case \"end\":\n            return _context28.stop();\n        }\n      }\n    }, _callee28);\n  }));\n  return _initIPFS.apply(this, arguments);\n}\n\nBox.idUtils = idUtils;\nmodule.exports = Box;","map":{"version":3,"sources":["/home/dekan/Projects/raid-guild/dao-badges-web/node_modules/3box/lib/3box.js"],"names":["_interopRequireDefault","require","_regenerator","_asyncToGenerator2","_classCallCheck2","_createClass2","_possibleConstructorReturn2","_getPrototypeOf2","_assertThisInitialized2","_inherits2","localstorage","IPFS","registerResolver","_require","createLink","validateLink","ThreeId","Replicator","PublicStore","PrivateStore","Verified","Space","utils","idUtils","config","BoxApi","IPFSRepo","LevelStore","didJWT","PINNING_NODE","pinning_node","ADDRESS_SERVER_URL","address_server_url","IPFS_OPTIONS","ipfs_options","globalIPFS","globalIPFSPromise","Box","_BoxApi","provider","ipfs","_this","opts","arguments","length","undefined","call","_provider","_ipfs","pin","_serverUrl","addressServer","verified","spaces","syncDone","hasPublishedLink","key","value","_init2","mark","_callee","wrap","_callee$","_context","prev","next","create","replicator","sent","stop","_init","_x","apply","_load2","_callee2","_this2","address","_ref","rootStoreAddress","did","authData","rootstoreName","_args2","_callee2$","_context2","_3id","getAddress","_getLinkedData","t0","start","profile","rootstoreSyncDone","getAuthData","authenticate","muportFingerprint","getPublicKeys","signingKey","DID","_publishRootStore","rootstore","toString","t1","getOdbId","t2","setIdentity","events","on","_writeRootstoreEntry","entryTypes","AUTH_DATA","proof","_writeAddressLink","startUpdatePolling","_linkProfile","bind","_load","_auth","_callee4","_this3","_args4","_callee4$","_context4","is3idProvider","Error","getIdFromEthAddress","_orbitdb","keystore","Object","assign","Promise","all","map","_ref2","_callee3","space","_callee3$","_context3","_authThreads","_x2","auth","_openSpace","_callee5","name","_args5","_callee5$","_context5","includes","isOpen","open","isAddressLinked","linkAddress","message","onSyncDone","abrupt","openSpace","_x3","_openThread","_callee6","_callee6$","_context6","joinThread","openThread","_x4","_x5","_x6","_onSyncDone","_callee7","_callee7$","_context7","_x7","_publishRootStore2","_callee9","_this4","addressToken","publish","_callee9$","_context9","signJWT","_ref3","_callee8","token","_callee8$","_context8","fetchJson","address_token","resolve","setTimeout","statusCode","_x9","_x8","_getLinkedData2","_callee10","ethereumAddress","_data","_callee10$","_context10","concat","data","_x10","_linkAddress","_callee11","link","_args11","_callee11$","_context11","_removeAddressLink","_callee12","linkExist","payload","oneHour","deleteToken","_callee12$","_context12","toLowerCase","type","expiresIn","delete_token","_deleteAddressLink","removeAddressLink","_x11","_isAddressLinked","_callee13","query","links","linksQuery","_args13","_callee13$","_context13","_readAddressLinks","find","res","Boolean","_listAddressLinks","_callee14","entries","_callee14$","_context14","reduce","list","entry","item","linkId","hash","push","listAddressLinks","_writeAddressLink2","_callee15","validProof","_callee15$","_context15","ADDRESS_LINK","_x12","_linkProfile2","_callee16","proofdid","issuer","jwt","_callee16$","_context16","_readAddressLink","signature","get","decodeJWT","iss","muport","t3","t4","t5","noLink","set","t6","t7","t8","_writeRootstoreEntry2","_callee18","_this5","cid","entryExist","_callee18$","_context18","dag","put","toBaseEncodedString","add","_typeCIDExists","_rootstoreQueue","_callee17","_callee17$","_context17","_x13","_x14","_typeCIDExists2","_callee19","typeEntries","_callee19$","_context19","iterator","limit","collect","filter","e","_x15","_x16","_deleteAddressLink2","_callee20","_callee20$","_context20","remove","_x17","_readAddressLinks2","_callee21","allLinks","_callee21$","_context21","getAddressLinks","_readAddressLink2","_callee22","_callee22$","_context22","_x18","_close","_callee23","_callee23$","_context23","close","_logout","_callee24","_callee24$","_context24","logout","_create","_callee25","box","_args25","_callee25$","_context25","getIPFS","_x19","_openBox","_callee26","_args26","_callee26$","_context26","openBox","_x20","_x21","isLoggedIn","_getIPFS","_callee27","pinningNode","_args27","_callee27$","_context27","window","initIPFS","iframeStore","ipfsOptions","swarm","connect","initIPFSRepo","repoOpts","ipfsRootPath","indexedDB","sessionID","randInt","levelInstance","storageBackends","root","repo","rootPath","_x22","_x23","_x24","_initIPFS","_callee28","ipfsRepo","_callee28$","_context28","console","warn","deleteDatabase","module","exports"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nvar _possibleConstructorReturn2 = _interopRequireDefault(require(\"@babel/runtime/helpers/possibleConstructorReturn\"));\n\nvar _getPrototypeOf2 = _interopRequireDefault(require(\"@babel/runtime/helpers/getPrototypeOf\"));\n\nvar _assertThisInitialized2 = _interopRequireDefault(require(\"@babel/runtime/helpers/assertThisInitialized\"));\n\nvar _inherits2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inherits\"));\n\nvar localstorage = require('store');\n\nvar IPFS = require('ipfs');\n\nvar registerResolver = require('3id-resolver');\n\nvar _require = require('3id-blockchain-utils'),\n    createLink = _require.createLink,\n    validateLink = _require.validateLink;\n\nvar ThreeId = require('./3id');\n\nvar Replicator = require('./replicator');\n\nvar PublicStore = require('./publicStore');\n\nvar PrivateStore = require('./privateStore');\n\nvar Verified = require('./verified');\n\nvar Space = require('./space');\n\nvar utils = require('./utils/index');\n\nvar idUtils = require('./utils/id');\n\nvar config = require('./config.js');\n\nvar BoxApi = require('./api');\n\nvar IPFSRepo = require('ipfs-repo');\n\nvar LevelStore = require('datastore-level');\n\nvar didJWT = require('did-jwt');\n\nvar PINNING_NODE = config.pinning_node;\nvar ADDRESS_SERVER_URL = config.address_server_url;\nvar IPFS_OPTIONS = config.ipfs_options;\nvar globalIPFS, globalIPFSPromise; // , ipfsProxy, cacheProxy, iframeLoadedPromise\n\n/*\nif (typeof window !== 'undefined' && typeof document !== 'undefined') {\n  const iframe = document.createElement('iframe')\n  iframe.src = IFRAME_STORE_URL\n  iframe.style = 'width:0; height:0; border:0; border:none !important'\n\n  iframeLoadedPromise = new Promise((resolve, reject) => {\n    iframe.onload = () => { resolve() }\n  })\n\n  document.body.appendChild(iframe)\n  // Create proxy clients that talks to the iframe\n  const postMessage = iframe.contentWindow.postMessage.bind(iframe.contentWindow)\n  ipfsProxy = createProxyClient({ postMessage })\n  cacheProxy = OrbitDBCacheProxy({ postMessage })\n} */\n\n/**\n * @extends BoxApi\n */\n\nvar Box =\n/*#__PURE__*/\nfunction (_BoxApi) {\n  (0, _inherits2[\"default\"])(Box, _BoxApi);\n\n  /**\n   * Please use the **openBox** method to instantiate a 3Box\n   * @constructor\n   */\n  function Box(provider, ipfs) {\n    var _this;\n\n    var opts = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n    (0, _classCallCheck2[\"default\"])(this, Box);\n    _this = (0, _possibleConstructorReturn2[\"default\"])(this, (0, _getPrototypeOf2[\"default\"])(Box).call(this));\n    _this._provider = provider;\n    _this._ipfs = ipfs;\n    registerResolver(_this._ipfs, {\n      pin: true\n    });\n    _this._serverUrl = opts.addressServer || ADDRESS_SERVER_URL;\n    /**\n     * @property {KeyValueStore} public         access the profile store of the users 3Box\n     */\n\n    _this[\"public\"] = null;\n    /**\n     * @property {KeyValueStore} private        access the private store of the users 3Box\n     */\n\n    _this[\"private\"] = null;\n    /**\n     * @property {Verified} verified        check and create verifications\n     */\n\n    _this.verified = new Verified((0, _assertThisInitialized2[\"default\"])(_this));\n    /**\n     * @property {Object} spaces            an object containing all open spaces indexed by their name.\n     */\n\n    _this.spaces = {};\n    /**\n     * @property {Promise} syncDone         A promise that is resolved when the box is synced\n     */\n\n    _this.syncDone = null;\n    _this.hasPublishedLink = {};\n    return _this;\n  }\n\n  (0, _createClass2[\"default\"])(Box, [{\n    key: \"_init\",\n    value: function () {\n      var _init2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee(opts) {\n        return _regenerator[\"default\"].wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return Replicator.create(this._ipfs, opts);\n\n              case 2:\n                this.replicator = _context.sent;\n\n              case 3:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function _init(_x) {\n        return _init2.apply(this, arguments);\n      }\n\n      return _init;\n    }()\n  }, {\n    key: \"_load\",\n    value: function () {\n      var _load2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee2() {\n        var _this2 = this;\n\n        var opts,\n            address,\n            _ref,\n            rootStoreAddress,\n            did,\n            authData,\n            rootstoreName,\n            key,\n            _args2 = arguments;\n\n        return _regenerator[\"default\"].wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                opts = _args2.length > 0 && _args2[0] !== undefined ? _args2[0] : {};\n                _context2.next = 3;\n                return this._3id.getAddress();\n\n              case 3:\n                address = _context2.sent;\n\n                if (!address) {\n                  _context2.next = 10;\n                  break;\n                }\n\n                _context2.next = 7;\n                return this._getLinkedData(address);\n\n              case 7:\n                _context2.t0 = _context2.sent;\n                _context2.next = 11;\n                break;\n\n              case 10:\n                _context2.t0 = {};\n\n              case 11:\n                _ref = _context2.t0;\n                rootStoreAddress = _ref.rootStoreAddress;\n                did = _ref.did;\n\n                if (!rootStoreAddress) {\n                  _context2.next = 26;\n                  break;\n                }\n\n                _context2.next = 17;\n                return this.replicator.start(rootStoreAddress, did, {\n                  profile: true\n                });\n\n              case 17:\n                _context2.next = 19;\n                return this.replicator.rootstoreSyncDone;\n\n              case 19:\n                _context2.next = 21;\n                return this.replicator.getAuthData();\n\n              case 21:\n                authData = _context2.sent;\n                _context2.next = 24;\n                return this._3id.authenticate(opts.spaces, {\n                  authData: authData\n                });\n\n              case 24:\n                _context2.next = 35;\n                break;\n\n              case 26:\n                _context2.next = 28;\n                return this._3id.authenticate(opts.spaces);\n\n              case 28:\n                rootstoreName = this._3id.muportFingerprint + '.root';\n                _context2.next = 31;\n                return this._3id.getPublicKeys(null, true);\n\n              case 31:\n                key = _context2.sent.signingKey;\n                _context2.next = 34;\n                return this.replicator[\"new\"](rootstoreName, key, this._3id.DID);\n\n              case 34:\n                this._publishRootStore(this.replicator.rootstore.address.toString());\n\n              case 35:\n                _context2.t1 = this.replicator.rootstore;\n                _context2.next = 38;\n                return this._3id.getOdbId();\n\n              case 38:\n                _context2.t2 = _context2.sent;\n\n                _context2.t1.setIdentity.call(_context2.t1, _context2.t2);\n\n                this.syncDone = this.replicator.syncDone;\n\n                this._3id.events.on('new-auth-method', function (authData) {\n                  _this2._writeRootstoreEntry(Replicator.entryTypes.AUTH_DATA, authData);\n                });\n\n                this._3id.events.on('new-link-proof', function (proof) {\n                  _this2._writeAddressLink(proof);\n                });\n\n                this._3id.startUpdatePolling();\n\n                this[\"public\"] = new PublicStore(this._3id.muportFingerprint + '.public', this._linkProfile.bind(this), this.replicator, this._3id);\n                this[\"private\"] = new PrivateStore(this._3id.muportFingerprint + '.private', this.replicator, this._3id);\n                _context2.next = 48;\n                return this[\"public\"]._load();\n\n              case 48:\n                _context2.next = 50;\n                return this[\"private\"]._load();\n\n              case 50:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function _load() {\n        return _load2.apply(this, arguments);\n      }\n\n      return _load;\n    }()\n    /**\n     * Creates an instance of 3Box\n     *\n     * @param     {provider}          provider                A 3ID provider, or ethereum provider\n     * @param     {Object}            opts                    Optional parameters\n     * @param     {String}            opts.pinningNode        A string with an ipfs multi-address to a 3box pinning node\n     * @param     {Object}            opts.ipfs               A js-ipfs ipfs object\n     * @param     {String}            opts.addressServer      URL of the Address Server\n     * @return    {Box}                                       the 3Box session instance\n     */\n\n  }, {\n    key: \"auth\",\n\n    /**\n     * Authenticate the user\n     *\n     * @param     {Array<String>}     spaces                  A list of spaces to authenticate (optional)\n     * @param     {Object}            opts                    Optional parameters\n     * @param     {String}            opts.address            An ethereum address\n     * @param     {Function}          opts.consentCallback    A function that will be called when the user has consented to opening the box\n     */\n    value: function () {\n      var _auth = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee4() {\n        var _this3 = this;\n\n        var spaces,\n            opts,\n            _args4 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                spaces = _args4.length > 0 && _args4[0] !== undefined ? _args4[0] : [];\n                opts = _args4.length > 1 && _args4[1] !== undefined ? _args4[1] : {};\n\n                if (this._3id) {\n                  _context4.next = 12;\n                  break;\n                }\n\n                if (!(!this._provider.is3idProvider && !opts.address)) {\n                  _context4.next = 5;\n                  break;\n                }\n\n                throw new Error('auth: address needed when 3ID provider is not used');\n\n              case 5:\n                _context4.next = 7;\n                return ThreeId.getIdFromEthAddress(opts.address, this._provider, this._ipfs, this.replicator._orbitdb.keystore, opts);\n\n              case 7:\n                this._3id = _context4.sent;\n                _context4.next = 10;\n                return this._load(Object.assign(opts, {\n                  spaces: spaces\n                }));\n\n              case 10:\n                _context4.next = 14;\n                break;\n\n              case 12:\n                _context4.next = 14;\n                return this._3id.authenticate(spaces);\n\n              case 14:\n                _context4.next = 16;\n                return Promise.all(spaces.map(\n                /*#__PURE__*/\n                function () {\n                  var _ref2 = (0, _asyncToGenerator2[\"default\"])(\n                  /*#__PURE__*/\n                  _regenerator[\"default\"].mark(function _callee3(space) {\n                    return _regenerator[\"default\"].wrap(function _callee3$(_context3) {\n                      while (1) {\n                        switch (_context3.prev = _context3.next) {\n                          case 0:\n                            if (!_this3.spaces[space]) {\n                              _context3.next = 3;\n                              break;\n                            }\n\n                            _context3.next = 3;\n                            return _this3.spaces[space]._authThreads(_this3._3id);\n\n                          case 3:\n                          case \"end\":\n                            return _context3.stop();\n                        }\n                      }\n                    }, _callee3);\n                  }));\n\n                  return function (_x2) {\n                    return _ref2.apply(this, arguments);\n                  };\n                }()));\n\n              case 16:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function auth() {\n        return _auth.apply(this, arguments);\n      }\n\n      return auth;\n    }()\n    /**\n     * Opens the 3Box associated with the given address\n     *\n     * @param     {String}            address                 An ethereum address\n     * @param     {provider}          provider                An ethereum or 3ID provider\n     * @param     {Object}            opts                    Optional parameters\n     * @param     {Function}          opts.consentCallback    A function that will be called when the user has consented to opening the box\n     * @param     {String}            opts.pinningNode        A string with an ipfs multi-address to a 3box pinning node\n     * @param     {Object}            opts.ipfs               A js-ipfs ipfs object\n     * @param     {String}            opts.addressServer      URL of the Address Server\n     * @param     {String}            opts.contentSignature   A signature, provided by a client of 3box using the private keys associated with the given address, of the 3box consent message\n     * @return    {Box}                                       the 3Box instance for the given address\n     */\n\n  }, {\n    key: \"openSpace\",\n\n    /**\n     * Opens the space with the given name in the users 3Box\n     *\n     * @param     {String}            name                    The name of the space\n     * @param     {Object}            opts                    Optional parameters\n     * @param     {Function}          opts.consentCallback    A function that will be called when the user has consented to opening the box\n     * @param     {Function}          opts.onSyncDone         A function that will be called when the space has finished syncing with the pinning node\n     * @return    {Space}                                     the Space instance for the given space name\n     */\n    value: function () {\n      var _openSpace = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee5(name) {\n        var opts,\n            _args5 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                opts = _args5.length > 1 && _args5[1] !== undefined ? _args5[1] : {};\n\n                if (!name.includes('.')) {\n                  _context5.next = 3;\n                  break;\n                }\n\n                throw new Error('Invalid name: character \".\" not allowed');\n\n              case 3:\n                if (this._3id) {\n                  _context5.next = 5;\n                  break;\n                }\n\n                throw new Error('openSpace: auth required');\n\n              case 5:\n                if (!this.spaces[name]) {\n                  this.spaces[name] = new Space(name, this.replicator);\n                }\n\n                if (this.spaces[name].isOpen) {\n                  _context5.next = 26;\n                  break;\n                }\n\n                _context5.prev = 7;\n                _context5.next = 10;\n                return this.spaces[name].open(this._3id, opts);\n\n              case 10:\n                _context5.next = 12;\n                return this.isAddressLinked();\n\n              case 12:\n                if (_context5.sent) {\n                  _context5.next = 14;\n                  break;\n                }\n\n                this.linkAddress();\n\n              case 14:\n                _context5.next = 24;\n                break;\n\n              case 16:\n                _context5.prev = 16;\n                _context5.t0 = _context5[\"catch\"](7);\n                delete this.spaces[name];\n\n                if (!_context5.t0.message.includes('User denied message signature.')) {\n                  _context5.next = 23;\n                  break;\n                }\n\n                throw new Error('User denied space consent.');\n\n              case 23:\n                throw new Error('An error occured while opening space: ', _context5.t0.message);\n\n              case 24:\n                _context5.next = 27;\n                break;\n\n              case 26:\n                if (opts.onSyncDone) {\n                  // since the space is already open we can call onSyncDone directly\n                  opts.onSyncDone();\n                }\n\n              case 27:\n                return _context5.abrupt(\"return\", this.spaces[name]);\n\n              case 28:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this, [[7, 16]]);\n      }));\n\n      function openSpace(_x3) {\n        return _openSpace.apply(this, arguments);\n      }\n\n      return openSpace;\n    }()\n    /**\n     * Open a thread. Use this to start receiving updates\n     *\n     * @param     {String}    space                   The name of the space for this thread\n     * @param     {String}    name                    The name of the thread\n     * @param     {Object}    opts                    Optional parameters\n     * @param     {String}    opts.firstModerator     DID of first moderator of a thread, by default, user is first moderator\n     * @param     {Boolean}   opts.members            join a members only thread, which only members can post in, defaults to open thread\n     * @param     {Boolean}   opts.noAutoSub          Disable auto subscription to the thread when posting to it (default false)\n     * @param     {Boolean}   opts.ghost              Enable ephemeral messaging via Ghost Thread\n     * @param     {Number}    opts.ghostBacklogLimit  The number of posts to maintain in the ghost backlog\n     * @param     {Array<Function>} opts.ghostFilters Array of functions for filtering messages\n     *\n     * @return    {Thread}                  An instance of the thread class for the joined thread\n     */\n\n  }, {\n    key: \"openThread\",\n    value: function () {\n      var _openThread = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee6(space, name, opts) {\n        return _regenerator[\"default\"].wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                if (!this.spaces[space]) {\n                  this.spaces[space] = new Space(space, this.replicator);\n                }\n\n                return _context6.abrupt(\"return\", this.spaces[space].joinThread(name, opts));\n\n              case 2:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this);\n      }));\n\n      function openThread(_x4, _x5, _x6) {\n        return _openThread.apply(this, arguments);\n      }\n\n      return openThread;\n    }()\n    /**\n     * Sets the callback function that will be called once when the box is fully synced.\n     *\n     * @param     {Function}      syncDone        The function that will be called\n     * @return    {Promise}                       A promise that is fulfilled when the box is syned\n     */\n\n  }, {\n    key: \"onSyncDone\",\n    value: function () {\n      var _onSyncDone = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee7(syncDone) {\n        return _regenerator[\"default\"].wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                _context7.next = 2;\n                return this.syncDone;\n\n              case 2:\n                syncDone();\n\n              case 3:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7, this);\n      }));\n\n      function onSyncDone(_x7) {\n        return _onSyncDone.apply(this, arguments);\n      }\n\n      return onSyncDone;\n    }()\n  }, {\n    key: \"_publishRootStore\",\n    value: function () {\n      var _publishRootStore2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee9(rootStoreAddress) {\n        var _this4 = this;\n\n        var addressToken, publish;\n        return _regenerator[\"default\"].wrap(function _callee9$(_context9) {\n          while (1) {\n            switch (_context9.prev = _context9.next) {\n              case 0:\n                _context9.next = 2;\n                return this._3id.signJWT({\n                  rootStoreAddress: rootStoreAddress\n                });\n\n              case 2:\n                addressToken = _context9.sent;\n\n                // Store odbAddress on 3box-address-server\n                publish =\n                /*#__PURE__*/\n                function () {\n                  var _ref3 = (0, _asyncToGenerator2[\"default\"])(\n                  /*#__PURE__*/\n                  _regenerator[\"default\"].mark(function _callee8(token) {\n                    return _regenerator[\"default\"].wrap(function _callee8$(_context8) {\n                      while (1) {\n                        switch (_context8.prev = _context8.next) {\n                          case 0:\n                            _context8.prev = 0;\n                            _context8.next = 3;\n                            return utils.fetchJson(_this4._serverUrl + '/odbAddress', {\n                              address_token: token\n                            });\n\n                          case 3:\n                            _context8.next = 14;\n                            break;\n\n                          case 5:\n                            _context8.prev = 5;\n                            _context8.t0 = _context8[\"catch\"](0);\n\n                            if (!(_context8.t0.message === 'Invalid JWT')) {\n                              _context8.next = 12;\n                              break;\n                            }\n\n                            _context8.next = 10;\n                            return new Promise(function (resolve) {\n                              return setTimeout(resolve, 300);\n                            });\n\n                          case 10:\n                            _context8.next = 12;\n                            return publish(token);\n\n                          case 12:\n                            if (_context8.t0.statusCode) {\n                              _context8.next = 14;\n                              break;\n                            }\n\n                            throw new Error(_context8.t0);\n\n                          case 14:\n                          case \"end\":\n                            return _context8.stop();\n                        }\n                      }\n                    }, _callee8, null, [[0, 5]]);\n                  }));\n\n                  return function publish(_x9) {\n                    return _ref3.apply(this, arguments);\n                  };\n                }();\n\n                _context9.next = 6;\n                return publish(addressToken);\n\n              case 6:\n                return _context9.abrupt(\"return\", true);\n\n              case 7:\n              case \"end\":\n                return _context9.stop();\n            }\n          }\n        }, _callee9, this);\n      }));\n\n      function _publishRootStore(_x8) {\n        return _publishRootStore2.apply(this, arguments);\n      }\n\n      return _publishRootStore;\n    }()\n  }, {\n    key: \"_getLinkedData\",\n    value: function () {\n      var _getLinkedData2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee10(ethereumAddress) {\n        var _data, rootStoreAddress, did;\n\n        return _regenerator[\"default\"].wrap(function _callee10$(_context10) {\n          while (1) {\n            switch (_context10.prev = _context10.next) {\n              case 0:\n                _context10.prev = 0;\n                _context10.next = 3;\n                return utils.fetchJson(\"\".concat(this._serverUrl, \"/odbAddress/\").concat(ethereumAddress));\n\n              case 3:\n                _data = _context10.sent.data;\n                rootStoreAddress = _data.rootStoreAddress;\n                did = _data.did;\n                return _context10.abrupt(\"return\", {\n                  rootStoreAddress: rootStoreAddress,\n                  did: did\n                });\n\n              case 9:\n                _context10.prev = 9;\n                _context10.t0 = _context10[\"catch\"](0);\n\n                if (!(_context10.t0.statusCode === 404)) {\n                  _context10.next = 13;\n                  break;\n                }\n\n                return _context10.abrupt(\"return\", {});\n\n              case 13:\n                throw new Error('Error while getting rootstore', _context10.t0);\n\n              case 14:\n              case \"end\":\n                return _context10.stop();\n            }\n          }\n        }, _callee10, this, [[0, 9]]);\n      }));\n\n      function _getLinkedData(_x10) {\n        return _getLinkedData2.apply(this, arguments);\n      }\n\n      return _getLinkedData;\n    }()\n    /**\n     * @property {String} DID        the DID of the user\n     */\n\n  }, {\n    key: \"linkAddress\",\n\n    /**\n     * Creates a proof that links an ethereum address to the 3Box account of the user. If given proof, it will simply be added to the root store.\n     *\n     * @param     {Object}    [link]                         Optional link object with type or proof\n     * @param     {Object}    [link.proof]                   Proof object, should follow [spec](https://github.com/3box/3box/blob/master/3IPs/3ip-5.md)\n     */\n    value: function () {\n      var _linkAddress = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee11() {\n        var link,\n            _args11 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee11$(_context11) {\n          while (1) {\n            switch (_context11.prev = _context11.next) {\n              case 0:\n                link = _args11.length > 0 && _args11[0] !== undefined ? _args11[0] : {};\n\n                if (this._3id) {\n                  _context11.next = 3;\n                  break;\n                }\n\n                throw new Error('linkAddress: auth required');\n\n              case 3:\n                if (!link.proof) {\n                  _context11.next = 8;\n                  break;\n                }\n\n                _context11.next = 6;\n                return this._writeAddressLink(link.proof);\n\n              case 6:\n                _context11.next = 10;\n                break;\n\n              case 8:\n                _context11.next = 10;\n                return this._linkProfile();\n\n              case 10:\n              case \"end\":\n                return _context11.stop();\n            }\n          }\n        }, _callee11, this);\n      }));\n\n      function linkAddress() {\n        return _linkAddress.apply(this, arguments);\n      }\n\n      return linkAddress;\n    }()\n    /**\n     * Remove given address link, returns true if successful\n     *\n     * @param     {String}   address      address that is linked\n     */\n\n  }, {\n    key: \"removeAddressLink\",\n    value: function () {\n      var _removeAddressLink = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee12(address) {\n        var linkExist, payload, oneHour, deleteToken;\n        return _regenerator[\"default\"].wrap(function _callee12$(_context12) {\n          while (1) {\n            switch (_context12.prev = _context12.next) {\n              case 0:\n                if (this._3id) {\n                  _context12.next = 2;\n                  break;\n                }\n\n                throw new Error('removeAddressLink: auth required');\n\n              case 2:\n                address = address.toLowerCase();\n                _context12.next = 5;\n                return this.isAddressLinked({\n                  address: address\n                });\n\n              case 5:\n                linkExist = _context12.sent;\n\n                if (linkExist) {\n                  _context12.next = 8;\n                  break;\n                }\n\n                throw new Error('removeAddressLink: link for given address does not exist');\n\n              case 8:\n                payload = {\n                  address: address,\n                  type: 'delete-address-link'\n                };\n                oneHour = 60 * 60;\n                _context12.next = 12;\n                return this._3id.signJWT(payload, {\n                  expiresIn: oneHour\n                });\n\n              case 12:\n                deleteToken = _context12.sent;\n                _context12.prev = 13;\n                _context12.next = 16;\n                return utils.fetchJson(this._serverUrl + '/linkdelete', {\n                  delete_token: deleteToken\n                });\n\n              case 16:\n                _context12.next = 22;\n                break;\n\n              case 18:\n                _context12.prev = 18;\n                _context12.t0 = _context12[\"catch\"](13);\n\n                if (_context12.t0.statusCode) {\n                  _context12.next = 22;\n                  break;\n                }\n\n                throw new Error(_context12.t0);\n\n              case 22:\n                _context12.next = 24;\n                return this._deleteAddressLink(address);\n\n              case 24:\n                return _context12.abrupt(\"return\", true);\n\n              case 25:\n              case \"end\":\n                return _context12.stop();\n            }\n          }\n        }, _callee12, this, [[13, 18]]);\n      }));\n\n      function removeAddressLink(_x11) {\n        return _removeAddressLink.apply(this, arguments);\n      }\n\n      return removeAddressLink;\n    }()\n    /**\n     * Checks if there is a proof that links an external account to the 3Box account of the user. If not params given and any link exists, returns true\n     *\n     * @param     {Object}    [query]            Optional object with address and/or type.\n     * @param     {String}    [query.type]       Does the given type of link exist\n     * @param     {String}    [query.address]    Is the given adressed linked\n     */\n\n  }, {\n    key: \"isAddressLinked\",\n    value: function () {\n      var _isAddressLinked = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee13() {\n        var query,\n            links,\n            linksQuery,\n            _args13 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee13$(_context13) {\n          while (1) {\n            switch (_context13.prev = _context13.next) {\n              case 0:\n                query = _args13.length > 0 && _args13[0] !== undefined ? _args13[0] : {};\n\n                if (this._3id) {\n                  _context13.next = 3;\n                  break;\n                }\n\n                throw new Error('isAddressLinked: auth required');\n\n              case 3:\n                if (query.address) query.address = query.address.toLowerCase();\n                _context13.next = 6;\n                return this._readAddressLinks();\n\n              case 6:\n                links = _context13.sent;\n                linksQuery = links.find(function (link) {\n                  var res = query.address ? link.address.toLowerCase() === query.address : true;\n                  return query.type ? res && link.type === query.type : res;\n                });\n                return _context13.abrupt(\"return\", Boolean(linksQuery));\n\n              case 9:\n              case \"end\":\n                return _context13.stop();\n            }\n          }\n        }, _callee13, this);\n      }));\n\n      function isAddressLinked() {\n        return _isAddressLinked.apply(this, arguments);\n      }\n\n      return isAddressLinked;\n    }()\n    /**\n     * Lists address links associated with this 3Box\n     *\n     * @return    {Array}                        An array of link objects\n     */\n\n  }, {\n    key: \"listAddressLinks\",\n    value: function () {\n      var _listAddressLinks = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee14() {\n        var entries;\n        return _regenerator[\"default\"].wrap(function _callee14$(_context14) {\n          while (1) {\n            switch (_context14.prev = _context14.next) {\n              case 0:\n                if (this._3id) {\n                  _context14.next = 2;\n                  break;\n                }\n\n                throw new Error('listAddressLinks: auth required');\n\n              case 2:\n                _context14.next = 4;\n                return this._readAddressLinks();\n\n              case 4:\n                entries = _context14.sent;\n                return _context14.abrupt(\"return\", entries.reduce(function (list, entry) {\n                  var item = Object.assign({}, entry);\n                  item.linkId = item.entry.hash;\n                  delete item.entry;\n                  list.push(item);\n                  return list;\n                }, []));\n\n              case 6:\n              case \"end\":\n                return _context14.stop();\n            }\n          }\n        }, _callee14, this);\n      }));\n\n      function listAddressLinks() {\n        return _listAddressLinks.apply(this, arguments);\n      }\n\n      return listAddressLinks;\n    }()\n  }, {\n    key: \"_writeAddressLink\",\n    value: function () {\n      var _writeAddressLink2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee15(proof) {\n        var validProof;\n        return _regenerator[\"default\"].wrap(function _callee15$(_context15) {\n          while (1) {\n            switch (_context15.prev = _context15.next) {\n              case 0:\n                _context15.next = 2;\n                return validateLink(proof);\n\n              case 2:\n                validProof = _context15.sent;\n\n                if (validProof) {\n                  _context15.next = 5;\n                  break;\n                }\n\n                throw new Error('tried to write invalid link proof', proof);\n\n              case 5:\n                _context15.next = 7;\n                return this.isAddressLinked({\n                  address: validProof.address\n                });\n\n              case 7:\n                if (!_context15.sent) {\n                  _context15.next = 9;\n                  break;\n                }\n\n                return _context15.abrupt(\"return\", true);\n\n              case 9:\n                _context15.next = 11;\n                return this._writeRootstoreEntry(Replicator.entryTypes.ADDRESS_LINK, proof);\n\n              case 11:\n                _context15.next = 13;\n                return utils.fetchJson(this._serverUrl + '/link', proof);\n\n              case 13:\n              case \"end\":\n                return _context15.stop();\n            }\n          }\n        }, _callee15, this);\n      }));\n\n      function _writeAddressLink(_x12) {\n        return _writeAddressLink2.apply(this, arguments);\n      }\n\n      return _writeAddressLink;\n    }()\n  }, {\n    key: \"_linkProfile\",\n    value: function () {\n      var _linkProfile2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee16() {\n        var address, proof, proofdid, issuer, jwt;\n        return _regenerator[\"default\"].wrap(function _callee16$(_context16) {\n          while (1) {\n            switch (_context16.prev = _context16.next) {\n              case 0:\n                _context16.next = 2;\n                return this._3id.getAddress();\n\n              case 2:\n                address = _context16.sent;\n                _context16.next = 5;\n                return this._readAddressLink(address);\n\n              case 5:\n                proof = _context16.sent;\n\n                if (proof) {\n                  _context16.next = 27;\n                  break;\n                }\n\n                if (this._provider.is3idProvider) {\n                  _context16.next = 25;\n                  break;\n                }\n\n                _context16.prev = 8;\n                _context16.next = 11;\n                return createLink(this._3id.DID, address, this._provider);\n\n              case 11:\n                proof = _context16.sent;\n                _context16.next = 17;\n                break;\n\n              case 14:\n                _context16.prev = 14;\n                _context16.t0 = _context16[\"catch\"](8);\n                throw new Error('Link consent message must be signed before adding data, to link address to store', _context16.t0);\n\n              case 17:\n                _context16.prev = 17;\n                _context16.next = 20;\n                return this._writeAddressLink(proof);\n\n              case 20:\n                _context16.next = 25;\n                break;\n\n              case 22:\n                _context16.prev = 22;\n                _context16.t1 = _context16[\"catch\"](17);\n                throw new Error('An error occured while publishing link:', _context16.t1);\n\n              case 25:\n                _context16.next = 37;\n                break;\n\n              case 27:\n                if (this.hasPublishedLink[proof.signature]) {\n                  _context16.next = 37;\n                  break;\n                }\n\n                // Don't want to publish on every call to _linkProfile\n                this.hasPublishedLink[proof.signature] = true;\n                _context16.prev = 29;\n                _context16.next = 32;\n                return utils.fetchJson(this._serverUrl + '/link', proof);\n\n              case 32:\n                _context16.next = 37;\n                break;\n\n              case 34:\n                _context16.prev = 34;\n                _context16.t2 = _context16[\"catch\"](29);\n                throw new Error('An error occured while publishing link:', _context16.t2);\n\n              case 37:\n                _context16.next = 39;\n                return this[\"public\"].get('proof_did');\n\n              case 39:\n                proofdid = _context16.sent;\n\n                if (!proofdid) {\n                  _context16.next = 53;\n                  break;\n                }\n\n                // if prior muport, re publish with 3id including muport\n                issuer = didJWT.decodeJWT(proofdid).payload.iss;\n\n                if (!issuer.includes('muport')) {\n                  _context16.next = 51;\n                  break;\n                }\n\n                jwt = {\n                  muport: proofdid\n                };\n                _context16.t3 = this[\"public\"];\n                _context16.next = 47;\n                return this._3id.signJWT(jwt);\n\n              case 47:\n                _context16.t4 = _context16.sent;\n                _context16.t5 = {\n                  noLink: true\n                };\n                _context16.next = 51;\n                return _context16.t3.set.call(_context16.t3, 'proof_did', _context16.t4, _context16.t5);\n\n              case 51:\n                _context16.next = 60;\n                break;\n\n              case 53:\n                _context16.t6 = this[\"public\"];\n                _context16.next = 56;\n                return this._3id.signJWT();\n\n              case 56:\n                _context16.t7 = _context16.sent;\n                _context16.t8 = {\n                  noLink: true\n                };\n                _context16.next = 60;\n                return _context16.t6.set.call(_context16.t6, 'proof_did', _context16.t7, _context16.t8);\n\n              case 60:\n              case \"end\":\n                return _context16.stop();\n            }\n          }\n        }, _callee16, this, [[8, 14], [17, 22], [29, 34]]);\n      }));\n\n      function _linkProfile() {\n        return _linkProfile2.apply(this, arguments);\n      }\n\n      return _linkProfile;\n    }()\n  }, {\n    key: \"_writeRootstoreEntry\",\n    value: function () {\n      var _writeRootstoreEntry2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee18(type, payload) {\n        var _this5 = this;\n\n        var cid, entryExist, entry, prev;\n        return _regenerator[\"default\"].wrap(function _callee18$(_context18) {\n          while (1) {\n            switch (_context18.prev = _context18.next) {\n              case 0:\n                _context18.next = 2;\n                return this._ipfs.dag.put(payload);\n\n              case 2:\n                cid = _context18.sent.toBaseEncodedString();\n                _context18.next = 5;\n                return this._ipfs.pin.add(cid);\n\n              case 5:\n                _context18.next = 7;\n                return this._typeCIDExists(type, cid);\n\n              case 7:\n                entryExist = _context18.sent;\n\n                if (!entryExist) {\n                  _context18.next = 10;\n                  break;\n                }\n\n                return _context18.abrupt(\"return\");\n\n              case 10:\n                entry = {\n                  type: type,\n                  data: cid\n                }; // the below code prevents multiple simultaneous writes,\n                // which orbitdb doesn't support\n\n                prev = this._rootstoreQueue;\n                this._rootstoreQueue = (0, _asyncToGenerator2[\"default\"])(\n                /*#__PURE__*/\n                _regenerator[\"default\"].mark(function _callee17() {\n                  return _regenerator[\"default\"].wrap(function _callee17$(_context17) {\n                    while (1) {\n                      switch (_context17.prev = _context17.next) {\n                        case 0:\n                          if (!prev) {\n                            _context17.next = 3;\n                            break;\n                          }\n\n                          _context17.next = 3;\n                          return prev;\n\n                        case 3:\n                          _context17.next = 5;\n                          return _this5.replicator.rootstore.add(entry);\n\n                        case 5:\n                        case \"end\":\n                          return _context17.stop();\n                      }\n                    }\n                  }, _callee17);\n                }))();\n\n              case 13:\n              case \"end\":\n                return _context18.stop();\n            }\n          }\n        }, _callee18, this);\n      }));\n\n      function _writeRootstoreEntry(_x13, _x14) {\n        return _writeRootstoreEntry2.apply(this, arguments);\n      }\n\n      return _writeRootstoreEntry;\n    }()\n  }, {\n    key: \"_typeCIDExists\",\n    value: function () {\n      var _typeCIDExists2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee19(type, cid) {\n        var entries, typeEntries;\n        return _regenerator[\"default\"].wrap(function _callee19$(_context19) {\n          while (1) {\n            switch (_context19.prev = _context19.next) {\n              case 0:\n                _context19.next = 2;\n                return this.replicator.rootstore.iterator({\n                  limit: -1\n                }).collect();\n\n              case 2:\n                entries = _context19.sent;\n                typeEntries = entries.filter(function (e) {\n                  return e.payload.value.type === type;\n                });\n                return _context19.abrupt(\"return\", Boolean(typeEntries.find(function (entry) {\n                  return entry.data === cid;\n                })));\n\n              case 5:\n              case \"end\":\n                return _context19.stop();\n            }\n          }\n        }, _callee19, this);\n      }));\n\n      function _typeCIDExists(_x15, _x16) {\n        return _typeCIDExists2.apply(this, arguments);\n      }\n\n      return _typeCIDExists;\n    }()\n  }, {\n    key: \"_deleteAddressLink\",\n    value: function () {\n      var _deleteAddressLink2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee20(address) {\n        var link;\n        return _regenerator[\"default\"].wrap(function _callee20$(_context20) {\n          while (1) {\n            switch (_context20.prev = _context20.next) {\n              case 0:\n                address = address.toLowerCase();\n                _context20.next = 3;\n                return this._readAddressLink(address);\n\n              case 3:\n                link = _context20.sent;\n\n                if (link) {\n                  _context20.next = 6;\n                  break;\n                }\n\n                throw new Error('_deleteAddressLink: link for given address does not exist');\n\n              case 6:\n                return _context20.abrupt(\"return\", this.replicator.rootstore.remove(link.entry.hash));\n\n              case 7:\n              case \"end\":\n                return _context20.stop();\n            }\n          }\n        }, _callee20, this);\n      }));\n\n      function _deleteAddressLink(_x17) {\n        return _deleteAddressLink2.apply(this, arguments);\n      }\n\n      return _deleteAddressLink;\n    }()\n  }, {\n    key: \"_readAddressLinks\",\n    value: function () {\n      var _readAddressLinks2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee21() {\n        var links, allLinks;\n        return _regenerator[\"default\"].wrap(function _callee21$(_context21) {\n          while (1) {\n            switch (_context21.prev = _context21.next) {\n              case 0:\n                _context21.next = 2;\n                return this.replicator.getAddressLinks();\n\n              case 2:\n                links = _context21.sent;\n                _context21.next = 5;\n                return Promise.all(links.map(validateLink));\n\n              case 5:\n                allLinks = _context21.sent;\n                return _context21.abrupt(\"return\", allLinks.filter(Boolean));\n\n              case 7:\n              case \"end\":\n                return _context21.stop();\n            }\n          }\n        }, _callee21, this);\n      }));\n\n      function _readAddressLinks() {\n        return _readAddressLinks2.apply(this, arguments);\n      }\n\n      return _readAddressLinks;\n    }()\n  }, {\n    key: \"_readAddressLink\",\n    value: function () {\n      var _readAddressLink2 = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee22(address) {\n        var links;\n        return _regenerator[\"default\"].wrap(function _callee22$(_context22) {\n          while (1) {\n            switch (_context22.prev = _context22.next) {\n              case 0:\n                address = address.toLowerCase();\n                _context22.next = 3;\n                return this._readAddressLinks();\n\n              case 3:\n                links = _context22.sent;\n                return _context22.abrupt(\"return\", links.find(function (link) {\n                  return link.address.toLowerCase() === address;\n                }));\n\n              case 5:\n              case \"end\":\n                return _context22.stop();\n            }\n          }\n        }, _callee22, this);\n      }));\n\n      function _readAddressLink(_x18) {\n        return _readAddressLink2.apply(this, arguments);\n      }\n\n      return _readAddressLink;\n    }()\n  }, {\n    key: \"close\",\n    value: function () {\n      var _close = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee23() {\n        return _regenerator[\"default\"].wrap(function _callee23$(_context23) {\n          while (1) {\n            switch (_context23.prev = _context23.next) {\n              case 0:\n                if (this._3id) {\n                  _context23.next = 2;\n                  break;\n                }\n\n                throw new Error('close: auth required');\n\n              case 2:\n                _context23.next = 4;\n                return this.replicator.stop();\n\n              case 4:\n              case \"end\":\n                return _context23.stop();\n            }\n          }\n        }, _callee23, this);\n      }));\n\n      function close() {\n        return _close.apply(this, arguments);\n      }\n\n      return close;\n    }()\n    /**\n     * Closes the 3box instance and clears local cache. If you call this,\n     * users will need to sign a consent message to log in the next time\n     * you call openBox.\n     */\n\n  }, {\n    key: \"logout\",\n    value: function () {\n      var _logout = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee24() {\n        var address;\n        return _regenerator[\"default\"].wrap(function _callee24$(_context24) {\n          while (1) {\n            switch (_context24.prev = _context24.next) {\n              case 0:\n                if (this._3id) {\n                  _context24.next = 2;\n                  break;\n                }\n\n                throw new Error('logout: auth required');\n\n              case 2:\n                _context24.next = 4;\n                return this.close();\n\n              case 4:\n                this._3id.logout();\n\n                _context24.next = 7;\n                return this._3id.getAddress();\n\n              case 7:\n                address = _context24.sent;\n                localstorage.remove('linkConsent_' + address);\n\n              case 9:\n              case \"end\":\n                return _context24.stop();\n            }\n          }\n        }, _callee24, this);\n      }));\n\n      function logout() {\n        return _logout.apply(this, arguments);\n      }\n\n      return logout;\n    }()\n    /**\n     * Check if the given address is logged in\n     *\n     * @param     {String}    address                 An ethereum address\n     * @return    {Boolean}                           true if the user is logged in\n     */\n\n  }, {\n    key: \"DID\",\n    get: function get() {\n      if (!this._3id) throw new Error('DID: auth required');\n      return this._3id.DID;\n    }\n  }], [{\n    key: \"create\",\n    value: function () {\n      var _create = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee25(provider) {\n        var opts,\n            ipfs,\n            box,\n            _args25 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee25$(_context25) {\n          while (1) {\n            switch (_context25.prev = _context25.next) {\n              case 0:\n                opts = _args25.length > 1 && _args25[1] !== undefined ? _args25[1] : {};\n                _context25.next = 3;\n                return Box.getIPFS(opts);\n\n              case 3:\n                ipfs = _context25.sent;\n                box = new Box(provider, ipfs, opts);\n                _context25.next = 7;\n                return box._init(opts);\n\n              case 7:\n                return _context25.abrupt(\"return\", box);\n\n              case 8:\n              case \"end\":\n                return _context25.stop();\n            }\n          }\n        }, _callee25);\n      }));\n\n      function create(_x19) {\n        return _create.apply(this, arguments);\n      }\n\n      return create;\n    }()\n  }, {\n    key: \"openBox\",\n    value: function () {\n      var _openBox = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee26(address, provider) {\n        var opts,\n            box,\n            _args26 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee26$(_context26) {\n          while (1) {\n            switch (_context26.prev = _context26.next) {\n              case 0:\n                opts = _args26.length > 2 && _args26[2] !== undefined ? _args26[2] : {};\n                opts = Object.assign(opts, {\n                  address: address\n                });\n                _context26.next = 4;\n                return Box.create(provider, opts);\n\n              case 4:\n                box = _context26.sent;\n                _context26.next = 7;\n                return box.auth([], opts);\n\n              case 7:\n                return _context26.abrupt(\"return\", box);\n\n              case 8:\n              case \"end\":\n                return _context26.stop();\n            }\n          }\n        }, _callee26);\n      }));\n\n      function openBox(_x20, _x21) {\n        return _openBox.apply(this, arguments);\n      }\n\n      return openBox;\n    }()\n  }, {\n    key: \"isLoggedIn\",\n    value: function isLoggedIn(address) {\n      return ThreeId.isLoggedIn(address);\n    }\n    /**\n     * Instanciate ipfs used by 3Box without calling openBox.\n     *\n     * @return    {IPFS}                           the ipfs instance\n     */\n\n  }, {\n    key: \"getIPFS\",\n    value: function () {\n      var _getIPFS = (0, _asyncToGenerator2[\"default\"])(\n      /*#__PURE__*/\n      _regenerator[\"default\"].mark(function _callee27() {\n        var opts,\n            ipfs,\n            pinningNode,\n            _args27 = arguments;\n        return _regenerator[\"default\"].wrap(function _callee27$(_context27) {\n          while (1) {\n            switch (_context27.prev = _context27.next) {\n              case 0:\n                opts = _args27.length > 0 && _args27[0] !== undefined ? _args27[0] : {};\n\n                if (typeof window !== 'undefined') {\n                  globalIPFS = window.globalIPFS;\n                  globalIPFSPromise = window.globalIPFSPromise;\n                }\n\n                if (!globalIPFS && !globalIPFSPromise) {\n                  globalIPFSPromise = initIPFS(opts.ipfs, opts.iframeStore, opts.ipfsOptions);\n                }\n\n                if (typeof window !== 'undefined') window.globalIPFSPromise = globalIPFSPromise;\n\n                if (globalIPFS) {\n                  _context27.next = 8;\n                  break;\n                }\n\n                _context27.next = 7;\n                return globalIPFSPromise;\n\n              case 7:\n                globalIPFS = _context27.sent;\n\n              case 8:\n                if (typeof window !== 'undefined') window.globalIPFS = globalIPFS;\n                ipfs = globalIPFS;\n                pinningNode = opts.pinningNode || PINNING_NODE;\n                ipfs.swarm.connect(pinningNode, function () {});\n                return _context27.abrupt(\"return\", ipfs);\n\n              case 13:\n              case \"end\":\n                return _context27.stop();\n            }\n          }\n        }, _callee27);\n      }));\n\n      function getIPFS() {\n        return _getIPFS.apply(this, arguments);\n      }\n\n      return getIPFS;\n    }()\n  }]);\n  return Box;\n}(BoxApi);\n\nfunction initIPFSRepo() {\n  var repoOpts = {};\n  var ipfsRootPath; // if in browser, create unique root storage, and ipfs id on each instance\n\n  if (typeof window !== 'undefined' && window.indexedDB) {\n    var sessionID = utils.randInt(10000);\n    ipfsRootPath = 'ipfs/root/' + sessionID;\n    var levelInstance = new LevelStore(ipfsRootPath);\n    repoOpts = {\n      storageBackends: {\n        root: function root() {\n          return levelInstance;\n        }\n      }\n    };\n  }\n\n  var repo = new IPFSRepo('ipfs', repoOpts);\n  return {\n    repo: repo,\n    rootPath: ipfsRootPath\n  };\n}\n\nfunction initIPFS(_x22, _x23, _x24) {\n  return _initIPFS.apply(this, arguments);\n}\n\nfunction _initIPFS() {\n  _initIPFS = (0, _asyncToGenerator2[\"default\"])(\n  /*#__PURE__*/\n  _regenerator[\"default\"].mark(function _callee28(ipfs, iframeStore, ipfsOptions) {\n    var ipfsRepo;\n    return _regenerator[\"default\"].wrap(function _callee28$(_context28) {\n      while (1) {\n        switch (_context28.prev = _context28.next) {\n          case 0:\n            // if (!ipfs && !ipfsProxy) throw new Error('No IPFS object configured and no default available for environment')\n            if (!!ipfs && iframeStore) console.warn('Warning: iframeStore true, orbit db cache in iframe, but the given ipfs object is being used, and may not be running in same iframe.');\n\n            if (!ipfs) {\n              _context28.next = 5;\n              break;\n            }\n\n            return _context28.abrupt(\"return\", ipfs);\n\n          case 5:\n            // await iframeLoadedPromise\n            // return ipfsProxy\n            if (!ipfsOptions) {\n              ipfsRepo = initIPFSRepo();\n              ipfsOptions = Object.assign(IPFS_OPTIONS, {\n                repo: ipfsRepo.repo\n              });\n            }\n\n            _context28.next = 8;\n            return IPFS.create(ipfsOptions);\n\n          case 8:\n            ipfs = _context28.sent;\n\n            if (ipfsRepo && typeof window !== 'undefined' && window.indexedDB) {\n              // deletes once db is closed again\n              window.indexedDB.deleteDatabase(ipfsRepo.rootPath);\n            }\n\n            return _context28.abrupt(\"return\", ipfs);\n\n          case 11:\n          case \"end\":\n            return _context28.stop();\n        }\n      }\n    }, _callee28);\n  }));\n  return _initIPFS.apply(this, arguments);\n}\n\nBox.idUtils = idUtils;\nmodule.exports = Box;"]},"metadata":{},"sourceType":"script"}