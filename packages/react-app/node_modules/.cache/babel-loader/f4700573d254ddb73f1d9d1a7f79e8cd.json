{"ast":null,"code":"'use strict';\n\nconst PeerInfo = require('peer-info');\n\nconst PeerId = require('peer-id');\n\nconst multiaddr = require('multiaddr');\n\nconst pull = require('pull-stream/pull');\n\nconst take = require('pull-stream/throughs/take');\n\nconst collect = require('pull-stream/sinks/collect');\n\nconst lp = require('pull-length-prefixed');\n\nconst msg = require('./message');\n\nmodule.exports = (conn, expectedPeerInfo, callback) => {\n  if (typeof expectedPeerInfo === 'function') {\n    callback = expectedPeerInfo;\n    expectedPeerInfo = null; // eslint-disable-next-line no-console\n\n    console.warn('WARNING: no expected peer info was given, identify will not be able to verify peer integrity');\n  }\n\n  pull(conn, lp.decode(), take(1), collect((err, data) => {\n    if (err) {\n      return callback(err);\n    } // connection got closed graciously\n\n\n    if (data.length === 0) {\n      return callback(new Error('conn was closed, did not receive data'));\n    }\n\n    const input = msg.decode(data[0]);\n    PeerId.createFromPubKey(input.publicKey, (err, id) => {\n      if (err) {\n        return callback(err);\n      }\n\n      const peerInfo = new PeerInfo(id);\n\n      if (expectedPeerInfo && expectedPeerInfo.id.toB58String() !== id.toB58String()) {\n        return callback(new Error('invalid peer'));\n      }\n\n      try {\n        input.listenAddrs.map(multiaddr).forEach(ma => peerInfo.multiaddrs.add(ma));\n      } catch (err) {\n        return callback(err);\n      }\n\n      let observedAddr;\n\n      try {\n        observedAddr = getObservedAddrs(input);\n      } catch (err) {\n        return callback(err);\n      } // Copy the protocols\n\n\n      peerInfo.protocols = new Set(input.protocols);\n      callback(null, peerInfo, observedAddr);\n    });\n  }));\n};\n\nfunction getObservedAddrs(input) {\n  if (!hasObservedAddr(input)) {\n    return [];\n  }\n\n  let addrs = input.observedAddr;\n\n  if (!Array.isArray(addrs)) {\n    addrs = [addrs];\n  }\n\n  return addrs.map(oa => multiaddr(oa));\n}\n\nfunction hasObservedAddr(input) {\n  return input.observedAddr && input.observedAddr.length > 0;\n}","map":{"version":3,"sources":["/home/dekan/Projects/raid-guild/dao-badges-web/node_modules/libp2p/src/identify/dialer.js"],"names":["PeerInfo","require","PeerId","multiaddr","pull","take","collect","lp","msg","module","exports","conn","expectedPeerInfo","callback","console","warn","decode","err","data","length","Error","input","createFromPubKey","publicKey","id","peerInfo","toB58String","listenAddrs","map","forEach","ma","multiaddrs","add","observedAddr","getObservedAddrs","protocols","Set","hasObservedAddr","addrs","Array","isArray","oa"],"mappings":"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","sourcesContent":["'use strict'\nconst PeerInfo = require('peer-info')\nconst PeerId = require('peer-id')\nconst multiaddr = require('multiaddr')\nconst pull = require('pull-stream/pull')\nconst take = require('pull-stream/throughs/take')\nconst collect = require('pull-stream/sinks/collect')\nconst lp = require('pull-length-prefixed')\n\nconst msg = require('./message')\n\nmodule.exports = (conn, expectedPeerInfo, callback) => {\n  if (typeof expectedPeerInfo === 'function') {\n    callback = expectedPeerInfo\n    expectedPeerInfo = null\n    // eslint-disable-next-line no-console\n    console.warn('WARNING: no expected peer info was given, identify will not be able to verify peer integrity')\n  }\n\n  pull(\n    conn,\n    lp.decode(),\n    take(1),\n    collect((err, data) => {\n      if (err) {\n        return callback(err)\n      }\n\n      // connection got closed graciously\n      if (data.length === 0) {\n        return callback(new Error('conn was closed, did not receive data'))\n      }\n\n      const input = msg.decode(data[0])\n\n      PeerId.createFromPubKey(input.publicKey, (err, id) => {\n        if (err) {\n          return callback(err)\n        }\n\n        const peerInfo = new PeerInfo(id)\n        if (expectedPeerInfo && expectedPeerInfo.id.toB58String() !== id.toB58String()) {\n          return callback(new Error('invalid peer'))\n        }\n\n        try {\n          input.listenAddrs\n            .map(multiaddr)\n            .forEach((ma) => peerInfo.multiaddrs.add(ma))\n        } catch (err) {\n          return callback(err)\n        }\n\n        let observedAddr\n\n        try {\n          observedAddr = getObservedAddrs(input)\n        } catch (err) {\n          return callback(err)\n        }\n\n        // Copy the protocols\n        peerInfo.protocols = new Set(input.protocols)\n\n        callback(null, peerInfo, observedAddr)\n      })\n    })\n  )\n}\n\nfunction getObservedAddrs (input) {\n  if (!hasObservedAddr(input)) {\n    return []\n  }\n\n  let addrs = input.observedAddr\n\n  if (!Array.isArray(addrs)) {\n    addrs = [addrs]\n  }\n\n  return addrs.map((oa) => multiaddr(oa))\n}\n\nfunction hasObservedAddr (input) {\n  return input.observedAddr && input.observedAddr.length > 0\n}\n"]},"metadata":{},"sourceType":"script"}